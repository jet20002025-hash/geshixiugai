# è¯šä¿¡æ‰¿è¯ºå’Œæ‘˜è¦åˆ†é¡µæ£€æµ‹é€»è¾‘è¯´æ˜

## ğŸ“‹ å½“å‰æ£€æµ‹é€»è¾‘

### 1. è¯†åˆ«è¯šä¿¡æ‰¿è¯ºå’Œæ‘˜è¦çš„ä½ç½®

**å‡½æ•°ï¼š** `_find_section_ranges()`

**æ£€æµ‹æ­¥éª¤ï¼š**

1. **æŸ¥æ‰¾è¯šä¿¡æ‰¿è¯º**ï¼š
   - ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼ï¼š`è¯š\s*ä¿¡\s*æ‰¿\s*è¯º`ï¼ˆæ”¯æŒä¸­é—´æœ‰ç©ºæ ¼ï¼‰
   - ä¹Ÿæ£€æŸ¥å…³é”®è¯ï¼š`å­¦æœ¯è¯šä¿¡`ã€`åŸåˆ›æ€§å£°æ˜`ã€`åŸåˆ›å£°æ˜`
   - è®°å½•è¯šä¿¡æ‰¿è¯ºçš„èµ·å§‹æ®µè½ç´¢å¼•

2. **æŸ¥æ‰¾æ‘˜è¦**ï¼š
   - ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼ï¼š`^æ‘˜\s*è¦`ï¼ˆæ”¯æŒä¸­é—´æœ‰ç©ºæ ¼ï¼‰
   - ä¹Ÿæ£€æŸ¥ `ABSTRACT`
   - è®°å½•æ‘˜è¦çš„èµ·å§‹æ®µè½ç´¢å¼•

3. **æ£€æŸ¥åˆ†é¡µç¬¦**ï¼š
   - æ£€æŸ¥æ‘˜è¦æ ‡é¢˜å‰ä¸€ä¸ªæ®µè½æ˜¯å¦æœ‰åˆ†é¡µç¬¦
   - æ£€æŸ¥æ‘˜è¦æ ‡é¢˜æœ¬èº«æ˜¯å¦æœ‰åˆ†é¡µç¬¦
   - æ£€æŸ¥æ‘˜è¦æ ‡é¢˜çš„runsä¸­æ˜¯å¦æœ‰åˆ†é¡µç¬¦

**åˆ†é¡µç¬¦æ£€æµ‹æ–¹å¼ï¼š**
- `paragraph.paragraph_format.page_break_before` - æ®µè½æ ¼å¼ä¸­çš„åˆ†é¡µç¬¦
- `run.element.xml` ä¸­åŒ…å« `w:br` ä¸” `type="page"` - runsä¸­çš„åˆ†é¡µç¬¦

---

### 2. è¯Šæ–­é€»è¾‘

**å‡½æ•°ï¼š** `_diagnose_integrity_abstract_separation()`

**è¯Šæ–­æ­¥éª¤ï¼š**

1. æŸ¥æ‰¾è¯šä¿¡æ‰¿è¯ºå’Œæ‘˜è¦çš„ä½ç½®
2. æ£€æŸ¥å®ƒä»¬ä¹‹é—´çš„æ‰€æœ‰æ®µè½
3. æ£€æŸ¥æ˜¯å¦æœ‰åˆ†é¡µç¬¦ï¼ˆåŒ…æ‹¬æ®µè½æ ¼å¼å’Œrunsä¸­çš„ï¼‰
4. è¿”å›è¯Šæ–­ç»“æœï¼š
   - `has_page_break_between`: æ˜¯å¦æœ‰åˆ†é¡µç¬¦
   - `page_break_locations`: åˆ†é¡µç¬¦ä½ç½®åˆ—è¡¨
   - `issue`: é—®é¢˜æè¿°ï¼ˆå¦‚æœæ²¡æœ‰åˆ†é¡µç¬¦ï¼‰

---

### 3. ç©ºç™½è¡Œåˆ é™¤ä¿æŠ¤é€»è¾‘

**å‡½æ•°ï¼š** `_check_excessive_blanks()` å’Œ `_check_and_remove_blank_pages()`

**ä¿æŠ¤æœºåˆ¶ï¼š**

1. è·å–è¯šä¿¡æ‰¿è¯ºå’Œæ‘˜è¦çš„èŒƒå›´
2. åœ¨åˆ é™¤ç©ºç™½è¡Œæ—¶ï¼Œæ£€æŸ¥æ˜¯å¦åœ¨è¯šä¿¡æ‰¿è¯ºå’Œæ‘˜è¦ä¹‹é—´
3. å¦‚æœåœ¨ä¹‹é—´ï¼Œè·³è¿‡åˆ é™¤ï¼Œä¸åˆ é™¤ä»»ä½•å†…å®¹

**ä»£ç ä½ç½®ï¼š**
```python
# æ£€æŸ¥æ˜¯å¦åœ¨è¯šä¿¡æ‰¿è¯ºå’Œæ‘˜è¦ä¹‹é—´
is_between_integrity_and_abstract = False
if integrity_end is not None and abstract_zh_start is not None:
    if integrity_end <= idx < abstract_zh_start:
        is_between_integrity_and_abstract = True

if is_between_integrity_and_abstract:
    # åœ¨è¯šä¿¡æ‰¿è¯ºå’Œæ‘˜è¦ä¹‹é—´ï¼Œä¸åˆ é™¤ä»»ä½•å†…å®¹
    continue
```

---

## âš ï¸ å½“å‰é—®é¢˜

### é—®é¢˜1ï¼šåªæ£€æµ‹ï¼Œä¸ä¿®å¤

å½“å‰ä»£ç åªæ£€æµ‹æ˜¯å¦æœ‰åˆ†é¡µç¬¦ï¼Œå¦‚æœ**åŸå§‹æ–‡æ¡£æ²¡æœ‰åˆ†é¡µç¬¦**ï¼Œä»£ç ä¸ä¼šè‡ªåŠ¨æ·»åŠ ã€‚

### é—®é¢˜2ï¼šWordè½¬PDFå¯èƒ½ä¸¢å¤±åˆ†é¡µç¬¦

å³ä½¿Wordæ–‡æ¡£ä¸­æœ‰åˆ†é¡µç¬¦ï¼ŒLibreOfficeè½¬æ¢æ—¶å¯èƒ½å› ä¸ºæ ¼å¼é—®é¢˜å¯¼è‡´åˆ†é¡µç¬¦å¤±æ•ˆã€‚

---

## âœ… è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ1ï¼šè‡ªåŠ¨æ·»åŠ åˆ†é¡µç¬¦ï¼ˆæ¨èï¼‰

åœ¨æ£€æµ‹åˆ°è¯šä¿¡æ‰¿è¯ºå’Œæ‘˜è¦ä¹‹é—´æ²¡æœ‰åˆ†é¡µç¬¦æ—¶ï¼Œè‡ªåŠ¨åœ¨æ‘˜è¦æ ‡é¢˜å‰æ·»åŠ åˆ†é¡µç¬¦ã€‚

**å®ç°æ–¹å¼ï¼š**
1. åœ¨æ ¼å¼ä¿®æ”¹å®Œæˆåï¼Œæ£€æŸ¥è¯šä¿¡æ‰¿è¯ºå’Œæ‘˜è¦ä¹‹é—´æ˜¯å¦æœ‰åˆ†é¡µç¬¦
2. å¦‚æœæ²¡æœ‰ï¼Œåœ¨æ‘˜è¦æ ‡é¢˜å‰æ·»åŠ åˆ†é¡µç¬¦
3. ç¡®ä¿åˆ†é¡µç¬¦ä¸ä¼šè¢«åç»­å¤„ç†åˆ é™¤

### æ–¹æ¡ˆ2ï¼šå¼ºåˆ¶åˆ†é¡µç¬¦

æ— è®ºåŸå§‹æ–‡æ¡£æ˜¯å¦æœ‰åˆ†é¡µç¬¦ï¼Œéƒ½åœ¨æ‘˜è¦æ ‡é¢˜å‰å¼ºåˆ¶æ·»åŠ åˆ†é¡µç¬¦ã€‚

**ä¼˜ç‚¹ï¼š** ç¡®ä¿å§‹ç»ˆåˆ†å¼€
**ç¼ºç‚¹ï¼š** å¦‚æœåŸå§‹æ–‡æ¡£å·²ç»æœ‰åˆ†é¡µç¬¦ï¼Œå¯èƒ½ä¼šäº§ç”Ÿå¤šä½™çš„åˆ†é¡µ

---

## ğŸ”§ å®ç°æ­¥éª¤

1. **åˆ›å»ºä¿®å¤å‡½æ•°**ï¼š`_ensure_integrity_abstract_separation()`
   - æ£€æµ‹è¯šä¿¡æ‰¿è¯ºå’Œæ‘˜è¦ä¹‹é—´æ˜¯å¦æœ‰åˆ†é¡µç¬¦
   - å¦‚æœæ²¡æœ‰ï¼Œåœ¨æ‘˜è¦æ ‡é¢˜å‰æ·»åŠ åˆ†é¡µç¬¦

2. **åœ¨æ–‡æ¡£å¤„ç†æµç¨‹ä¸­è°ƒç”¨**ï¼š
   - åœ¨æ ¼å¼ä¿®æ”¹å®Œæˆåè°ƒç”¨
   - åœ¨ç©ºç™½è¡Œåˆ é™¤ä¹‹å‰è°ƒç”¨ï¼ˆç¡®ä¿åˆ†é¡µç¬¦ä¸ä¼šè¢«åˆ é™¤ï¼‰

3. **ç¡®ä¿åˆ†é¡µç¬¦ä¸è¢«åˆ é™¤**ï¼š
   - åœ¨ç©ºç™½è¡Œåˆ é™¤é€»è¾‘ä¸­ï¼Œç¡®ä¿åŒ…å«åˆ†é¡µç¬¦çš„æ®µè½ä¸è¢«åˆ é™¤

---

## ğŸ“ ä»£ç å®ç°

```python
def _ensure_integrity_abstract_separation(self, document: Document) -> bool:
    """
    ç¡®ä¿è¯šä¿¡æ‰¿è¯ºå’Œæ‘˜è¦åˆ†å¼€åœ¨ä¸åŒé¡µ
    
    å¦‚æœå®ƒä»¬ä¹‹é—´æ²¡æœ‰åˆ†é¡µç¬¦ï¼Œåœ¨æ‘˜è¦æ ‡é¢˜å‰æ·»åŠ åˆ†é¡µç¬¦
    
    Returns:
        bool: æ˜¯å¦è¿›è¡Œäº†ä¿®å¤
    """
    # 1. æŸ¥æ‰¾è¯šä¿¡æ‰¿è¯ºå’Œæ‘˜è¦çš„ä½ç½®
    section_ranges = self._find_section_ranges(document)
    
    if "integrity" not in section_ranges or "abstract_zh" not in section_ranges:
        return False
    
    integrity_start, integrity_end = section_ranges["integrity"]
    abstract_zh_start, _ = section_ranges["abstract_zh"]
    
    # 2. æ£€æŸ¥æ‘˜è¦æ ‡é¢˜å‰æ˜¯å¦æœ‰åˆ†é¡µç¬¦
    abstract_para = document.paragraphs[abstract_zh_start]
    
    # æ£€æŸ¥æ‘˜è¦æ ‡é¢˜æœ¬èº«æ˜¯å¦æœ‰åˆ†é¡µç¬¦
    if abstract_para.paragraph_format.page_break_before:
        return False  # å·²ç»æœ‰åˆ†é¡µç¬¦
    
    # æ£€æŸ¥æ‘˜è¦æ ‡é¢˜çš„runsä¸­æ˜¯å¦æœ‰åˆ†é¡µç¬¦
    for run in abstract_para.runs:
        if hasattr(run, 'element'):
            run_xml = str(run.element.xml)
            if 'w:br' in run_xml and 'type="page"' in run_xml:
                return False  # å·²ç»æœ‰åˆ†é¡µç¬¦
    
    # æ£€æŸ¥å‰ä¸€ä¸ªæ®µè½æ˜¯å¦æœ‰åˆ†é¡µç¬¦
    if abstract_zh_start > 0:
        prev_para = document.paragraphs[abstract_zh_start - 1]
        if prev_para.paragraph_format.page_break_before:
            return False  # å·²ç»æœ‰åˆ†é¡µç¬¦
        
        for run in prev_para.runs:
            if hasattr(run, 'element'):
                run_xml = str(run.element.xml)
                if 'w:br' in run_xml and 'type="page"' in run_xml:
                    return False  # å·²ç»æœ‰åˆ†é¡µç¬¦
    
    # 3. æ²¡æœ‰åˆ†é¡µç¬¦ï¼Œæ·»åŠ åˆ†é¡µç¬¦
    print(f"[ä¿®å¤] è¯šä¿¡æ‰¿è¯ºå’Œæ‘˜è¦ä¹‹é—´æ²¡æœ‰åˆ†é¡µç¬¦ï¼Œåœ¨æ‘˜è¦æ ‡é¢˜å‰æ·»åŠ åˆ†é¡µç¬¦")
    abstract_para.paragraph_format.page_break_before = True
    return True
```

---

## ğŸ¯ è°ƒç”¨ä½ç½®

åœ¨ `process_document()` å‡½æ•°ä¸­ï¼Œåœ¨æ ¼å¼ä¿®æ”¹å®Œæˆåã€ç©ºç™½è¡Œåˆ é™¤ä¹‹å‰è°ƒç”¨ï¼š

```python
# åº”ç”¨æ ¼å¼è§„åˆ™
final_doc, stats = self._apply_rules(...)

# ç¡®ä¿è¯šä¿¡æ‰¿è¯ºå’Œæ‘˜è¦åˆ†å¼€
self._ensure_integrity_abstract_separation(final_doc)

# æ£€æµ‹å¤§æ®µç©ºç™½ï¼ˆä¼šä¿æŠ¤è¯šä¿¡æ‰¿è¯ºå’Œæ‘˜è¦ä¹‹é—´çš„å†…å®¹ï¼‰
blank_issues = self._check_excessive_blanks(final_doc)
```

---

## ğŸ“Š æ£€æµ‹æµç¨‹å›¾

```
å¼€å§‹
  â†“
æŸ¥æ‰¾è¯šä¿¡æ‰¿è¯ºä½ç½®
  â†“
æŸ¥æ‰¾æ‘˜è¦ä½ç½®
  â†“
æ£€æŸ¥å®ƒä»¬ä¹‹é—´æ˜¯å¦æœ‰åˆ†é¡µç¬¦ï¼Ÿ
  â”œâ”€ æœ‰ â†’ å®Œæˆï¼Œä¸å¤„ç†
  â””â”€ æ²¡æœ‰ â†’ åœ¨æ‘˜è¦æ ‡é¢˜å‰æ·»åŠ åˆ†é¡µç¬¦
  â†“
å®Œæˆ
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **åˆ†é¡µç¬¦ä½ç½®**ï¼šåˆ†é¡µç¬¦åº”è¯¥æ·»åŠ åœ¨æ‘˜è¦æ ‡é¢˜æ®µè½ï¼Œè€Œä¸æ˜¯è¯šä¿¡æ‰¿è¯ºçš„æœ€åä¸€ä¸ªæ®µè½
2. **ä¿æŠ¤æœºåˆ¶**ï¼šç¡®ä¿ç©ºç™½è¡Œåˆ é™¤é€»è¾‘ä¸ä¼šåˆ é™¤åŒ…å«åˆ†é¡µç¬¦çš„æ®µè½
3. **Wordè½¬PDF**ï¼šå³ä½¿æ·»åŠ äº†åˆ†é¡µç¬¦ï¼ŒLibreOfficeè½¬æ¢æ—¶ä»å¯èƒ½æœ‰é—®é¢˜ï¼Œéœ€è¦æµ‹è¯•éªŒè¯

