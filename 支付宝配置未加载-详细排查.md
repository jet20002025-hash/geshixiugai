# 支付宝配置未加载 - 详细排查

## 🔍 问题

调试端点显示支付宝配置都是 `false`，说明环境变量没有被正确加载。

---

## 🚀 排查步骤

### 步骤 1：检查配置项是否存在

```bash
# 检查 ALIPAY 配置项（隐藏值）
sudo grep "^ALIPAY" /var/www/geshixiugai/.env | sed 's/=.*/=***/'
```

应该看到：
```
ALIPAY_APP_ID=***
ALIPAY_PRIVATE_KEY=***
ALIPAY_PUBLIC_KEY=***
ALIPAY_SIGN_TYPE=***
ALIPAY_GATEWAY=***
```

### 步骤 2：检查配置格式

```bash
# 查看配置项（注意：会显示部分敏感信息）
sudo grep "^ALIPAY" /var/www/geshixiugai/.env
```

检查：
- ✅ 配置项名称是否正确（`ALIPAY_APP_ID` 不是 `ALIPAY_APPID`）
- ✅ 等号前后没有多余空格
- ✅ 值没有用引号包裹（除非值本身包含空格）
- ✅ 每行一个配置项

### 步骤 3：检查是否有语法错误

```bash
# 检查 .env 文件是否有语法错误
sudo cat /var/www/geshixiugai/.env | grep -n "^ALIPAY"
```

### 步骤 4：检查 Python 代码是否正确加载 .env 文件

```bash
# 检查 main.py 中是否加载了 .env
grep -n "load_dotenv\|\.env" /var/www/geshixiugai/backend/app/main.py
```

---

## 🔧 常见问题及修复

### 问题 1：配置项名称错误

❌ 错误：
```bash
ALIPAY_APPID=xxx  # 错误：应该是 ALIPAY_APP_ID
```

✅ 正确：
```bash
ALIPAY_APP_ID=xxx
```

### 问题 2：等号前后有空格

❌ 错误：
```bash
ALIPAY_APP_ID = xxx  # 错误：等号前后有空格
```

✅ 正确：
```bash
ALIPAY_APP_ID=xxx
```

### 问题 3：值用引号包裹

❌ 错误（除非值包含空格）：
```bash
ALIPAY_APP_ID="xxx"  # 通常不需要引号
```

✅ 正确：
```bash
ALIPAY_APP_ID=xxx
```

### 问题 4：多行私钥/公钥格式问题

如果私钥或公钥是多行的，需要确保格式正确：

✅ 正确格式（多行）：
```bash
ALIPAY_PRIVATE_KEY=-----BEGIN RSA PRIVATE KEY-----
MIIEpAIBAAKCAQEA...
（多行内容）
-----END RSA PRIVATE KEY-----
```

或者使用单行格式（如果支持）：
```bash
ALIPAY_PRIVATE_KEY="-----BEGIN RSA PRIVATE KEY-----\nMIIEpAIBAAKCAQEA...\n-----END RSA PRIVATE KEY-----"
```

---

## 📋 完整排查命令

```bash
# 1. 检查配置项是否存在
sudo grep "^ALIPAY" /var/www/geshixiugai/.env | sed 's/=.*/=***/'

# 2. 检查配置格式（注意：会显示部分敏感信息）
sudo grep "^ALIPAY" /var/www/geshixiugai/.env

# 3. 检查 Python 代码是否正确加载 .env
grep -n "load_dotenv\|\.env" /var/www/geshixiugai/backend/app/main.py

# 4. 重启服务
sudo systemctl restart geshixiugai

# 5. 查看日志
sudo tail -n 100 /var/log/geshixiugai/error.log
```

---

## ✅ 修复步骤

如果发现配置有问题：

1. **编辑 .env 文件**：
```bash
sudo vi /var/www/geshixiugai/.env
```

2. **确保配置格式正确**：
```bash
# 支付宝支付配置
ALIPAY_APP_ID=你的支付宝AppID
ALIPAY_PRIVATE_KEY=你的应用私钥（完整内容）
ALIPAY_PUBLIC_KEY=支付宝公钥（完整内容）
ALIPAY_SIGN_TYPE=RSA2
ALIPAY_GATEWAY=https://openapi.alipay.com/gateway.do
BASE_URL=https://geshixiugai.cn
```

3. **保存退出**：按 `Esc`，输入 `:wq`，按回车

4. **重启服务**：
```bash
sudo systemctl restart geshixiugai
```

---

**先执行排查命令，检查配置格式！** 🔍










