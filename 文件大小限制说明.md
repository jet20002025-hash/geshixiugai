# 文件大小限制说明

## 🔍 问题

**错误信息**：`Request Entity Too Large FUNCTION_PAYLOAD_TOO_LARGE`

这是 Vercel Serverless Functions 的请求体大小限制导致的错误。

---

## 📊 Vercel 限制

### 请求体大小限制

- **Hobby 计划**：4.5 MB
- **Pro 计划**：4.5 MB
- **Enterprise 计划**：更大（根据合同）

### 我们的设置

为了安全，我们设置了 **4 MB** 的限制，确保不会超过 Vercel 的限制。

---

## ✅ 解决方案

### 方案 1：压缩文档中的图片（推荐）

Word 文档中的图片通常是文件过大的主要原因。

#### 在 Word 中压缩图片：

1. **打开 Word 文档**
2. **选择图片** → 右键 → **"图片格式"** 或 **"设置图片格式"**
3. **点击 "压缩图片"** 或 **"图片压缩"**
4. **选择压缩选项**：
   - ✅ **"删除图片的剪裁区域"**（可选）
   - ✅ **"仅压缩此图片"** 或 **"压缩文档中的所有图片"**
   - ✅ **选择分辨率**：
     - **"Web 质量"**（150 ppi）- 适合在线查看
     - **"打印质量"**（220 ppi）- 适合打印
     - **"高保真"**（300 ppi）- 最高质量
5. **点击 "确定"**

#### 或者使用在线工具：

- **TinyPNG**：https://tinypng.com/（压缩 PNG/JPG）
- **Squoosh**：https://squoosh.app/（Google 的图片压缩工具）

---

### 方案 2：删除不必要的图片

如果文档中有不必要的图片（如装饰性图片、重复的图片），可以删除它们。

---

### 方案 3：拆分文档

如果文档确实很大且无法压缩，可以考虑：

1. **拆分文档**：将大文档拆分为多个小文档
2. **分别处理**：每个文档单独上传处理
3. **合并结果**：处理完成后手动合并

---

## 🔧 技术实现

### Vercel 配置

在 `vercel.json` 中配置请求体大小限制：

```json
{
  "functions": {
    "api/index.py": {
      "maxDuration": 30,
      "maxRequestSize": "20mb"
    }
  }
}
```

### 后端检查

在 `backend/app/api/documents.py` 和 `backend/app/api/templates.py` 中：

```python
# 文件大小限制：20 MB（支持毕业论文等大文件）
MAX_FILE_SIZE = 20 * 1024 * 1024  # 20 MB

# 检查文件大小
if file.size and file.size > MAX_FILE_SIZE:
    file_size_mb = file.size / (1024 * 1024)
    max_size_mb = MAX_FILE_SIZE / (1024 * 1024)
    raise HTTPException(
        status_code=status.HTTP_413_REQUEST_ENTITY_TOO_LARGE,
        detail=f"文件太大（{file_size_mb:.2f} MB），最大支持 {max_size_mb} MB。请压缩文档中的图片或删除不必要的图片后再上传。"
    )
```

### 前端检查

在前端上传前也会检查文件大小，提前提示用户：

```javascript
// 文件大小限制：20 MB（支持毕业论文等大文件）
const MAX_FILE_SIZE = 20 * 1024 * 1024; // 20 MB

// 检查文件大小
if (file.size > MAX_FILE_SIZE) {
  const fileSizeMB = (file.size / (1024 * 1024)).toFixed(2);
  showMessage(documentStatus, `文件太大（${fileSizeMB} MB），最大支持 20 MB。请压缩文档中的图片或删除不必要的图片后再上传。`, true);
  return;
}
```

---

## 📋 检查清单

上传文件前，请确认：

- [ ] **文件大小 ≤ 20 MB**
- [ ] **已压缩文档中的图片**（如果文件仍然很大）
- [ ] **已删除不必要的图片**
- [ ] **文档格式为 .docx**

---

## 🆘 如果仍然无法解决

### 检查文件大小

1. **右键点击文件** → **"属性"** 或 **"显示简介"**
2. **查看文件大小**
3. **如果超过 20 MB**，按照上述方法压缩

### 常见问题

**Q: 为什么限制是 20 MB？**

**A**: 为了支持毕业论文等大文件。毕业论文通常包含大量图片和内容，可能达到 10-20 MB。

**Q: 如果使用 Vercel，可以支持 20 MB 吗？**

**A**: 
- **Hobby 计划**：最大只能支持 4.5 MB（平台限制）
- **Pro 计划**：可以通过 `vercel.json` 配置 `maxRequestSize: "20mb"` 来支持 20 MB
- **Enterprise 计划**：可以配置更大的限制（根据合同）

**Q: 如果超过 20 MB 怎么办？**

**A**: 
- 压缩文档中的图片（最有效的方法）
- 删除不必要的图片
- 考虑拆分文档分别处理
- 或升级到支持更大文件的部署方案

**Q: 压缩图片会影响质量吗？**

**A**: 轻微压缩通常不会明显影响质量。Word 文档中的图片通常分辨率过高（300+ ppi），压缩到 150-220 ppi 对于屏幕显示和普通打印已经足够。

---

## 💡 最佳实践

1. **上传前检查**：在上传前检查文件大小
2. **压缩图片**：使用 Word 内置的图片压缩功能
3. **删除不必要内容**：删除装饰性图片、水印等
4. **使用合适的图片格式**：JPG 通常比 PNG 更小

---

## 📝 总结

- ✅ **限制**：20 MB（支持毕业论文等大文件）
- ✅ **检查**：前端和后端都会检查
- ✅ **提示**：会显示友好的错误信息
- ✅ **建议**：如果文件仍然很大，压缩图片是最有效的解决方案
- ⚠️ **注意**：如果使用 Vercel Hobby 计划，最大只能支持 4.5 MB

**如果遇到文件大小问题，请先压缩文档中的图片！**

