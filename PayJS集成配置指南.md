# PayJS 集成配置指南

## 一、注册 PayJS 账号

1. 访问 PayJS 官网：https://payjs.cn/
2. 点击"注册"创建账号
3. 完成身份认证（个人/企业）
4. 获取商户信息：
   - **商户号（mchid）**
   - **通信密钥（key）**

## 二、配置环境变量

在 Vercel Dashboard → 项目设置 → Environment Variables 中添加：

### 必需配置

```
PAYJS_MCHID=你的商户号
PAYJS_KEY=你的通信密钥
BASE_URL=https://geshixiugai.org
```

### 配置说明

- `PAYJS_MCHID`：PayJS 商户号，在 PayJS 后台获取
- `PAYJS_KEY`：PayJS 通信密钥，在 PayJS 后台获取
- `BASE_URL`：你的网站域名，用于生成支付回调地址

## 三、配置支付回调地址

1. 登录 PayJS 商户后台
2. 进入"系统设置" → "支付回调"
3. 设置回调地址：`https://geshixiugai.org/api/payments/payjs/notify`
4. 保存设置

**重要**：
- 回调地址必须是公网可访问的 HTTPS 地址
- 回调地址不能带参数
- 回调地址不能有 session 验证、CSRF 验证等

## 四、测试支付

### 4.1 使用 PayJS 测试环境

PayJS 提供测试环境，可以使用测试商户号进行测试：

1. 在 PayJS 后台获取测试商户号和密钥
2. 使用测试商户号配置环境变量
3. 进行支付测试

### 4.2 测试流程

1. 上传模板和文档
2. 选择"PayJS 支付（支付宝/微信）"
3. 点击"立即支付"
4. 跳转到 PayJS 收银台
5. 选择支付方式（支付宝/微信）完成支付
6. 支付成功后自动返回，可以下载文档

## 五、支付流程说明

### 5.1 用户支付流程

1. 用户选择"PayJS 支付"
2. 前端调用 `/payments/payjs/create` 创建支付订单
3. 后端返回支付 URL
4. 前端打开新窗口，跳转到 PayJS 收银台
5. 用户在 PayJS 收银台选择支付方式（支付宝/微信）
6. 完成支付
7. PayJS 回调 `/payments/payjs/notify`
8. 后端验证签名，标记订单为已支付
9. 前端轮询检查支付状态
10. 支付成功后显示下载按钮

### 5.2 支付回调处理

- PayJS 会在用户支付成功后，向回调地址发送 POST 请求
- 回调数据使用 `form-data` 格式
- 后端会验证签名，确保回调来自 PayJS
- 验证通过后，标记订单为已支付

## 六、费率说明

- **支付宝**：0.6% - 1%（根据交易类型）
- **微信支付**：0.6% - 1%（根据交易类型）
- **无年费**
- **结算周期**：T+1（次日到账）

## 七、常见问题

### 7.1 支付订单创建失败

**可能原因**：
- PayJS 配置不正确（商户号或密钥错误）
- 金额格式错误（必须是正数）
- 回调地址配置错误

**解决方法**：
- 检查环境变量是否正确配置
- 检查 PayJS 后台配置
- 查看服务器日志

### 7.2 支付回调失败

**可能原因**：
- 回调地址不可访问
- 签名验证失败
- 回调地址有验证机制（session、CSRF等）

**解决方法**：
- 确保回调地址是公网 HTTPS 地址
- 检查 PayJS 后台回调地址配置
- 确保回调接口没有验证机制

### 7.3 支付成功后订单未更新

**可能原因**：
- 回调处理失败
- 文档 ID 不匹配

**解决方法**：
- 查看服务器日志
- 检查回调接口是否正常
- 手动查询订单状态

## 八、安全注意事项

1. **保护密钥**：
   - 通信密钥必须保密，不要提交到代码仓库
   - 使用环境变量存储密钥

2. **验证签名**：
   - 所有回调必须验证签名
   - 防止伪造支付回调

3. **HTTPS**：
   - 生产环境必须使用 HTTPS
   - 回调地址必须是 HTTPS

4. **订单验证**：
   - 验证订单金额、订单ID等关键信息
   - 防止重复支付

## 九、监控和日志

### 9.1 支付日志

在 Vercel Dashboard → Functions → Logs 可以查看：
- 支付订单创建日志
- 支付回调日志
- 错误日志

### 9.2 PayJS 后台

在 PayJS 商户后台可以查看：
- 交易记录
- 订单状态
- 结算记录

## 十、上线检查清单

- [ ] PayJS 账号已注册并认证
- [ ] 环境变量已配置（PAYJS_MCHID、PAYJS_KEY、BASE_URL）
- [ ] 支付回调地址已配置
- [ ] 测试支付流程正常
- [ ] 支付回调正常
- [ ] 订单状态更新正常
- [ ] 下载功能正常

## 十一、技术支持

- PayJS 官方文档：https://payjs.cn/docs/
- PayJS 技术支持：在 PayJS 后台提交工单
- 问题反馈：522168878@qq.com

## 十二、代码文件说明

已实现的文件：
- `backend/app/services/payjs_service.py` - PayJS 服务类
- `backend/app/api/payments.py` - 支付 API 接口
- `frontend/index.html` - 前端支付逻辑
- `requirements.txt` - 添加了 httpx 依赖

## 十三、下一步

1. 注册 PayJS 账号
2. 配置环境变量
3. 配置支付回调地址
4. 测试支付流程
5. 上线使用

祝使用愉快！🎉



