# 论文格式修改逻辑说明

## 📋 整体流程

```
上传文档 → 加载文档 → 应用页面设置 → 识别文档结构 → 应用格式规则 → 检测问题 → 生成报告
```

---

## 1️⃣ 文档结构识别

### 1.1 封面页识别
- **位置**：文档开头
- **结束标志**：遇到"摘要"、"ABSTRACT"、"目录"、"Contents"、"第一章"、"第1章"、"Chapter 1"、"1 引言"、"1 绪论"、"1 概述"等关键词
- **处理方式**：**完全跳过，不做任何检查和修改**

### 1.2 中文摘要识别
- **开始标志**：段落文本以"摘要"开头
- **结束标志**：遇到"关键词"、"ABSTRACT"或"目录"
- **包含内容**：
  - 摘要标题（"摘要"）
  - 摘要正文内容
  - 关键词标签（"关键词"）
  - 关键词内容

### 1.3 英文摘要识别
- **开始标志**：段落文本以"ABSTRACT"开头
- **结束标志**：遇到"Keywords"、"目录"、"Contents"、"第一章"、"第1章"等
- **包含内容**：
  - ABSTRACT 标题
  - 英文摘要正文内容
  - Keywords 标签
  - Keywords 内容

### 1.4 目录页识别
- **开始标志**：段落文本以"目录"或"Contents"开头
- **结束标志**：遇到"第一章"、"第1章"、"Chapter 1"、"1 引言"、"1 绪论"等
- **包含内容**：
  - 目录标题
  - 目录条目（所有目录内容）

### 1.5 正文识别
- **开始标志**：从"绪论"或"概述"开始算正文
  - 支持的关键词：
    - "第一章"、"第1章"、"Chapter 1"
    - "1 引言"、"1 绪论"、"1 概述"
    - "绪论"（精确匹配或开头）
    - "概述"（精确匹配或开头）
- **结束标志**：遇到"参考文献"或文档结束
- **包含内容**：所有正文段落、标题、图表等

---

## 2️⃣ 格式规则应用

### 2.1 封面页
- **处理方式**：完全跳过，不应用任何格式规则

### 2.2 中文摘要部分

#### 摘要标题（"摘要"）
- **字体**：黑体
- **字号**：三号（16pt）
- **对齐**：居中
- **段前**：2行（24pt）
- **段后**：2行（24pt）

#### 摘要正文内容
- **字体**：宋体
- **字号**：小四（12pt）
- **行距**：20磅（固定值）
- **对齐**：左对齐
- **加粗**：否

#### 关键词标签（"关键词"）
- **字体**：黑体
- **字号**：小四（12pt）
- **加粗**：是

#### 关键词内容
- **字体**：宋体
- **字号**：小四（12pt）
- **行距**：20磅

### 2.3 英文摘要部分

#### ABSTRACT 标题
- **字体**：Times New Roman
- **字号**：三号（16pt）
- **对齐**：居中
- **加粗**：是
- **段前**：2行（24pt）
- **段后**：2行（24pt）

#### 英文摘要正文内容
- **字体**：Times New Roman
- **字号**：小四（12pt）
- **行距**：20磅（固定值）
- **对齐**：左对齐
- **加粗**：否

#### Keywords 标签
- **字体**：Times New Roman
- **字号**：小四（12pt）
- **加粗**：是

#### Keywords 内容
- **字体**：Times New Roman
- **字号**：小四（12pt）
- **行距**：20磅

### 2.4 目录部分

#### 目录标题（"目录"或"Contents"）
- **字体**：黑体
- **字号**：三号（16pt）
- **对齐**：居中
- **加粗**：是
- **段前**：2行（24pt）
- **段后**：2行（24pt）

#### 目录内容
- **字体**：宋体（中文）/ Times New Roman（英文）
- **字号**：小四（12pt）
- **行距**：20磅（固定值）
- **对齐**：左对齐

### 2.5 正文部分

#### 一级标题（"绪论"、"概述"、"第一章"等）
- **字体**：黑体
- **字号**：三号（16pt）
- **对齐**：居中
- **加粗**：是
- **行距**：单倍行距（不修改）
- **段前**：2行（24pt）
- **段后**：2行（24pt）

**识别规则**：
- 精确匹配："绪论"、"概述"
- 开头匹配："绪论"、"概述"、"第一章"、"第1章"、"Chapter 1"
- 段落较短（< 50字符）
- 避免误识别：正文中的"第二章的方案"等不会被识别为标题

#### 二级标题（"1.1"、"第X节"等）
- **字体**：黑体
- **字号**：四号（14pt）
- **对齐**：左对齐
- **加粗**：是
- **行距**：单倍行距（不修改）

#### 三级标题（"1.1.1"等）
- **字体**：黑体
- **字号**：小四（12pt）
- **对齐**：左对齐
- **加粗**：是
- **行距**：单倍行距（不修改）

#### 正文内容
- **字体**：宋体（中文）/ Times New Roman（英文）
- **字号**：小四（12pt）
- **行距**：20磅（固定值）
- **对齐**：左对齐
- **加粗**：否
- **首行缩进**：2字符（24pt）

**特殊处理**：
- **包含图片的段落**：不修改行距和首行缩进，保持原样（避免图片被压缩看不见）
- **包含公式的段落**：不修改行距和首行缩进，保持原样
- **标题段落**：不修改行距，保持标题的原始行距

#### 图题（"图X-X"）
- **字体**：宋体
- **字号**：五号（10.5pt）
- **对齐**：居中
- **加粗**：否

#### 表题（"表X-X"）
- **字体**：宋体
- **字号**：五号（10.5pt）
- **对齐**：居中
- **加粗**：否

#### 公式
- **字体**：宋体
- **字号**：五号（10.5pt）
- **对齐**：居中
- **加粗**：否

---

## 3️⃣ 问题检测

### 3.1 图片检测（`_check_figure_captions`）
- **检测范围**：只检测正文部分的图片
- **检测规则**：
  - 如果段落包含图片，检查下一段是否是图题（以"图"开头）
  - 如果图片后没有图题，标记为问题
- **处理方式**：在文档中标记问题，生成报告

### 3.2 参考文献引用检测（`_check_reference_citations`）
- **检测范围**：
  - 参考文献部分：从最后一个"参考文献"标题开始（从后往前查找）
  - 正文部分：从正文开始位置（"绪论"或"概述"）到参考文献之前
- **检测规则**：
  1. 提取参考文献编号（支持格式：`[1]`、`1.`、`(1)`、`1 作者名...`）
  2. 在正文中查找引用（支持格式：`[1]`、`(1)`、`（1）`、`[1,2,3]`、`(1,2,3)`、`[1-5]`、上标格式）
  3. 找出未被引用的参考文献
- **处理方式**：
  - 未引用的参考文献标记为红色
  - 在参考文献文本后添加提示："（该文献没有被正文引用）"

### 3.3 空白行检测（`_check_excessive_blanks`）
- **检测范围**：**只检测正文部分**（从"绪论"或"概述"开始）
- **检测规则**：
  - 两个章节之间允许有大段空白
  - 在同一章节内，不允许有大段空白（连续2个以上空白段落）
- **处理方式**：在文档中标记问题，生成报告

### 3.4 页眉检测（`_check_header`）
- **检测规则**：只检测页眉是否存在
- **处理方式**：
  - 如果存在页眉：不做任何修改
  - 如果不存在页眉：生成提示，建议添加页眉

---

## 4️⃣ 格式应用流程

### 4.1 主流程（`process_document`）

```
1. 加载文档
2. 应用页面设置（页边距、装订线等）
3. 识别文档结构（封面、摘要、目录、正文）
4. 合并模板规则和标准规则（标准优先）
5. 应用格式规则（_apply_rules）
6. 检测图片问题（_check_figure_captions）
7. 检测参考文献引用（_check_reference_citations）
8. 检测空白行（_check_excessive_blanks）
9. 检测页眉（_check_header）
10. 保存文档
11. 生成报告
```

### 4.2 格式规则应用（`_apply_rules`）

```
对每个段落：
1. 跳过封面部分（idx < cover_end_idx）
2. 判断段落属于哪个部分（摘要、英文摘要、目录、正文）
3. 根据部分应用相应格式：
   - 中文摘要：应用摘要格式规则
   - 英文摘要：应用英文摘要格式规则
   - 目录：应用目录格式规则
   - 正文：使用样式检测逻辑
4. 检测段落类型（标题、正文、图题、表题等）
5. 应用格式规则
6. 特殊处理：
   - 标题：移除行距设置
   - 包含图片/公式的段落：移除行距和首行缩进
7. 记录修改日志
```

### 4.3 样式检测（`_detect_paragraph_style`）

```
1. 检查样式映射规则（STYLE_MAPPING_RULES）
2. 检查段落样式名称（是否包含"标题"）
3. 检查段落内容特征：
   - 图题：以"图"开头
   - 表题：以"表"开头
   - "绪论"或"概述"：识别为一级标题
   - 章节标题：匹配"第X章"等模式
   - 二级标题：匹配"X.X"等模式
   - 三级标题：匹配"X.X.X"等模式
4. 默认返回正文样式
```

---

## 5️⃣ 格式标准配置

### 5.1 页面设置（`PAGE_SETTINGS`）
- **纸张大小**：A4
- **页边距**：
  - 上：3厘米
  - 下：2厘米
  - 左：3厘米
  - 右：2厘米
  - 装订线：1厘米
- **页眉距边界**：2厘米
- **页脚距边界**：1厘米

### 5.2 页眉设置（`HEADER_SETTINGS`）
- **文本**："杭州电子科技大学本科毕业论文"
- **字体**：宋体
- **字号**：五号（10.5pt）
- **对齐**：居中

### 5.3 字体标准（`FONT_STANDARDS`）
所有格式标准定义在 `thesis_format_standard.py` 中，包括：
- 标题格式（一级、二级、三级）
- 正文格式
- 摘要格式（中文、英文）
- 目录格式
- 图题、表题格式
- 参考文献格式
- 致谢格式

---

## 6️⃣ 关键逻辑说明

### 6.1 封面跳过逻辑
- 使用 `_find_cover_end_index` 找到封面结束位置
- 在 `_apply_rules` 中，所有 `idx < cover_end_idx` 的段落都被跳过

### 6.2 部分识别逻辑
- 使用 `_find_section_ranges` 识别各个部分的段落范围
- 返回字典：`{"cover": (0, end), "abstract_zh": (start, end), ...}`
- 在应用格式时，根据段落索引判断属于哪个部分

### 6.3 正文开始识别
- 正文从"绪论"或"概述"开始
- 支持多种格式："第一章"、"第1章"、"Chapter 1"、"1 引言"、"1 绪论"、"1 概述"、"绪论"、"概述"
- 空白行检测只从正文开始位置往后检测

### 6.4 标题识别防误判
- 检查段落长度（标题通常较短）
- 检查段落内容（避免将"第二章的方案"误识别为标题）
- 检查段落样式名称

### 6.5 图片/公式段落特殊处理
- 检测段落是否包含图片或公式
- 如果包含，移除行距和首行缩进设置
- 避免图片被压缩看不见

### 6.6 参考文献检测
- 从后往前查找最后一个"参考文献"标题
- 提取参考文献编号（支持多种格式）
- 在正文中查找引用（支持多种格式，包括上标）
- 标记未引用的参考文献为红色

---

## 7️⃣ 修改记录

系统会记录所有格式修改：
- 修改的段落索引
- 修改的字段（字体、字号、行距等）
- 修改前后的值
- 应用的规则名称

---

## 8️⃣ 输出结果

### 8.1 修改后的文档
- `final.docx`：最终修改后的文档
- `preview.docx`：带水印的预览版

### 8.2 修改报告
- 格式修改摘要（各字段修改数量）
- 图片检测结果
- 参考文献引用检测结果
- 空白行检测结果
- 页眉检测结果
- 详细修改日志（前50条）

---

## 📝 注意事项

1. **封面页**：完全不修改，跳过所有检查和格式应用
2. **标题行距**：标题的行距不修改，保持原样
3. **图片段落**：包含图片的段落不修改行距和首行缩进
4. **公式段落**：包含公式的段落不修改行距和首行缩进
5. **正文开始**：从"绪论"或"概述"开始算正文
6. **空白行检测**：只检测正文部分的空白行
7. **参考文献**：从最后一个"参考文献"标题开始识别
8. **标准优先**：标准格式规则优先于模板规则

---

## 🔄 工作流程图

```
上传文档
    ↓
加载文档
    ↓
应用页面设置（页边距、装订线）
    ↓
识别文档结构
    ├─ 封面（跳过）
    ├─ 中文摘要
    ├─ 英文摘要
    ├─ 目录
    └─ 正文（从"绪论"或"概述"开始）
    ↓
应用格式规则
    ├─ 根据部分应用相应格式
    ├─ 检测段落类型（标题/正文/图题等）
    └─ 应用格式规则
    ↓
检测问题
    ├─ 图片检测（正文部分）
    ├─ 参考文献引用检测
    ├─ 空白行检测（正文部分）
    └─ 页眉检测
    ↓
生成报告
    ↓
保存文档
```

---

## 📌 关键代码位置

- **主流程**：`DocumentService.process_document()`
- **格式应用**：`DocumentService._apply_rules()`
- **结构识别**：`DocumentService._find_section_ranges()`
- **样式检测**：`DocumentService._detect_paragraph_style()`
- **封面识别**：`DocumentService._find_cover_end_index()`
- **图片检测**：`DocumentService._check_figure_captions()`
- **参考文献检测**：`DocumentService._check_reference_citations()`
- **空白行检测**：`DocumentService._check_excessive_blanks()`
- **页眉检测**：`DocumentService._check_header()`
- **格式标准**：`thesis_format_standard.py`

