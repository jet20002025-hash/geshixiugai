# 支付宝 ISV 权限不足问题排查指南

## 错误信息

```
调试错误，请回到请求来源地，重新发起请求。

错误代码: insufficient-isv-permissions
错误原因: ISV权限不足
```

## 问题原因

`insufficient-isv-permissions` 错误表示**应用没有开通相应的产品权限**。常见原因包括：

1. **应用未签约产品**：应用创建后，需要签约相应的支付产品（如"手机网站支付"）
2. **应用审核未通过**：应用可能还在审核中或审核未通过
3. **产品未上线**：签约的产品可能还未上线
4. **环境不匹配**：可能使用了沙箱环境但配置了正式环境，或相反

---

## 解决步骤

### 步骤 1：检查应用状态

1. **登录支付宝开放平台**
   - 访问：https://open.alipay.com/
   - 使用支付宝账号登录

2. **进入应用管理**
   - 在控制台首页，点击"**网页&移动应用**"
   - 找到你的应用，点击进入应用详情

3. **检查应用状态**
   - 查看应用状态是否为"**已上线**"或"**审核通过**"
   - 如果状态是"审核中"或"审核失败"，需要等待审核或重新提交

---

### 步骤 2：检查产品签约状态

1. **进入产品管理**
   - 在应用详情页面，找到"**产品列表**"或"**功能列表**"
   - 查看是否已签约"**手机网站支付**"产品

2. **如果未签约，需要签约产品**
   - 点击"**添加产品**"或"**签约产品**"
   - 选择"**手机网站支付**"（`alipay.trade.wap.pay`）
   - 填写相关信息并提交签约申请

3. **等待产品审核**
   - 产品签约通常需要审核
   - 审核时间：几小时到1个工作日
   - 审核通过后，产品状态会变为"**已上线**"

---

### 步骤 3：确认产品已上线

1. **检查产品状态**
   - 在应用详情 → 产品列表中
   - 确认"手机网站支付"产品状态为"**已上线**"
   - 如果状态是"审核中"或"未上线"，需要等待

2. **检查产品权限**
   - 确认产品已正确关联到当前应用
   - 确认产品没有过期或被禁用

---

### 步骤 4：检查环境配置

1. **确认使用的环境**
   - **正式环境**：`https://openapi.alipay.com/gateway.do`
   - **沙箱环境**：`https://openapi.alipaydev.com/gateway.do`

2. **检查 Vercel 环境变量**
   - 确认 `ALIPAY_GATEWAY` 的值是否正确
   - **正式环境**：`ALIPAY_GATEWAY=https://openapi.alipay.com/gateway.do`
   - **沙箱环境**：`ALIPAY_GATEWAY=https://openapi.alipaydev.com/gateway.do`

3. **环境匹配原则**
   - 如果应用已上线且产品已签约，使用**正式环境**
   - 如果还在测试阶段，使用**沙箱环境**

---

### 步骤 5：检查应用类型

1. **确认应用类型**
   - 在应用详情页面，查看应用类型
   - 应该选择"**网页&移动应用**" → "**手机网站支付**"

2. **如果应用类型不对**
   - 需要重新创建应用
   - 选择正确的应用类型

---

## 详细操作指南

### 如何签约"手机网站支付"产品

1. **登录支付宝开放平台**
   - 访问：https://open.alipay.com/
   - 登录账号

2. **进入应用详情**
   - 控制台 → 网页&移动应用 → 选择你的应用

3. **添加产品**
   - 在应用详情页面，找到"**产品列表**"或"**功能列表**"
   - 点击"**添加产品**"或"**签约产品**"

4. **选择产品**
   - 在产品列表中，找到"**手机网站支付**"
   - 点击"**立即签约**"或"**查看详情**"

5. **填写签约信息**
   - 填写产品使用场景
   - 填写网站信息（如：https://geshixiugai.org）
   - 提交签约申请

6. **等待审核**
   - 审核时间：几小时到1个工作日
   - 审核通过后，产品状态会变为"**已上线**"

---

## 常见问题

### Q1: 应用已创建，但找不到产品列表？

**A**: 
- 新创建的应用可能还没有产品列表入口
- 需要先完成应用审核，审核通过后才能签约产品
- 或者产品列表在"**功能管理**"或"**接口管理**"中

### Q2: 产品签约需要什么条件？

**A**: 
- 应用必须已通过审核
- 需要完成企业认证（个体工商户需要营业执照）
- 需要填写产品使用场景

### Q3: 如何知道产品是否已签约？

**A**: 
- 在应用详情 → 产品列表中查看
- 如果看到"手机网站支付"且状态为"已上线"，说明已签约
- 如果看不到或状态为"未签约"，需要签约

### Q4: 沙箱环境和正式环境的区别？

**A**: 
- **沙箱环境**：用于测试，不需要签约产品，但功能有限
- **正式环境**：用于生产，必须签约产品并通过审核

### Q5: 可以使用沙箱环境测试吗？

**A**: 
- 可以，但需要：
  1. 设置 `ALIPAY_GATEWAY=https://openapi.alipaydev.com/gateway.do`
  2. 使用沙箱账号测试（支付宝会提供测试账号）
  3. 注意：沙箱环境的数据不会真实扣款

---

## 检查清单

完成以下检查，确保配置正确：

- [ ] 应用状态为"已上线"或"审核通过"
- [ ] 已签约"手机网站支付"产品
- [ ] 产品状态为"已上线"
- [ ] `ALIPAY_GATEWAY` 环境变量配置正确（正式环境或沙箱环境）
- [ ] `ALIPAY_APP_ID` 环境变量配置正确
- [ ] `ALIPAY_PRIVATE_KEY` 环境变量配置正确
- [ ] `ALIPAY_PUBLIC_KEY` 环境变量配置正确
- [ ] 应用公钥已正确上传到支付宝
- [ ] 已重新部署 Vercel 项目

---

## 验证步骤

完成配置后：

1. **重新部署 Vercel 项目**
   - 在 Vercel Dashboard 中，点击最新部署的 "Redeploy"

2. **测试支付功能**
   - 访问网站：https://geshixiugai.org/web/
   - 上传文档并处理
   - 选择"支付宝"支付方式
   - 点击"立即支付"

3. **查看日志**
   - 如果仍有错误，查看 Vercel 日志
   - 确认错误信息是否已解决

---

## 联系支付宝支持

如果问题仍然存在：

1. **支付宝开放平台客服**
   - 客服电话：95188
   - 在线客服：https://open.alipay.com/ → 右上角"帮助中心"

2. **提供信息**
   - 应用 AppID
   - 错误代码：`insufficient-isv-permissions`
   - 应用状态和产品签约状态
   - 操作步骤截图

---

## 下一步

完成产品签约后：

1. ✅ 确认产品已上线
2. ✅ 确认环境变量配置正确
3. ✅ 重新部署 Vercel 项目
4. ✅ 测试支付功能

**如果产品已签约但仍报错，请检查：**
- 应用状态是否为"已上线"
- 产品状态是否为"已上线"
- 环境变量是否正确配置
- 是否已重新部署

---

## 产品已上线但仍报错 - 深入排查

如果**产品已明确上线**，但仍然遇到 `insufficient-isv-permissions` 错误，请按以下步骤排查：

### 排查 1：确认应用状态（最重要）

**关键点**：产品已上线 ≠ 应用已上线

1. **登录支付宝开放平台**
   - 访问：https://open.alipay.com/
   - 进入控制台 → 网页&移动应用

2. **检查应用状态**
   - 找到你的应用，查看应用状态
   - **必须确认应用状态为"已上线"**（不是"审核中"或"审核通过"）
   - 如果应用状态不是"已上线"，即使产品已上线，也会报 ISV 权限不足错误

3. **如果应用未上线**
   - 点击应用 → 查看审核状态
   - 如果还在审核中，需要等待审核通过
   - 如果审核失败，需要根据提示修改后重新提交
   - **只有应用状态为"已上线"时，才能正常使用支付功能**

### 排查 2：检查应用类型

1. **确认应用类型**
   - 在应用详情页面，查看应用类型
   - 应该显示为"**网页&移动应用**" → "**手机网站支付**"
   - 如果应用类型不对（比如是"自研应用"或其他类型），可能需要重新创建应用

2. **检查应用功能**
   - 确认应用已开通"手机网站支付"功能
   - 在应用详情 → 功能列表中，应该能看到"手机网站支付"且状态为"已上线"

### 排查 3：检查应用公钥配置

1. **确认应用公钥已上传**
   - 在应用详情 → 开发信息 → 接口加签方式
   - 确认已设置"公钥"方式（不是"证书"方式）
   - 确认应用公钥已正确上传

2. **验证公钥匹配**
   - 确认上传到支付宝的**应用公钥**与你的**应用私钥**是配对的
   - 如果公钥和私钥不匹配，会导致权限验证失败

3. **重新上传公钥（如果需要）**
   - 如果无法确认公钥是否匹配，可以重新生成密钥对
   - 重新上传应用公钥到支付宝
   - 更新 Vercel 环境变量中的 `ALIPAY_PRIVATE_KEY` 和 `ALIPAY_PUBLIC_KEY`

### 排查 4：检查环境配置

1. **确认使用正式环境**
   - 如果产品已上线，必须使用正式环境
   - 确认 `ALIPAY_GATEWAY=https://openapi.alipay.com/gateway.do`（不是沙箱地址）

2. **检查 Vercel 环境变量**
   - 登录 Vercel Dashboard
   - 进入项目 → Settings → Environment Variables
   - 确认以下变量都已正确配置：
     - `ALIPAY_APP_ID`：应用ID（格式：2021001234567890）
     - `ALIPAY_PRIVATE_KEY`：应用私钥（完整内容）
     - `ALIPAY_PUBLIC_KEY`：支付宝公钥（完整内容）
     - `ALIPAY_GATEWAY`：`https://openapi.alipay.com/gateway.do`
     - `ALIPAY_SIGN_TYPE`：`RSA2`

3. **重新部署**
   - 修改环境变量后，必须重新部署
   - 在 Vercel Dashboard → Deployments → 点击最新部署的 "Redeploy"

### 排查 5：查看详细错误信息

1. **查看 Vercel 日志**
   - 在 Vercel Dashboard → 项目 → Deployments → 点击最新部署 → Logs
   - 查找 `[AlipayService]` 开头的日志
   - 查看完整的错误信息和堆栈

2. **检查支付宝返回的错误**
   - 支付宝可能返回更详细的错误信息
   - 查看日志中的 `error_msg` 字段，可能包含更具体的错误原因

### 排查 6：联系支付宝技术支持

如果以上步骤都已确认无误，但仍报错：

1. **准备以下信息**
   - 应用 AppID
   - 应用状态截图（显示"已上线"）
   - 产品列表截图（显示"手机网站支付"已上线）
   - 完整的错误信息（包括错误代码和错误原因）
   - Vercel 日志中的错误堆栈

2. **联系支付宝客服**
   - 客服电话：95188
   - 在线客服：https://open.alipay.com/ → 右上角"帮助中心" → "在线客服"
   - 说明：产品已上线，应用状态为"已上线"，但仍报 ISV 权限不足错误

3. **可能的问题**
   - 支付宝系统延迟（产品刚上线，系统可能还未同步）
   - 应用权限配置问题（需要支付宝技术支持检查）
   - 接口调用方式问题（需要确认 SDK 调用是否正确）

---

## 快速检查清单（产品已上线但仍报错）

按优先级检查：

1. ✅ **应用状态是否为"已上线"**（不是"审核通过"或"审核中"）
2. ✅ **产品状态是否为"已上线"**（确认）
3. ✅ **应用类型是否为"网页&移动应用" → "手机网站支付"**
4. ✅ **应用公钥是否已正确上传到支付宝**
5. ✅ **应用公钥和应用私钥是否匹配**
6. ✅ **ALIPAY_GATEWAY 是否为正式环境地址**
7. ✅ **所有环境变量是否已正确配置**
8. ✅ **是否已重新部署 Vercel 项目**
9. ✅ **查看 Vercel 日志中的详细错误信息**

**如果以上都已确认无误，建议联系支付宝技术支持（95188）**

