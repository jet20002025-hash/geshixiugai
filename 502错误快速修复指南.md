# 502 Bad Gateway å¿«é€Ÿä¿®å¤æŒ‡å—

## ğŸ” é—®é¢˜åŸå› 

502 Bad Gateway è¡¨ç¤º Nginx æ— æ³•è¿æ¥åˆ°åç«¯æœåŠ¡ï¼ˆGunicornï¼‰ï¼Œé€šå¸¸æ˜¯å› ä¸ºï¼š
1. åç«¯æœåŠ¡æ²¡æœ‰è¿è¡Œ
2. æœåŠ¡å¯åŠ¨å¤±è´¥ï¼ˆå¯èƒ½æ˜¯ä»£ç é”™è¯¯æˆ–ç¼ºå°‘ä¾èµ–ï¼‰
3. ç«¯å£é…ç½®é—®é¢˜

---

## ğŸš€ å¿«é€Ÿä¿®å¤æ­¥éª¤

### åœ¨é˜¿é‡Œäº‘æœåŠ¡å™¨çš„è¿œç¨‹è¿æ¥ç»ˆç«¯é‡Œæ‰§è¡Œï¼š

```bash
# 1. æ£€æŸ¥æœåŠ¡çŠ¶æ€
sudo systemctl status geshixiugai

# 2. æŸ¥çœ‹è¯¦ç»†é”™è¯¯æ—¥å¿—
sudo journalctl -u geshixiugai -n 50 --no-pager

# 3. æ£€æŸ¥ç«¯å£æ˜¯å¦ç›‘å¬
sudo netstat -tlnp | grep 8000
```

---

## ğŸ”§ æ ¹æ®é”™è¯¯ä¿¡æ¯ä¿®å¤

### æƒ…å†µ 1ï¼šæœåŠ¡æœªè¿è¡Œï¼ˆinactiveï¼‰

```bash
# é‡å¯æœåŠ¡
sudo systemctl restart geshixiugai

# æ£€æŸ¥çŠ¶æ€
sudo systemctl status geshixiugai
```

### æƒ…å†µ 2ï¼šæœåŠ¡å¯åŠ¨å¤±è´¥ï¼ˆå¯èƒ½æ˜¯ç¼ºå°‘ä¾èµ–ï¼‰

```bash
# è¿›å…¥é¡¹ç›®ç›®å½•
cd /var/www/geshixiugai

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
source venv/bin/activate

# å®‰è£…æ‰€æœ‰ä¾èµ–ï¼ˆåŒ…æ‹¬æ–°æ·»åŠ çš„ weasyprintï¼‰
pip install -r requirements.txt

# éªŒè¯ weasyprint æ˜¯å¦å®‰è£…
python -c "import weasyprint; print('OK')"

# é€€å‡ºè™šæ‹Ÿç¯å¢ƒ
deactivate

# é‡å¯æœåŠ¡
sudo systemctl restart geshixiugai
```

### æƒ…å†µ 3ï¼šä»£ç é”™è¯¯ï¼ˆå¯èƒ½æ˜¯å¯¼å…¥é”™è¯¯ï¼‰

```bash
# è¿›å…¥é¡¹ç›®ç›®å½•
cd /var/www/geshixiugai

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
source venv/bin/activate

# æµ‹è¯•å¯¼å…¥
python -c "from backend.app.main import app; print('å¯¼å…¥æˆåŠŸ')"

# å¦‚æœæŠ¥é”™ï¼ŒæŸ¥çœ‹å…·ä½“é”™è¯¯ä¿¡æ¯
```

### æƒ…å†µ 4ï¼šæ‰‹åŠ¨æµ‹è¯•å¯åŠ¨ï¼ˆæŸ¥çœ‹å…·ä½“é”™è¯¯ï¼‰

```bash
cd /var/www/geshixiugai
source venv/bin/activate

# æ‰‹åŠ¨å¯åŠ¨ï¼ŒæŸ¥çœ‹å…·ä½“é”™è¯¯
gunicorn -c gunicorn_config.py backend.app.main:app
```

**æŒ‰ Ctrl+C åœæ­¢æµ‹è¯•**

---

## ğŸ“‹ å®Œæ•´ä¿®å¤æµç¨‹ï¼ˆæ¨èï¼‰

åœ¨é˜¿é‡Œäº‘æœåŠ¡å™¨çš„è¿œç¨‹è¿æ¥ç»ˆç«¯é‡Œï¼Œä¾æ¬¡æ‰§è¡Œï¼š

```bash
# 1. è¿›å…¥é¡¹ç›®ç›®å½•
cd /var/www/geshixiugai

# 2. æ›´æ–°ä»£ç ï¼ˆç¡®ä¿æœ‰æœ€æ–°çš„PDFé¢„è§ˆåŠŸèƒ½ï¼‰
git pull origin main

# 3. æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
source venv/bin/activate

# 4. å®‰è£…æ‰€æœ‰ä¾èµ–ï¼ˆåŒ…æ‹¬ weasyprintï¼‰
pip install -r requirements.txt

# 5. éªŒè¯ weasyprint
python -c "import weasyprint; print('âœ… WeasyPrint æ­£å¸¸')"

# 6. æµ‹è¯•åº”ç”¨å¯¼å…¥
python -c "from backend.app.main import app; print('âœ… åº”ç”¨å¯¼å…¥æˆåŠŸ')"

# 7. é€€å‡ºè™šæ‹Ÿç¯å¢ƒ
deactivate

# 8. é‡å¯æœåŠ¡
sudo systemctl restart geshixiugai

# 9. æ£€æŸ¥æœåŠ¡çŠ¶æ€
sudo systemctl status geshixiugai

# 10. æŸ¥çœ‹æ—¥å¿—ï¼ˆç¡®è®¤æ²¡æœ‰é”™è¯¯ï¼‰
sudo journalctl -u geshixiugai -n 20
```

---

## âœ… éªŒè¯ä¿®å¤æˆåŠŸ

### æ–¹æ³• 1ï¼šæ£€æŸ¥æœåŠ¡çŠ¶æ€

```bash
sudo systemctl status geshixiugai
```

åº”è¯¥æ˜¾ç¤ºï¼š
```
Active: active (running)
```

### æ–¹æ³• 2ï¼šæµ‹è¯•æœ¬åœ°è®¿é—®

```bash
curl http://localhost:8000
```

åº”è¯¥è¿”å›å“åº”ï¼ˆä¸æ˜¯ 502 é”™è¯¯ï¼‰

### æ–¹æ³• 3ï¼šæ£€æŸ¥ç«¯å£ç›‘å¬

```bash
sudo netstat -tlnp | grep 8000
```

åº”è¯¥çœ‹åˆ°ç±»ä¼¼ï¼š
```
tcp  0  0  127.0.0.1:8000  LISTEN  xxxx/python
```

### æ–¹æ³• 4ï¼šè®¿é—®ç½‘ç«™

åˆ·æ–°æµè§ˆå™¨ï¼Œåº”è¯¥ä¸å†æ˜¾ç¤º 502 é”™è¯¯ã€‚

---

## ğŸ” å¸¸è§é”™è¯¯å’Œè§£å†³æ–¹æ¡ˆ

### é”™è¯¯ 1ï¼šModuleNotFoundError: No module named 'weasyprint'

**è§£å†³ï¼š**
```bash
cd /var/www/geshixiugai
source venv/bin/activate
pip install weasyprint
deactivate
sudo systemctl restart geshixiugai
```

### é”™è¯¯ 2ï¼šImportError: cannot import name 'HTML' from 'weasyprint'

**è§£å†³ï¼š**
```bash
cd /var/www/geshixiugai
source venv/bin/activate
pip install --upgrade weasyprint
deactivate
sudo systemctl restart geshixiugai
```

### é”™è¯¯ 3ï¼šæœåŠ¡å¯åŠ¨ä½†ç«‹å³é€€å‡º

**è§£å†³ï¼š**
```bash
# æŸ¥çœ‹è¯¦ç»†æ—¥å¿—
sudo journalctl -u geshixiugai -n 100 --no-pager

# æ‰‹åŠ¨æµ‹è¯•å¯åŠ¨ï¼ŒæŸ¥çœ‹å…·ä½“é”™è¯¯
cd /var/www/geshixiugai
source venv/bin/activate
gunicorn -c gunicorn_config.py backend.app.main:app
```

---

## ğŸš¨ ç´§æ€¥ä¿®å¤ï¼ˆå¦‚æœä»¥ä¸Šéƒ½ä¸è¡Œï¼‰

```bash
# 1. åœæ­¢æœåŠ¡
sudo systemctl stop geshixiugai

# 2. è¿›å…¥é¡¹ç›®ç›®å½•
cd /var/www/geshixiugai

# 3. æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
source venv/bin/activate

# 4. é‡æ–°å®‰è£…æ‰€æœ‰ä¾èµ–
pip install --upgrade -r requirements.txt

# 5. æµ‹è¯•å¯¼å…¥
python -c "from backend.app.main import app"

# 6. å¦‚æœæµ‹è¯•æˆåŠŸï¼Œé€€å‡ºå¹¶é‡å¯
deactivate
sudo systemctl start geshixiugai
sudo systemctl status geshixiugai
```

---

## ğŸ“ æ£€æŸ¥æ¸…å•

æ‰§è¡Œä¿®å¤åï¼Œç¡®è®¤ï¼š

- [ ] æœåŠ¡çŠ¶æ€ï¼š`Active: active (running)`
- [ ] ç«¯å£ç›‘å¬ï¼š`netstat` æ˜¾ç¤º 8000 ç«¯å£åœ¨ç›‘å¬
- [ ] æœ¬åœ°æµ‹è¯•ï¼š`curl http://localhost:8000` æœ‰å“åº”
- [ ] ç½‘ç«™è®¿é—®ï¼šæµè§ˆå™¨ä¸å†æ˜¾ç¤º 502 é”™è¯¯
- [ ] æ—¥å¿—æ­£å¸¸ï¼š`journalctl` æ²¡æœ‰é”™è¯¯ä¿¡æ¯

---

## ğŸ’¡ å°è´´å£«

1. **å…ˆæŸ¥çœ‹æ—¥å¿—**ï¼š`sudo journalctl -u geshixiugai -n 50` é€šå¸¸èƒ½å¿«é€Ÿå®šä½é—®é¢˜
2. **æ‰‹åŠ¨æµ‹è¯•**ï¼šæ‰‹åŠ¨å¯åŠ¨ gunicorn å¯ä»¥çœ‹åˆ°è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
3. **æ£€æŸ¥ä¾èµ–**ï¼šå®‰è£… weasyprint åï¼Œç¡®ä¿æ‰€æœ‰ä¾èµ–éƒ½å·²å®‰è£…

---

**ç°åœ¨æ‰§è¡Œä¿®å¤æ­¥éª¤ï¼Œå‘Šè¯‰æˆ‘ç»“æœï¼** ğŸ”§

