# 支付宝支付配置 - 完整步骤

## 📋 当前进度

- [x] 服务器已部署
- [x] 服务已启动
- [x] 域名解析已配置
- [x] 网站已可访问
- [x] 支付宝应用网关已配置
- [ ] SSL 证书配置（HTTPS）
- [ ] 在服务器上配置支付宝环境变量
- [ ] 添加备案号到网站底部
- [ ] 测试支付功能

---

## 🚀 接下来的步骤

### 步骤 1：配置 SSL 证书（HTTPS）

在服务器上执行（阿里云控制台的对话框里）：

```bash
# 1. 安装 Certbot
sudo dnf install -y certbot python3-certbot-nginx

# 2. 申请 SSL 证书
sudo certbot --nginx -d geshixiugai.cn -d www.geshixiugai.cn
```

按照提示操作：
- 输入邮箱地址
- 同意服务条款（输入 `Y`）
- 是否接收邮件通知（可选）

完成后，访问 `https://geshixiugai.cn` 应该可以正常访问。

---

### 步骤 2：在服务器上配置支付宝环境变量

#### 2.1 获取支付宝配置信息

如果你已经有支付宝开放平台应用：
1. 登录：https://open.alipay.com/
2. 进入应用管理 → 你的应用
3. 获取：
   - **AppID**
   - **应用私钥（Private Key）**
   - **支付宝公钥（Public Key）**

#### 2.2 编辑 .env 文件

在服务器上执行：

```bash
cd /var/www/geshixiugai
vi .env
```

在 vi 编辑器中：
1. 按 `G` 跳转到文件末尾
2. 按 `i` 进入编辑模式
3. 添加支付宝配置：

```bash
# 支付宝支付配置
ALIPAY_APP_ID=你的支付宝AppID
ALIPAY_PRIVATE_KEY=你的应用私钥（完整内容）
ALIPAY_PUBLIC_KEY=支付宝公钥（完整内容）
ALIPAY_SIGN_TYPE=RSA2
ALIPAY_GATEWAY=https://openapi.alipay.com/gateway.do
BASE_URL=https://geshixiugai.cn
```

4. 保存退出：按 `Esc`，输入 `:wq`，按回车

#### 2.3 重启服务

```bash
sudo systemctl restart geshixiugai
sudo systemctl status geshixiugai
```

---

### 步骤 3：添加备案号到网站底部

在服务器上执行：

```bash
cd /var/www/geshixiugai
vi frontend/index.html
```

在 vi 编辑器中：
1. 按 `G` 跳转到文件末尾
2. 按 `i` 进入编辑模式
3. 在 `</body>` 标签之前添加：

```html
<footer style="text-align: center; padding: 20px; color: #666; font-size: 12px; border-top: 1px solid #eee; margin-top: 40px;">
    <p>备案号：<a href="https://beian.miit.gov.cn/" target="_blank" style="color: #666; text-decoration: none;">浙ICP备2025213303号-1</a></p>
</footer>
```

4. 保存退出：按 `Esc`，输入 `:wq`，按回车
5. 重启服务：`sudo systemctl restart geshixiugai`

---

### 步骤 4：验证配置

#### 4.1 验证 SSL 证书

在浏览器中访问：
- `https://geshixiugai.cn`
- 应该看到绿色锁图标 🔒

#### 4.2 验证支付宝配置

访问调试端点：
```
https://geshixiugai.cn/payments/debug/config
```

应该返回 JSON，显示支付宝配置状态：
```json
{
  "alipay": {
    "app_id_exists": true,
    "configured": true
  }
}
```

#### 4.3 测试支付流程

1. 访问：https://geshixiugai.cn
2. 上传模板和文档
3. 进入支付页面
4. 选择"支付宝支付"
5. 点击"立即支付"
6. 应该跳转到支付宝支付页面

---

## 📋 完整操作清单

### 立即执行（按顺序）

1. **配置 SSL 证书**
   ```bash
   sudo dnf install -y certbot python3-certbot-nginx
   sudo certbot --nginx -d geshixiugai.cn -d www.geshixiugai.cn
   ```

2. **配置支付宝环境变量**
   ```bash
   cd /var/www/geshixiugai
   vi .env
   # 添加支付宝配置，保存退出
   sudo systemctl restart geshixiugai
   ```

3. **添加备案号**
   ```bash
   cd /var/www/geshixiugai
   vi frontend/index.html
   # 添加备案号，保存退出
   sudo systemctl restart geshixiugai
   ```

4. **验证配置**
   - 访问：https://geshixiugai.cn/payments/debug/config
   - 测试支付流程

---

## 🎯 推荐执行顺序

### 优先级 1：配置 SSL 证书（重要）

让网站支持 HTTPS，更安全。

### 优先级 2：配置支付宝支付

如果已经有支付宝配置信息，立即配置。

### 优先级 3：添加备案号

完成合规要求。

---

## 📞 需要帮助？

- **SSL 证书配置**：见 `配置SSL证书-HTTPS.md`
- **支付宝配置**：见 `阿里云服务器-支付宝支付配置指南.md`
- **添加备案号**：见 `添加备案号-具体操作.md`

---

**现在开始执行步骤 1：配置 SSL 证书！** 🚀


