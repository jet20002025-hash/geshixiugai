# 阿里云服务器 - 支付宝支付配置指南

## 📋 配置概览

现在你的网站已部署在阿里云服务器上，域名是 `geshixiugai.cn`，需要配置支付宝支付。

---

## 🎯 需要配置的内容

### 必需配置

1. **支付宝 AppID**
2. **应用私钥（Private Key）**
3. **支付宝公钥（Public Key）**
4. **更新回调地址**（从旧域名改为新域名）

---

## 📝 步骤 1：获取支付宝配置信息

### 如果你已经有支付宝开放平台应用

1. **登录支付宝开放平台**
   - 访问：https://open.alipay.com/
   - 使用你的支付宝账号登录

2. **进入应用管理**
   - 点击"控制台" → "网页&移动应用"
   - 找到你的应用，点击进入

3. **获取配置信息**
   - **AppID**：在应用详情页可以看到
   - **应用私钥**：在"接口加签方式"中查看或下载
   - **支付宝公钥**：在"接口加签方式"中查看

### 如果你还没有支付宝应用

需要先创建应用并签约产品，详细步骤见：`支付宝支付开通步骤.md`

---

## 🔧 步骤 2：更新回调地址

### 在支付宝开放平台更新回调地址

1. **进入应用详情**
   - 支付宝开放平台 → 你的应用

2. **配置回调地址**
   - 找到"接口加签方式"或"开发信息"
   - 更新以下地址：
     - **服务器异步通知页面路径**：`https://geshixiugai.cn/payments/alipay/notify`
     - **页面跳转同步通知页面路径**：`https://geshixiugai.cn/payments/alipay/return`

3. **保存配置**

---

## ⚙️ 步骤 3：在服务器上配置环境变量

### 编辑 .env 文件

在服务器上执行（阿里云控制台的对话框里）：

```bash
# 1. 进入项目目录
cd /var/www/geshixiugai

# 2. 编辑 .env 文件
vi .env
```

### 在 vi 编辑器中添加支付宝配置

1. **进入编辑模式**：按 `i`

2. **添加支付宝配置**（在文件末尾添加）：

```bash
# 支付宝支付配置
ALIPAY_APP_ID=你的支付宝AppID
ALIPAY_PRIVATE_KEY=你的应用私钥（完整内容，包括BEGIN和END行）
ALIPAY_PUBLIC_KEY=支付宝公钥（完整内容）
ALIPAY_SIGN_TYPE=RSA2
ALIPAY_GATEWAY=https://openapi.alipay.com/gateway.do

# 支付回调地址（可选，代码会自动使用当前域名）
BASE_URL=https://geshixiugai.cn
```

3. **保存退出**：
   - 按 `Esc`
   - 输入 `:wq`
   - 按回车

### 配置示例

```bash
ALIPAY_APP_ID=2021006109680085
ALIPAY_PRIVATE_KEY=-----BEGIN RSA PRIVATE KEY-----
MIIEpAIBAAKCAQEA...
（完整的私钥内容）
-----END RSA PRIVATE KEY-----
ALIPAY_PUBLIC_KEY=-----BEGIN PUBLIC KEY-----
MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8A...
（完整的支付宝公钥内容）
-----END PUBLIC KEY-----
ALIPAY_SIGN_TYPE=RSA2
ALIPAY_GATEWAY=https://openapi.alipay.com/gateway.do
BASE_URL=https://geshixiugai.cn
```

---

## 🔄 步骤 4：重启服务

```bash
# 重启服务使配置生效
sudo systemctl restart geshixiugai

# 检查服务状态
sudo systemctl status geshixiugai

# 查看日志，确认支付宝配置加载成功
sudo tail -n 50 /var/log/geshixiugai/error.log | grep -i alipay
```

应该看到类似：
```
[AlipayService] 支付宝客户端初始化成功
```

---

## ✅ 步骤 5：验证配置

### 方法 1：访问调试端点

在浏览器中访问：
```
https://geshixiugai.cn/payments/debug/config
```

应该返回 JSON，包含支付宝配置信息：
```json
{
  "alipay": {
    "app_id_exists": true,
    "app_id_preview": "2021****",
    "private_key_exists": true,
    "public_key_exists": true,
    "configured": true
  }
}
```

### 方法 2：测试支付流程

1. **访问网站**：https://geshixiugai.cn
2. **上传文档**：上传模板和文档
3. **进入支付页面**：选择"支付宝支付"
4. **测试支付**：点击"立即支付"，应该跳转到支付宝支付页面

---

## 📋 完整操作流程

### 1. 获取支付宝配置信息

- 登录支付宝开放平台
- 获取 AppID、私钥、公钥

### 2. 更新回调地址

- 在支付宝开放平台更新回调地址为：`https://geshixiugai.cn/payments/alipay/notify`

### 3. 配置服务器环境变量

```bash
cd /var/www/geshixiugai
vi .env
# 添加支付宝配置，保存退出
```

### 4. 重启服务

```bash
sudo systemctl restart geshixiugai
sudo systemctl status geshixiugai
```

### 5. 验证配置

- 访问：https://geshixiugai.cn/payments/debug/config
- 测试支付流程

---

## ⚠️ 重要提示

### 1. 私钥格式

- 如果私钥包含 `-----BEGIN RSA PRIVATE KEY-----` 和 `-----END RSA PRIVATE KEY-----`，需要完整复制包括这些标记
- 如果私钥是纯 base64 字符串，直接粘贴即可，系统会自动格式化

### 2. 公钥格式

- 支付宝公钥可能没有 BEGIN/END 标记，直接粘贴即可
- 系统会自动添加标记

### 3. 回调地址

- 确保在支付宝开放平台配置的回调地址是：`https://geshixiugai.cn/payments/alipay/notify`
- 确保域名已备案（你已经备案了）

### 4. 安全提示

- 不要将私钥提交到 Git 仓库
- 只通过 .env 文件配置
- 确保 .env 文件权限正确：`chmod 600 .env`

---

## 🔍 故障排查

### 问题 1：支付订单创建失败

```bash
# 查看服务日志
sudo tail -n 100 /var/log/geshixiugai/error.log | grep -i alipay
```

### 问题 2：回调验证失败

- 检查支付宝开放平台回调地址配置
- 检查支付宝公钥是否正确

### 问题 3：配置未生效

```bash
# 检查 .env 文件
cat /var/www/geshixiugai/.env | grep ALIPAY

# 重启服务
sudo systemctl restart geshixiugai
```

---

## 📞 需要帮助？

如果遇到问题：
1. 查看服务日志：`sudo tail -f /var/log/geshixiugai/error.log`
2. 访问调试端点：https://geshixiugai.cn/payments/debug/config
3. 检查支付宝开放平台配置

---

**现在开始配置支付宝支付！** 💰








