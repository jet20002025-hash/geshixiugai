# 服务器端完整排查步骤

## 问题：检测日志没有输出

### 步骤 1: 确认代码已推送到 GitHub

在**本地**执行：
```bash
cd /Users/zwj/word格式修改器
git log --oneline -1
```

如果看到 "修复检测日志输出：使用sys.stderr确保Gunicorn捕获输出"，说明已提交。

检查是否有未推送的提交：
```bash
git log origin/main..HEAD --oneline
```

如果有输出，说明有未推送的提交，需要推送：
```bash
git push origin main
```

### 步骤 2: 在服务器上拉取最新代码

在**服务器**上执行：
```bash
cd /var/www/geshixiugai
git pull origin main
```

### 步骤 3: 验证代码已更新

在**服务器**上执行：
```bash
grep -c 'file=sys.stderr' backend/app/services/document_service.py
```

**期望输出**：应该是一个大于 0 的数字（比如 61）

如果输出是 0，说明代码还没有更新，需要：
1. 检查 git pull 是否成功
2. 检查是否有冲突
3. 手动检查文件内容

### 步骤 4: 检查服务启动时间

在**服务器**上执行：
```bash
sudo systemctl status geshixiugai
```

查看 "Active: active (running) since" 后面的时间。

如果服务启动时间早于代码更新时间，需要重启服务。

### 步骤 5: 重启服务

在**服务器**上执行：
```bash
sudo systemctl restart geshixiugai
sudo systemctl status geshixiugai
```

确认服务状态是 "active (running)"。

### 步骤 6: 检查日志文件

在**服务器**上执行：
```bash
# 检查文件是否存在
ls -la /var/log/geshixiugai/error.log

# 查看最近的日志（最后30行）
sudo tail -n 30 /var/log/geshixiugai/error.log
```

确认：
- 文件存在
- 有写入权限
- 有日志输出（即使不是检测日志）

### 步骤 7: 上传文档测试

**重要**：检测日志只在处理文档时才会生成！

1. 在网页上上传一个包含"诚信承诺"和"摘要"的文档
2. 等待文档处理完成（查看处理状态）
3. 然后查看日志

### 步骤 8: 查看检测日志

在**服务器**上执行：
```bash
# 查看检测日志
sudo grep "\[检测\]" /var/log/geshixiugai/error.log | tail -n 50

# 查看诊断日志
sudo grep "\[诊断\]" /var/log/geshixiugai/error.log | tail -n 50

# 查看修复日志
sudo grep "\[修复\]" /var/log/geshixiugai/error.log | tail -n 50
```

## 快速检查命令

在**服务器**上一次性执行所有检查：

```bash
cd /var/www/geshixiugai

echo "=== 1. 检查代码是否包含 sys.stderr ==="
grep -c 'file=sys.stderr' backend/app/services/document_service.py

echo ""
echo "=== 2. 检查服务状态 ==="
sudo systemctl status geshixiugai | head -10

echo ""
echo "=== 3. 检查最近的日志 ==="
sudo tail -n 20 /var/log/geshixiugai/error.log

echo ""
echo "=== 4. 检查检测日志 ==="
sudo grep "\[检测\]" /var/log/geshixiugai/error.log | tail -n 10 || echo "没有检测日志"
```

## 常见问题

### Q: 代码已经更新，但还是没有日志输出

**A**: 可能的原因：
1. 服务还没有重启 → 执行 `sudo systemctl restart geshixiugai`
2. 还没有处理过文档 → 需要在网页上上传文档
3. 文档中没有"诚信承诺"和"摘要" → 检测逻辑不会执行

### Q: git pull 显示 "Already up to date" 但代码不是最新的

**A**: 可能的原因：
1. 本地代码还没有推送到 GitHub → 先在本地执行 `git push origin main`
2. 服务器上的分支不是 main → 检查 `git branch`
3. 远程仓库地址不对 → 检查 `git remote -v`

### Q: 服务重启后还是没有日志

**A**: 检查：
1. 服务是否真的重启了 → `sudo systemctl status geshixiugai`
2. 代码是否真的更新了 → `grep -c 'file=sys.stderr' backend/app/services/document_service.py`
3. 是否处理过文档 → 检测日志只在处理文档时生成

