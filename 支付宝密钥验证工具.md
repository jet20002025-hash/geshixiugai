# 支付宝密钥验证和修复指南

## 当前错误

```
错误代码: invalid-signature
错误原因: 验签出错，建议检查签名字符串或签名私钥与应用公钥是否匹配
```

## 问题确认

这个错误**100%确定**是**应用私钥和应用公钥不匹配**导致的。

## 立即解决方案

### 方案 1：重新生成密钥对（最可靠）

**步骤 1：生成新密钥对**

1. 访问支付宝密钥生成工具：https://opendocs.alipay.com/common/02kkv7
2. 选择：
   - 密钥类型：**RSA2**
   - 密钥长度：**2048位**
   - 密钥格式：**PKCS8**
3. 点击"**生成密钥**"
4. **立即复制保存**：
   - **应用私钥**（private_key）→ 这是 `ALIPAY_PRIVATE_KEY`
   - **应用公钥**（public_key）→ 需要上传到支付宝

**步骤 2：上传应用公钥到支付宝**

1. 登录支付宝开放平台：https://open.alipay.com
2. 进入你的应用 → **开发信息** → **接口加签方式** → **设置**
3. 选择加签方式：**"公钥"**
4. **重要**：粘贴**应用公钥**（不是支付宝公钥！）
   - 必须包含 `-----BEGIN PUBLIC KEY-----` 和 `-----END PUBLIC KEY-----`
   - 完整复制，包括所有换行
5. 点击"**保存**"

**步骤 3：获取支付宝公钥**

1. 上传应用公钥后，支付宝会自动生成**支付宝公钥**
2. 在"接口加签方式"页面可以看到支付宝公钥
3. **复制保存**这个支付宝公钥 → 这是 `ALIPAY_PUBLIC_KEY`
   - 支付宝公钥通常**没有** BEGIN/END 标记（这是正常的）

**步骤 4：更新 Vercel 环境变量**

在 Vercel Dashboard → 项目设置 → Environment Variables 中更新：

```
ALIPAY_APP_ID=2021006109680085（保持不变）
ALIPAY_PRIVATE_KEY=新的应用私钥（完整内容，包括BEGIN/END标记）
ALIPAY_PUBLIC_KEY=新的支付宝公钥（完整内容，可能没有BEGIN/END标记）
ALIPAY_GATEWAY=https://openapi.alipay.com/gateway.do
ALIPAY_SIGN_TYPE=RSA2
```

**重要提示**：
- 如果密钥是多行的，在 Vercel 环境变量中直接粘贴，保持换行
- 或者将换行符替换为 `\n`（但直接粘贴更安全）

**步骤 5：重新部署**

1. 更新环境变量后，Vercel 会自动重新部署
2. 或者手动触发部署
3. 等待部署完成（约 1-3 分钟）

**步骤 6：测试**

部署完成后，再次测试支付功能。

---

### 方案 2：验证现有密钥是否匹配

如果你不想重新生成，可以验证现有密钥：

**方法 1：使用在线工具**

1. 访问：https://opendocs.alipay.com/common/02kkv7
2. 使用"密钥验证"功能
3. 输入你的应用私钥和应用公钥
4. 检查是否匹配

**方法 2：检查支付宝配置**

1. 登录支付宝开放平台
2. 进入应用 → 开发信息 → 接口加签方式
3. 查看当前配置的应用公钥
4. 确认这个公钥和你本地保存的应用公钥是否一致
5. 确认应用公钥和应用私钥是配对的

---

## 常见错误

### ❌ 错误 1：上传了支付宝公钥而不是应用公钥

**症状**：签名验证失败

**解决**：
- 应用公钥：从密钥生成工具生成的，需要上传到支付宝
- 支付宝公钥：支付宝返回的，用于验证支付宝的响应
- **不要混淆**！

### ❌ 错误 2：密钥格式不正确

**症状**：SDK 初始化失败或签名失败

**解决**：
- 应用私钥必须包含 `-----BEGIN PRIVATE KEY-----` 和 `-----END PRIVATE KEY-----`
- 应用公钥必须包含 `-----BEGIN PUBLIC KEY-----` 和 `-----END PUBLIC KEY-----`
- 支付宝公钥可能没有 BEGIN/END 标记（系统会自动添加）

### ❌ 错误 3：密钥不完整

**症状**：签名验证失败

**解决**：
- 确保完整复制密钥，包括所有换行
- 在 Vercel 环境变量中，保持密钥的原始格式

---

## 验证清单

完成配置后，检查以下项目：

- [ ] 应用私钥和应用公钥是从同一个密钥对生成的
- [ ] 应用公钥已正确上传到支付宝开放平台
- [ ] Vercel 环境变量中的 `ALIPAY_PRIVATE_KEY` 是应用私钥
- [ ] Vercel 环境变量中的 `ALIPAY_PUBLIC_KEY` 是支付宝公钥（不是应用公钥）
- [ ] 密钥格式正确（包含 BEGIN/END 标记，或系统会自动添加）
- [ ] 环境变量已更新并重新部署

---

## 如果问题仍然存在

1. **查看 Vercel 日志**：
   - Vercel Dashboard → 项目 → Functions → 查看日志
   - 查找 `[AlipayService]` 开头的日志
   - 检查是否有密钥格式相关的错误

2. **检查环境变量**：
   - 确认所有环境变量都已正确设置
   - 确认没有多余的空格或换行

3. **联系支持**：
   - 如果以上步骤都正确，但问题仍然存在
   - 可能需要联系支付宝技术支持

---

## 快速检查命令

如果你想在本地测试密钥格式，可以创建一个简单的 Python 脚本：

```python
from alipay import AliPay

# 测试密钥格式
app_id = "你的APP_ID"
app_private_key = "你的应用私钥"
alipay_public_key = "你的支付宝公钥"

try:
    alipay = AliPay(
        appid=app_id,
        app_notify_url=None,
        app_private_key_string=app_private_key,
        alipay_public_key_string=alipay_public_key,
        sign_type="RSA2",
        debug=False
    )
    print("✅ 密钥格式正确，SDK 初始化成功")
except Exception as e:
    print(f"❌ 密钥格式错误: {e}")
```

