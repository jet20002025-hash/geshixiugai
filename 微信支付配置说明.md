# 微信支付配置说明

## 一、配置信息说明

⚠️ **重要**：以下信息为示例，请替换为你的真实配置信息！

- **商户号（mch_id）**：`你的商户号`（10位数字）
- **API v2密钥（key）**：`你的32位API密钥`

## 二、在 Vercel 中配置环境变量

### 2.1 访问 Vercel 项目设置

1. 登录 Vercel Dashboard：https://vercel.com/dashboard
2. 选择你的项目：`geshixiugai`（或你的项目名）
3. 进入 **Settings** → **Environment Variables**

### 2.2 添加环境变量

添加以下环境变量：

#### 必需配置

```
WECHAT_MCH_ID=你的商户号
WECHAT_API_KEY=你的API密钥
```

⚠️ **注意**：请将上述值替换为你的真实配置信息！

#### 可选配置（H5支付需要）

如果你有公众号或微信开放平台应用，可以添加：

```
WECHAT_APP_ID=你的AppID（可选）
```

**说明**：
- 如果没有 `WECHAT_APP_ID`，系统会自动使用 **Native支付（扫码支付）**
- 如果有 `WECHAT_APP_ID`，系统会使用 **H5支付（网页支付）**

#### 其他配置

```
PAYMENT_PRICE=9.9
BASE_URL=https://geshixiugai.org
```

### 2.3 配置步骤

1. 在 Vercel Dashboard 中，点击 **Add New**
2. 输入变量名：`WECHAT_MCH_ID`
3. 输入变量值：`你的商户号`（例如：1234567890）
4. 选择环境：**Production, Preview, Development**（全选）
5. 点击 **Save**
6. 重复上述步骤，添加 `WECHAT_API_KEY` 和其他变量

### 2.4 重新部署

配置完成后，需要重新部署项目：

1. 在 Vercel Dashboard 中，进入 **Deployments**
2. 点击最新的部署记录右侧的 **...** 菜单
3. 选择 **Redeploy**
4. 等待部署完成（约 1-2 分钟）

---

## 三、支付方式说明

### 3.1 Native支付（扫码支付）

**适用场景**：
- 没有公众号或微信开放平台应用
- PC端支付

**特点**：
- ✅ 不需要 AppID
- ✅ 用户使用微信扫码支付
- ✅ 适合PC端使用

**用户体验**：
1. 用户点击"立即支付"
2. 页面显示支付二维码
3. 用户使用微信扫码支付
4. 支付完成后，页面自动更新

### 3.2 H5支付（网页支付）

**适用场景**：
- 有公众号或微信开放平台应用
- 移动端和PC端都支持

**特点**：
- ✅ 需要 AppID
- ✅ 用户直接跳转到微信支付页面
- ✅ 适合移动端和PC端

**用户体验**：
1. 用户点击"立即支付"
2. 页面跳转到微信支付页面
3. 用户完成支付
4. 自动返回网站

---

## 四、测试支付

### 4.1 测试步骤

1. 访问网站：https://geshixiugai.org/web/
2. 上传模板和文档
3. 处理完成后，选择"微信支付"
4. 点击"立即支付"
5. 根据配置的支付方式：
   - **Native支付**：显示二维码，扫码支付
   - **H5支付**：跳转到微信支付页面

### 4.2 测试注意事项

- ⚠️ 微信支付需要真实金额（即使是1分钱）
- ⚠️ 测试时建议使用小额金额
- ⚠️ 支付完成后，检查订单是否自动标记为已支付

---

## 五、支付回调配置

### 5.1 回调地址

系统已自动配置回调地址：
```
https://geshixiugai.org/api/payments/wechat/notify
```

### 5.2 回调验证

- ✅ 系统会自动验证签名
- ✅ 支付成功后自动标记订单为已支付
- ✅ 返回正确的XML响应给微信

### 5.3 回调日志

如果支付回调有问题，可以：
1. 查看 Vercel 的 **Functions Logs**
2. 检查是否有错误信息

---

## 六、常见问题

### Q1: 支付时提示"配置错误"

**A**: 检查环境变量是否正确配置：
- `WECHAT_MCH_ID` 是否正确
- `WECHAT_API_KEY` 是否正确
- 是否已重新部署

### Q2: 支付时提示"签名验证失败"

**A**: 
- 检查 API密钥是否正确
- 确认使用的是 API v2密钥（不是 v3密钥）

### Q3: 支付后订单没有自动标记为已支付

**A**: 
- 检查回调地址是否正确
- 查看 Vercel Functions Logs 是否有错误
- 确认回调地址可以公网访问

### Q4: 如何切换支付方式（H5/Native）

**A**: 
- 添加 `WECHAT_APP_ID` 环境变量 → 使用 H5支付
- 删除 `WECHAT_APP_ID` 环境变量 → 使用 Native支付

---

## 七、下一步

配置完成后：

1. ✅ 重新部署项目
2. ✅ 测试支付流程
3. ✅ 确认支付回调正常工作
4. ✅ 检查订单自动标记功能

**配置完成后，告诉我即可开始测试！**

