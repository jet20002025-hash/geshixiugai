# 支付宝网页应用接口修复说明

## 问题原因

你的支付宝应用类型是**"网页应用"**，但代码中使用的是**手机网站支付接口**（`api_alipay_trade_wap_pay`），这会导致 ISV 权限不足错误。

## 解决方案

已修改代码，将支付接口改为**电脑网站支付接口**（`api_alipay_trade_page_pay`），适用于网页应用。

## 应用信息确认

根据你提供的信息：
- **应用名称**：诚叔工具站
- **应用类型**：网页应用
- **AppID**：2021006109680085
- **状态**：已上线 ✅

## 代码修改

### 1. 修改了 `alipay_service.py`

- 添加了 `payment_type` 参数，支持选择支付类型
- 默认使用 `payment_type="page"`（电脑网站支付）
- 支持 `payment_type="wap"`（手机网站支付，适用于移动应用）

### 2. 修改了 `payments.py`

- 在创建支付订单时，明确指定使用电脑网站支付接口
- 添加了注释说明

## 支付接口说明

### 电脑网站支付（`api_alipay_trade_page_pay`）
- **适用场景**：网页应用（PC端和移动端浏览器）
- **接口名称**：`alipay.trade.page.pay`
- **产品名称**：电脑网站支付

### 手机网站支付（`api_alipay_trade_wap_pay`）
- **适用场景**：移动应用（H5页面）
- **接口名称**：`alipay.trade.wap.pay`
- **产品名称**：手机网站支付

## 下一步操作

1. **确认产品签约**
   - 登录支付宝开放平台
   - 进入应用详情 → 产品列表
   - 确认已签约"**电脑网站支付**"产品（不是"手机网站支付"）
   - 如果只签约了"手机网站支付"，需要签约"电脑网站支付"产品

2. **重新部署**
   - 代码已修改完成
   - 在 Vercel Dashboard 中重新部署项目
   - 等待部署完成（约 1-2 分钟）

3. **测试支付功能**
   - 访问网站：https://geshixiugai.org/web/
   - 上传文档并处理
   - 选择"支付宝"支付方式
   - 点击"立即支付"
   - 应该能正常跳转到支付宝支付页面

## 如果仍然报错

如果修改后仍然报 ISV 权限不足错误，请检查：

1. **确认产品签约**
   - 应用详情 → 产品列表
   - 确认"**电脑网站支付**"产品已签约且状态为"已上线"
   - 如果只看到"手机网站支付"，需要签约"电脑网站支付"

2. **查看 Vercel 日志**
   - 在 Vercel Dashboard → Deployments → 最新部署 → Logs
   - 查找 `[AlipayService]` 开头的日志
   - 查看支付类型是否正确显示为"电脑网站支付"

3. **联系支付宝技术支持**
   - 如果产品已签约但仍报错，联系支付宝客服：95188
   - 说明：应用类型是"网页应用"，已签约"电脑网站支付"产品，但仍报 ISV 权限不足错误

## 注意事项

- **网页应用**必须使用**电脑网站支付**接口
- **移动应用**使用**手机网站支付**接口
- 两种接口需要签约不同的产品
- 如果应用类型不对，需要重新创建应用或签约正确的产品

---

## 修改文件清单

- ✅ `backend/app/services/alipay_service.py` - 添加支付类型支持
- ✅ `backend/app/api/payments.py` - 使用电脑网站支付接口

修改已完成，请重新部署并测试！




