# 快速部署指南 - Vercel + Cloudflare

## 方案概述

- **后端**: Vercel (Serverless Functions)
- **存储**: Cloudflare R2 (对象存储，替代本地文件系统)
- **CDN**: Cloudflare (加速访问，国内可访问)
- **域名**: 通过 Cloudflare 管理

## 部署步骤

### 1. 准备 Cloudflare R2 存储

1. 登录 Cloudflare Dashboard
2. 进入 R2 → Create bucket
3. 创建 bucket（如：`word-formatter-storage`）
4. 创建 API Token：
   - R2 → Manage R2 API Tokens → Create API Token
   - 保存 `Account ID`、`Access Key ID`、`Secret Access Key`

### 2. 配置环境变量

在 Vercel 项目设置中添加环境变量：

```bash
# Cloudflare R2 配置
R2_ACCOUNT_ID=your_account_id
R2_ACCESS_KEY_ID=your_access_key
R2_SECRET_ACCESS_KEY=your_secret_key
R2_BUCKET_NAME=word-formatter-storage
R2_ENDPOINT=https://your_account_id.r2.cloudflarestorage.com

# 其他配置
PYTHON_VERSION=3.12
```

### 3. 部署到 Vercel

#### 方法1: 通过 GitHub 自动部署（推荐）

1. 将代码推送到 GitHub 仓库
2. 在 Vercel Dashboard 中：
   - 点击 "New Project"
   - 导入 GitHub 仓库
   - 框架预设选择 "Other"
   - 根目录保持默认
   - 点击 "Deploy"

#### 方法2: 使用 Vercel CLI

```bash
# 安装 Vercel CLI
npm i -g vercel

# 登录
vercel login

# 部署
cd /Users/zwj/word格式修改器
vercel

# 生产环境部署
vercel --prod
```

### 4. 配置 Cloudflare 域名

1. 在 Cloudflare 添加域名
2. 修改 DNS 记录：
   - 类型：CNAME
   - 名称：@ 或 www
   - 目标：`cname.vercel-dns.com`（Vercel 提供的域名）
3. 在 Vercel 项目设置中添加自定义域名

### 5. 配置 Cloudflare 加速（可选）

- 启用 Cloudflare CDN
- 配置缓存规则
- 启用 HTTPS（自动）

## 代码修改说明

### 需要修改文件存储为 R2

当前代码使用本地文件系统，需要改为使用 Cloudflare R2。

创建 `backend/app/services/storage.py`:

```python
import boto3
from botocore.config import Config
import os
from pathlib import Path
from typing import BinaryIO

class R2Storage:
    def __init__(self):
        self.s3_client = boto3.client(
            's3',
            endpoint_url=os.getenv('R2_ENDPOINT'),
            aws_access_key_id=os.getenv('R2_ACCESS_KEY_ID'),
            aws_secret_access_key=os.getenv('R2_SECRET_ACCESS_KEY'),
            config=Config(signature_version='s3v4')
        )
        self.bucket_name = os.getenv('R2_BUCKET_NAME')
    
    def upload_file(self, key: str, file_obj: BinaryIO):
        self.s3_client.upload_fileobj(file_obj, self.bucket_name, key)
    
    def download_file(self, key: str) -> bytes:
        response = self.s3_client.get_object(Bucket=self.bucket_name, Key=key)
        return response['Body'].read()
    
    def file_exists(self, key: str) -> bool:
        try:
            self.s3_client.head_object(Bucket=self.bucket_name, Key=key)
            return True
        except:
            return False
```

## 注意事项

1. **文件大小限制**: Vercel Serverless Functions 有 50MB 限制
   - 解决方案：大文件直接上传到 R2，不经过 Vercel

2. **执行时间限制**: 免费版 10 秒，Pro 版 60 秒
   - 解决方案：文档处理改为异步任务，使用队列

3. **存储**: 使用 Cloudflare R2 替代本地文件系统

4. **国内访问**: Cloudflare CDN 可以加速，但可能仍需要备案才能稳定访问

## 快速测试

部署后访问：
- 健康检查: `https://your-domain.vercel.app/`
- API 文档: `https://your-domain.vercel.app/docs`

## 故障排查

1. **导入错误**: 检查 `sys.path` 配置
2. **文件上传失败**: 检查 R2 配置和权限
3. **超时**: 考虑使用异步处理或增加超时时间

