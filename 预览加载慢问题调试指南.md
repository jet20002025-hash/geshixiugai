# 预览加载慢问题调试指南

## 🔍 如何调试预览加载慢的问题

### 1. 打开浏览器开发者工具

1. 按 `F12` 或右键点击页面 → "检查"
2. 切换到 **"Console"（控制台）** 标签页
3. 切换到 **"Network"（网络）** 标签页

### 2. 查看性能日志

预览页面会自动记录每个步骤的耗时，在控制台中可以看到：

```
[性能] 开始: 0.00ms - 初始化预览加载
[性能] 请求前: 5.23ms - 准备发送预览请求
[性能] 响应收到: 1234.56ms - 收到响应 (1229.33ms)
[性能] 读取中: 1234.56ms - 正在读取HTML内容
[性能] 读取完成: 2345.67ms - HTML内容读取完成 (1111.11ms)
[性能] 创建Blob: 2345.67ms - 正在创建Blob对象
[性能] Blob创建完成: 2346.78ms - Blob创建完成 (1.11ms)
[性能] 加载完成: 3456.89ms - 预览加载完成 (总耗时: 3456.89ms)
```

### 3. 查看网络请求详情

在 **Network** 标签页中：

1. 找到 `/documents/{id}/preview` 请求
2. 点击查看详情：
   - **Status**: 响应状态码（应该是 200）
   - **Time**: 请求总耗时
   - **Size**: 响应大小
   - **Headers**: 查看响应头中的 `X-Content-Size-KB`（HTML文件大小）

### 4. 常见问题诊断

#### 问题1: 请求时间很长（>5秒）

**可能原因：**
- 服务器响应慢
- 网络连接慢
- HTML文件生成慢

**解决方法：**
- 检查服务器日志
- 检查网络连接
- 查看HTML文件大小（如果>5MB可能很慢）

#### 问题2: 读取HTML内容很慢（>3秒）

**可能原因：**
- HTML文件太大
- 浏览器处理大文件慢

**解决方法：**
- 查看响应大小（Network标签页）
- 如果文件>5MB，考虑优化文档内容

#### 问题3: iframe加载超时

**可能原因：**
- HTML内容有问题
- 浏览器渲染慢

**解决方法：**
- 查看控制台是否有JavaScript错误
- 尝试刷新页面
- 检查HTML内容是否完整

### 5. 性能优化建议

#### 如果HTML文件很大（>5MB）

1. **优化文档内容：**
   - 压缩图片
   - 减少不必要的格式
   - 删除多余内容

2. **服务器端优化：**
   - 启用Gzip压缩
   - 使用CDN加速
   - 考虑分页加载

#### 如果请求很慢

1. **检查服务器性能：**
   - CPU使用率
   - 内存使用率
   - 磁盘IO

2. **检查网络：**
   - 服务器带宽
   - 网络延迟
   - 防火墙设置

### 6. 快速诊断命令

在浏览器控制台中运行：

```javascript
// 查看当前性能数据
console.log(window.previewPerf || '性能数据未记录');

// 手动测试预览接口
fetch('/documents/YOUR_DOCUMENT_ID/preview')
  .then(r => {
    console.log('状态:', r.status);
    console.log('大小:', r.headers.get('X-Content-Size-KB'), 'KB');
    return r.text();
  })
  .then(html => {
    console.log('HTML长度:', html.length, '字符');
    console.log('HTML大小:', (html.length / 1024).toFixed(2), 'KB');
  });
```

### 7. 联系支持

如果问题持续存在，请提供以下信息：

1. **性能摘要**（控制台中的性能日志）
2. **网络请求详情**（Network标签页截图）
3. **错误信息**（如果有）
4. **文档大小**（原始文档和HTML文件）
5. **浏览器信息**（浏览器类型和版本）

---

## 📊 性能基准参考

- **正常情况**：总耗时 < 3秒
- **较慢**：总耗时 3-10秒
- **很慢**：总耗时 > 10秒（需要优化）

### 各步骤正常耗时参考

- 请求响应：< 1秒
- 读取HTML：< 1秒（取决于文件大小）
- 创建Blob：< 100ms
- iframe加载：< 2秒

---

## 🔧 临时解决方案

如果预览一直加载不出来，可以：

1. **刷新页面重试**
2. **检查文档是否已处理完成**（返回主页查看状态）
3. **尝试直接访问预览接口**：`/documents/{id}/preview`
4. **清除浏览器缓存后重试**





