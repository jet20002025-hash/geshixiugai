# 服务启动失败排查 - status=3/NOTIMPLEMENTED

## 问题症状

服务一直重启，状态码 `status=3/NOTIMPLEMENTED`，这表示 Gunicorn worker 启动失败。

## 排查步骤

### 1. 停止服务，避免无限重启

```bash
sudo systemctl stop geshixiugai
```

### 2. 查看详细的错误日志

```bash
# 查看最近的完整日志（包含错误堆栈）
sudo journalctl -u geshixiugai -n 100 --no-pager | grep -A 20 -B 5 "Error\|Exception\|Traceback\|Failed"
```

### 3. 手动测试应用导入

```bash
cd /var/www/geshixiugai
source venv/bin/activate
python -c "from backend.app.main import app; print('✅ 应用导入成功')"
```

如果这里报错，说明代码有问题。

### 4. 手动测试 Gunicorn

```bash
cd /var/www/geshixiugai
source venv/bin/activate
gunicorn -c gunicorn_config.py backend.app.main:app
```

这会显示详细的错误信息。

### 5. 检查最近的代码更改

```bash
cd /var/www/geshixiugai
git log --oneline -5
git diff HEAD~1 HEAD -- backend/app/
```

### 6. 检查依赖

```bash
cd /var/www/geshixiugai
source venv/bin/activate
pip list | grep -E "weasyprint|fastapi|gunicorn|python-docx"
```

### 7. 重新安装依赖（如果需要）

```bash
cd /var/www/geshixiugai
source venv/bin/activate
pip install -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple
```

## 常见原因

### 原因1: 代码语法错误

**检查**:
```bash
python -m py_compile backend/app/main.py
python -m py_compile backend/app/api/*.py
python -m py_compile backend/app/services/*.py
```

### 原因2: 导入错误

**检查**:
```bash
python -c "from backend.app.main import app"
```

### 原因3: 依赖缺失

**检查**:
```bash
pip install -r requirements.txt
```

### 原因4: 环境变量缺失

**检查**:
```bash
cat .env | grep -v "^#" | grep -v "^$"
```

## 快速修复

```bash
# 1. 停止服务
sudo systemctl stop geshixiugai

# 2. 更新代码
cd /var/www/geshixiugai
git pull origin main

# 3. 激活虚拟环境
source venv/bin/activate

# 4. 重新安装依赖
pip install -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple

# 5. 测试应用
python -c "from backend.app.main import app; print('✅ 成功')"

# 6. 如果测试成功，启动服务
sudo systemctl start geshixiugai

# 7. 查看状态
sudo systemctl status geshixiugai
```




