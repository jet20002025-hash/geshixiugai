# 502 Bad Gateway 错误快速修复指南

## 问题诊断

502 Bad Gateway 通常表示：
1. 后端服务（Gunicorn）没有运行
2. 后端服务崩溃了
3. Nginx 无法连接到后端服务

## 快速修复步骤

### 1. 检查服务状态

```bash
sudo systemctl status geshixiugai
```

如果显示 `inactive` 或 `failed`，需要重启服务。

### 2. 查看服务日志

```bash
# 查看最近的错误日志
sudo journalctl -u geshixiugai -n 50 --no-pager

# 实时查看日志
sudo journalctl -u geshixiugai -f
```

### 3. 重启服务

```bash
sudo systemctl restart geshixiugai
sudo systemctl status geshixiugai
```

### 4. 如果重启失败，检查代码

```bash
cd /var/www/geshixiugai

# 检查代码是否最新
git pull origin main

# 检查虚拟环境
source venv/bin/activate
python -c "from backend.app.main import app; print('✅ 应用导入成功')"
```

### 5. 如果应用导入失败

```bash
# 重新安装依赖
pip install -r requirements.txt

# 或者使用国内镜像
pip install -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple
```

### 6. 手动测试 Gunicorn

```bash
cd /var/www/geshixiugai
source venv/bin/activate
gunicorn -c gunicorn_config.py backend.app.main:app
```

如果手动启动成功，说明代码没问题，可能是 systemd 配置问题。

### 7. 检查 Nginx 配置

```bash
# 检查 Nginx 状态
sudo systemctl status nginx

# 检查 Nginx 配置
sudo nginx -t

# 如果配置有问题，重启 Nginx
sudo systemctl restart nginx
```

### 8. 检查端口占用

```bash
# 检查 8000 端口是否被占用
sudo netstat -tlnp | grep 8000

# 或者使用 ss
sudo ss -tlnp | grep 8000
```

## 常见错误和解决方案

### 错误1: ModuleNotFoundError

**症状**: 日志显示 `ModuleNotFoundError: No module named 'xxx'`

**解决**:
```bash
source venv/bin/activate
pip install -r requirements.txt
```

### 错误2: ImportError

**症状**: 日志显示 `ImportError: cannot import name 'xxx'`

**解决**:
```bash
# 检查代码是否有语法错误
python -m py_compile backend/app/main.py

# 更新代码
git pull origin main
```

### 错误3: 端口被占用

**症状**: `Address already in use`

**解决**:
```bash
# 查找占用端口的进程
sudo lsof -i :8000

# 杀死进程
sudo kill -9 <PID>
```

### 错误4: 权限问题

**症状**: `Permission denied`

**解决**:
```bash
# 检查文件权限
ls -la /var/www/geshixiugai

# 修复权限（如果需要）
sudo chown -R admin:admin /var/www/geshixiugai
```

## 完整重启流程

```bash
# 1. 停止服务
sudo systemctl stop geshixiugai

# 2. 更新代码
cd /var/www/geshixiugai
git pull origin main

# 3. 激活虚拟环境并更新依赖
source venv/bin/activate
pip install -r requirements.txt

# 4. 测试应用导入
python -c "from backend.app.main import app; print('✅ 应用导入成功')"

# 5. 启动服务
sudo systemctl start geshixiugai

# 6. 检查状态
sudo systemctl status geshixiugai

# 7. 查看日志
sudo journalctl -u geshixiugai -n 50 --no-pager
```

## 如果还是不行

请提供以下信息：
1. `sudo systemctl status geshixiugai` 的输出
2. `sudo journalctl -u geshixiugai -n 50 --no-pager` 的输出
3. `python -c "from backend.app.main import app"` 的输出（如果有错误）


