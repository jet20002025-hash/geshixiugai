# é˜¿é‡Œäº‘æœåŠ¡å™¨éƒ¨ç½²è¯´æ˜

## ğŸ¯ å…³äºæ–‡ä»¶å¤§å°é™åˆ¶

### âœ… å¥½æ¶ˆæ¯ï¼šæ²¡æœ‰ Vercel çš„ 4.5MB é™åˆ¶ï¼

å¦‚æœéƒ¨ç½²åˆ°é˜¿é‡Œäº‘æœåŠ¡å™¨ï¼ˆECSï¼‰ï¼Œ**ä¸ä¼šæœ‰ Vercel çš„ 4.5MB é™åˆ¶**ã€‚

ä½ å¯ä»¥ï¼š
- âœ… æ”¯æŒ **20MBã€50MB ç”šè‡³æ›´å¤§çš„æ–‡ä»¶**
- âœ… å®Œå…¨æ§åˆ¶æœåŠ¡å™¨é…ç½®
- âœ… ä¸å—ç¬¬ä¸‰æ–¹å¹³å°é™åˆ¶

---

## ğŸ“‹ éœ€è¦é…ç½®çš„å†…å®¹

### 1. Web æœåŠ¡å™¨é…ç½®ï¼ˆNginx æˆ– Apacheï¼‰

#### å¦‚æœä½¿ç”¨ Nginx

ç¼–è¾‘ Nginx é…ç½®æ–‡ä»¶ï¼ˆé€šå¸¸æ˜¯ `/etc/nginx/nginx.conf` æˆ– `/etc/nginx/sites-available/default`ï¼‰ï¼š

```nginx
http {
    # è®¾ç½®å®¢æˆ·ç«¯è¯·æ±‚ä½“å¤§å°é™åˆ¶ï¼ˆä¾‹å¦‚ 50MBï¼‰
    client_max_body_size 50m;
    
    # å…¶ä»–é…ç½®...
}
```

**è¯´æ˜**ï¼š
- `client_max_body_size` æ§åˆ¶å…è®¸ä¸Šä¼ çš„æœ€å¤§æ–‡ä»¶å¤§å°
- å¯ä»¥è®¾ç½®ä¸º `50m`ï¼ˆ50MBï¼‰ã€`100m`ï¼ˆ100MBï¼‰ç­‰
- æ ¹æ®ä½ çš„éœ€æ±‚è°ƒæ•´

**é‡å¯ Nginx**ï¼š
```bash
sudo nginx -t  # æµ‹è¯•é…ç½®
sudo systemctl reload nginx  # é‡æ–°åŠ è½½é…ç½®
```

#### å¦‚æœä½¿ç”¨ Apache

ç¼–è¾‘ Apache é…ç½®æ–‡ä»¶ï¼ˆé€šå¸¸æ˜¯ `/etc/apache2/apache2.conf` æˆ–è™šæ‹Ÿä¸»æœºé…ç½®ï¼‰ï¼š

```apache
<Directory /var/www/html>
    # è®¾ç½®è¯·æ±‚ä½“å¤§å°é™åˆ¶ï¼ˆä¾‹å¦‚ 50MBï¼‰
    LimitRequestBody 52428800  # 50MB = 50 * 1024 * 1024 å­—èŠ‚
</Directory>
```

**é‡å¯ Apache**ï¼š
```bash
sudo apache2ctl configtest  # æµ‹è¯•é…ç½®
sudo systemctl reload apache2  # é‡æ–°åŠ è½½é…ç½®
```

---

### 2. Python/FastAPI é…ç½®

#### Uvicorn é…ç½®

å¦‚æœä½¿ç”¨ Uvicorn è¿è¡Œ FastAPIï¼š

```python
# å¯åŠ¨å‘½ä»¤
uvicorn app.main:app --host 0.0.0.0 --port 8000 --limit-max-requests 1000
```

æˆ–è€…åˆ›å»ºé…ç½®æ–‡ä»¶ `uvicorn_config.py`ï¼š

```python
# uvicorn_config.py
import multiprocessing

workers = multiprocessing.cpu_count() * 2 + 1
bind = "0.0.0.0:8000"
limit_request_line = 8190
limit_request_fields = 100
limit_request_field_size = 8190
```

#### Gunicorn é…ç½®ï¼ˆæ¨èç”¨äºç”Ÿäº§ç¯å¢ƒï¼‰

åˆ›å»º `gunicorn_config.py`ï¼š

```python
# gunicorn_config.py
import multiprocessing

bind = "0.0.0.0:8000"
workers = multiprocessing.cpu_count() * 2 + 1
worker_class = "uvicorn.workers.UvicornWorker"
timeout = 120
keepalive = 5
max_requests = 1000
max_requests_jitter = 50
```

å¯åŠ¨å‘½ä»¤ï¼š
```bash
gunicorn -c gunicorn_config.py app.main:app
```

---

### 3. ä»£ç ä¸­çš„é™åˆ¶

åœ¨ `backend/app/api/documents.py` ä¸­ï¼Œå¯ä»¥è®¾ç½®æ›´å¤§çš„é™åˆ¶ï¼š

```python
# é˜¿é‡Œäº‘æœåŠ¡å™¨ï¼šå¯ä»¥è®¾ç½®æ›´å¤§çš„é™åˆ¶
MAX_FILE_SIZE = 50 * 1024 * 1024  # 50 MB
# æˆ–
MAX_FILE_SIZE = 100 * 1024 * 1024  # 100 MB
```

**æ³¨æ„**ï¼šç¡®ä¿ä»£ç ä¸­çš„é™åˆ¶ â‰¤ Web æœåŠ¡å™¨ï¼ˆNginx/Apacheï¼‰çš„é™åˆ¶ã€‚

---

## ğŸš€ éƒ¨ç½²æ­¥éª¤

### 1. å‡†å¤‡æœåŠ¡å™¨

- è´­ä¹°é˜¿é‡Œäº‘ ECS å®ä¾‹
- é€‰æ‹©æ“ä½œç³»ç»Ÿï¼ˆæ¨è Ubuntu 22.04 æˆ– CentOS 7+ï¼‰
- é…ç½®å®‰å…¨ç»„ï¼ˆå¼€æ”¾ 80ã€443ã€8000 ç«¯å£ï¼‰

### 2. å®‰è£…ä¾èµ–

```bash
# æ›´æ–°ç³»ç»Ÿ
sudo apt update && sudo apt upgrade -y

# å®‰è£… Python 3.12
sudo apt install python3.12 python3.12-venv python3-pip -y

# å®‰è£… Nginx
sudo apt install nginx -y

# å®‰è£…å…¶ä»–ä¾èµ–
sudo apt install git build-essential -y
```

### 3. éƒ¨ç½²ä»£ç 

```bash
# å…‹éš†ä»£ç 
cd /var/www
sudo git clone https://github.com/jet20002025-hash/geshixiugai.git geshixiugai
cd geshixiugai

# åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ
python3.12 -m venv venv
source venv/bin/activate

# å®‰è£…ä¾èµ–
pip install -r requirements.txt
```

### 4. é…ç½®ç¯å¢ƒå˜é‡

åˆ›å»º `.env` æ–‡ä»¶ï¼š

```bash
# .env
R2_ACCOUNT_ID=ä½ çš„R2è´¦æˆ·ID
R2_ACCESS_KEY_ID=ä½ çš„R2è®¿é—®å¯†é’¥ID
R2_SECRET_ACCESS_KEY=ä½ çš„R2å¯†é’¥
R2_BUCKET_NAME=word-formatter-storage
# æˆ–ä½¿ç”¨ Supabase
SUPABASE_URL=https://ä½ çš„é¡¹ç›®ID.supabase.co
SUPABASE_KEY=ä½ çš„service_role key
SUPABASE_BUCKET=word-formatter-storage
```

### 5. é…ç½® Nginx åå‘ä»£ç†

åˆ›å»º Nginx é…ç½®æ–‡ä»¶ `/etc/nginx/sites-available/geshixiugai`ï¼š

```nginx
server {
    listen 80;
    server_name geshixiugai.cn;  # ä½ çš„åŸŸå

    # è®¾ç½®è¯·æ±‚ä½“å¤§å°é™åˆ¶ï¼ˆ50MBï¼‰
    client_max_body_size 50m;

    location / {
        proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # å¢åŠ è¶…æ—¶æ—¶é—´ï¼ˆç”¨äºå¤§æ–‡ä»¶ä¸Šä¼ ï¼‰
        proxy_connect_timeout 300s;
        proxy_send_timeout 300s;
        proxy_read_timeout 300s;
    }
}
```

å¯ç”¨é…ç½®ï¼š
```bash
sudo ln -s /etc/nginx/sites-available/geshixiugai /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl reload nginx
```

### 6. é…ç½® SSL è¯ä¹¦ï¼ˆHTTPSï¼‰

ä½¿ç”¨ Let's Encrypt å…è´¹è¯ä¹¦ï¼š

```bash
sudo apt install certbot python3-certbot-nginx -y
sudo certbot --nginx -d geshixiugai.cn
```

### 7. é…ç½®ç³»ç»ŸæœåŠ¡ï¼ˆSystemdï¼‰

åˆ›å»ºæœåŠ¡æ–‡ä»¶ `/etc/systemd/system/geshixiugai.service`ï¼š

```ini
[Unit]
Description=Word Formatter API
After=network.target

[Service]
User=www-data
Group=www-data
WorkingDirectory=/var/www/geshixiugai
Environment="PATH=/var/www/geshixiugai/venv/bin"
ExecStart=/var/www/geshixiugai/venv/bin/gunicorn -c gunicorn_config.py backend.app.main:app
Restart=always

[Install]
WantedBy=multi-user.target
```

å¯åŠ¨æœåŠ¡ï¼š
```bash
sudo systemctl daemon-reload
sudo systemctl enable geshixiugai
sudo systemctl start geshixiugai
sudo systemctl status geshixiugai
```

---

## ğŸ“Š å¯¹æ¯”ï¼šVercel vs é˜¿é‡Œäº‘

| ç‰¹æ€§ | Vercel | é˜¿é‡Œäº‘ ECS |
|------|--------|-----------|
| **æ–‡ä»¶å¤§å°é™åˆ¶** | 4.5 MBï¼ˆæ— æ³•ä¿®æ”¹ï¼‰ | å¯é…ç½®ï¼ˆ50MB+ï¼‰ |
| **æˆæœ¬** | å…è´¹/ä»˜è´¹è®¡åˆ’ | æŒ‰éœ€ä»˜è´¹ |
| **æ§åˆ¶æƒ** | æœ‰é™ | å®Œå…¨æ§åˆ¶ |
| **éƒ¨ç½²éš¾åº¦** | ç®€å• | ä¸­ç­‰ |
| **æ‰©å±•æ€§** | è‡ªåŠ¨æ‰©å±• | æ‰‹åŠ¨é…ç½® |
| **å¤‡æ¡ˆè¦æ±‚** | ä¸éœ€è¦ | éœ€è¦ï¼ˆå›½å†…æœåŠ¡å™¨ï¼‰ |
| **åŸŸå** | è‡ªåŠ¨æä¾› | éœ€è¦è‡ªå·±é…ç½® |

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. å¤‡æ¡ˆè¦æ±‚

å¦‚æœä½¿ç”¨å›½å†…é˜¿é‡Œäº‘æœåŠ¡å™¨ï¼š
- âœ… **å¿…é¡»è¿›è¡Œ ICP å¤‡æ¡ˆ**
- âœ… ä½ å·²ç»è´­ä¹°äº†æœåŠ¡å™¨å’ŒåŸŸå `geshixiugai.cn`
- âœ… å¯ä»¥æŒ‰ç…§ä¹‹å‰çš„å¤‡æ¡ˆæ­¥éª¤è¿›è¡Œå¤‡æ¡ˆ

### 2. å®‰å…¨ç»„é…ç½®

åœ¨é˜¿é‡Œäº‘æ§åˆ¶å°é…ç½®å®‰å…¨ç»„ï¼š
- å¼€æ”¾ 80 ç«¯å£ï¼ˆHTTPï¼‰
- å¼€æ”¾ 443 ç«¯å£ï¼ˆHTTPSï¼‰
- å¼€æ”¾ 8000 ç«¯å£ï¼ˆå¦‚æœéœ€è¦ç›´æ¥è®¿é—® APIï¼‰

### 3. é˜²ç«å¢™é…ç½®

```bash
# Ubuntu/Debian
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp
sudo ufw enable
```

### 4. æ€§èƒ½ä¼˜åŒ–

- ä½¿ç”¨ Gunicorn + Uvicorn workersï¼ˆå¤šè¿›ç¨‹ï¼‰
- é…ç½® Nginx ç¼“å­˜
- ä½¿ç”¨å¯¹è±¡å­˜å‚¨ï¼ˆR2/Supabaseï¼‰å­˜å‚¨æ–‡ä»¶
- é…ç½® CDN åŠ é€Ÿï¼ˆå¯é€‰ï¼‰

---

## ğŸ”§ æ¨èé…ç½®

### æ–‡ä»¶å¤§å°é™åˆ¶å»ºè®®

```nginx
# Nginx
client_max_body_size 50m;  # 50MBï¼ˆé€‚åˆæ¯•ä¸šè®ºæ–‡ï¼‰
```

```python
# Python ä»£ç 
MAX_FILE_SIZE = 50 * 1024 * 1024  # 50 MB
```

### æœåŠ¡å™¨è§„æ ¼å»ºè®®

- **CPU**ï¼š2 æ ¸
- **å†…å­˜**ï¼š4 GB
- **å¸¦å®½**ï¼š5 Mbpsï¼ˆæ ¹æ®è®¿é—®é‡è°ƒæ•´ï¼‰
- **ç³»ç»Ÿç›˜**ï¼š40 GB SSD

---

## ğŸ“ æ€»ç»“

### âœ… æ”¹ç”¨é˜¿é‡Œäº‘æœåŠ¡å™¨çš„ä¼˜åŠ¿

1. **æ²¡æœ‰ 4.5MB é™åˆ¶**ï¼šå¯ä»¥æ”¯æŒæ›´å¤§çš„æ–‡ä»¶
2. **å®Œå…¨æ§åˆ¶**ï¼šå¯ä»¥è‡ªå®šä¹‰æ‰€æœ‰é…ç½®
3. **æˆæœ¬å¯æ§**ï¼šæŒ‰éœ€ä»˜è´¹ï¼Œä¸éœ€è¦æ—¶åœæ­¢
4. **é€‚åˆå›½å†…ç”¨æˆ·**ï¼šè®¿é—®é€Ÿåº¦å¿«ï¼Œæ”¯æŒå¤‡æ¡ˆ

### ğŸ“‹ éœ€è¦åšçš„äº‹æƒ…

1. âœ… é…ç½® Nginx/Apache çš„è¯·æ±‚ä½“å¤§å°é™åˆ¶
2. âœ… ä¿®æ”¹ä»£ç ä¸­çš„æ–‡ä»¶å¤§å°é™åˆ¶
3. âœ… é…ç½® SSL è¯ä¹¦ï¼ˆHTTPSï¼‰
4. âœ… é…ç½®ç³»ç»ŸæœåŠ¡ï¼ˆè‡ªåŠ¨å¯åŠ¨ï¼‰
5. âœ… å®Œæˆ ICP å¤‡æ¡ˆï¼ˆå¦‚æœä½¿ç”¨å›½å†…æœåŠ¡å™¨ï¼‰

---

**å¦‚æœå†³å®šè¿ç§»åˆ°é˜¿é‡Œäº‘ï¼Œæˆ‘å¯ä»¥å¸®ä½ å‡†å¤‡è¯¦ç»†çš„éƒ¨ç½²è„šæœ¬å’Œé…ç½®æ–‡ä»¶ï¼**

