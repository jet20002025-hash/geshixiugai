# 支付宝签名验证问题排查指南

## 错误信息

如果遇到以下错误：
```
错误代码: invalid-signature
错误原因: 验签出错，建议检查签名字符串或签名私钥与应用公钥是否匹配
```

## 问题原因

这个错误表示**应用私钥和应用公钥不匹配**。

### 关键概念

1. **应用私钥** (`ALIPAY_PRIVATE_KEY`)：用于签名请求
2. **应用公钥**：需要上传到支付宝，用于支付宝验证我们的签名
3. **支付宝公钥** (`ALIPAY_PUBLIC_KEY`)：用于验证支付宝的响应

**重要**：支付宝验证我们发送的签名时，使用的是我们上传到支付宝的**应用公钥**。如果签名验证失败，说明：
- 我们使用的**应用私钥**和上传到支付宝的**应用公钥**不匹配

## 解决步骤

### 步骤 1：确认密钥对匹配

1. **检查应用私钥和应用公钥是否是一对**
   - 应用私钥和应用公钥必须是从同一个密钥对生成的
   - 如果私钥和公钥不匹配，签名验证会失败

2. **如何验证密钥匹配**
   - 如果你有密钥生成工具，可以重新生成一对新的密钥
   - 或者使用在线工具验证：https://opendocs.alipay.com/common/02kkv7

### 步骤 2：重新生成密钥对（推荐）

如果无法确认密钥是否匹配，建议重新生成：

1. **使用支付宝密钥生成工具**
   - 访问：https://opendocs.alipay.com/common/02kkv7
   - 选择：RSA2、2048位、PKCS8格式
   - 点击"生成密钥"

2. **保存新密钥**
   - **应用私钥**：复制保存，这是 `ALIPAY_PRIVATE_KEY`
   - **应用公钥**：复制保存，需要上传到支付宝

3. **上传应用公钥到支付宝**
   - 登录支付宝开放平台
   - 进入应用详情 → 开发信息 → 接口加签方式 → 设置
   - 选择"公钥"方式
   - 粘贴新的**应用公钥**（包括 BEGIN/END 标记）
   - 点击"保存"

4. **获取支付宝公钥**
   - 上传应用公钥后，支付宝会生成**支付宝公钥**
   - 复制保存，这是 `ALIPAY_PUBLIC_KEY`

### 步骤 3：更新 Vercel 环境变量

在 Vercel Dashboard 中更新以下环境变量：

```
ALIPAY_APP_ID=你的应用ID（不变）
ALIPAY_PRIVATE_KEY=新的应用私钥（完整内容，包括BEGIN/END标记）
ALIPAY_PUBLIC_KEY=新的支付宝公钥（完整内容）
ALIPAY_GATEWAY=https://openapi.alipay.com/gateway.do
ALIPAY_SIGN_TYPE=RSA2
```

**重要提示**：
- 私钥和公钥必须包含完整的 BEGIN/END 标记
- 如果密钥是多行的，确保在 Vercel 环境变量中正确换行
- 更新后需要重新部署

### 步骤 4：验证密钥格式

确保密钥格式正确：

**应用私钥格式**：
```
-----BEGIN PRIVATE KEY-----
MIIEvQIBADANBgkqhkiG9w0BAQEFAASCBKcwggSjAgEAAoIBAQC...
（多行内容）
-----END PRIVATE KEY-----
```

**支付宝公钥格式**（如果没有 BEGIN/END 标记，系统会自动添加）：
```
MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA...
（长字符串，可能没有 BEGIN/END 标记）
```

## 常见错误

### 错误 1：密钥格式不正确

**症状**：密钥没有 BEGIN/END 标记

**解决**：系统会自动添加标记，但建议在环境变量中直接使用完整格式

### 错误 2：密钥不匹配

**症状**：签名验证失败

**解决**：重新生成密钥对，确保私钥和公钥匹配

### 错误 3：上传了错误的公钥

**症状**：签名验证失败

**解决**：
1. 确认上传到支付宝的是**应用公钥**（不是支付宝公钥）
2. 确认应用公钥和应用私钥是配对的

## 验证步骤

更新环境变量后：

1. **重新部署 Vercel 项目**
2. **测试支付功能**
3. **查看 Vercel 日志**，确认没有签名错误

## 联系支持

如果问题仍然存在：

1. 检查 Vercel 日志中的详细错误信息
2. 确认所有环境变量都已正确设置
3. 确认密钥格式正确
4. 确认应用公钥已正确上传到支付宝

