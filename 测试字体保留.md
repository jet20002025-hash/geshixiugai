# 测试字体保留功能

## 步骤 1：在服务器上诊断原始文档

```bash
cd /var/www/geshixiugai
git pull origin main

# 上传你的 Word 文档到服务器（假设文件名为 test.docx）
# 然后运行诊断脚本
python3 诊断字体问题.py /path/to/your/test.docx
```

这个脚本会显示：
- 文档中使用的所有字体
- 每个段落使用的字体
- 哪些段落包含多种字体

## 步骤 2：查看转换日志

在服务器上查看格式应用的日志：

```bash
# 查看最近的转换日志
sudo journalctl -u geshixiugai -n 200 | grep -E "\[格式应用\]|字体"

# 或者查看错误日志
tail -f /var/log/geshixiugai/error.log | grep -E "格式应用|字体"
```

你应该能看到类似这样的日志：
- `[格式应用] 段落 X 检测到多种字体: {'楷体', '宋体'}，保留各自字体`
- `[格式应用] 段落 X 保留字体：楷体`

## 步骤 3：测试转换

1. 访问：https://www.geshixiugai.cn
2. 上传你的 Word 文档
3. 等待转换完成
4. 下载转换后的文档
5. 在 Word 中打开，检查字体是否正确保留

## 步骤 4：如果字体仍然被统一

如果转换后字体仍然被统一，请检查：

### 4.1 检查字体提取

在服务器上运行诊断脚本，确认原始文档中的字体是否被正确提取：

```bash
python3 诊断字体问题.py /var/www/geshixiugai/storage/documents/<document_id>/original.docx
```

### 4.2 检查转换后的文档

```bash
python3 诊断字体问题.py /var/www/geshixiugai/storage/documents/<document_id>/preview.docx
```

对比两个文档的字体使用情况。

### 4.3 查看详细日志

```bash
# 查看完整的格式应用日志
sudo journalctl -u geshixiugai -n 500 | grep "格式应用"
```

## 常见问题

### Q: 为什么所有段落都显示为同一种字体？

A: 可能的原因：
1. 原始文档中所有段落确实使用同一种字体
2. 字体提取失败，没有正确提取到字体信息
3. 字体名称不匹配（例如 "KaiTi" vs "楷体"）

**解决方法：**
- 运行诊断脚本检查原始文档
- 查看日志确认字体提取情况
- 如果字体名称不匹配，可能需要调整字体识别逻辑

### Q: 如何确认字体是否被正确保留？

A: 
1. 在 Word 中选中文本，查看字体工具栏显示的字体名称
2. 使用诊断脚本对比转换前后的文档
3. 查看日志中的字体保留信息

### Q: 支持的字体有哪些？

A: 目前支持：
- 黑体（SimHei, 黑体, STHeiti）
- 宋体（SimSun, 宋体, STSong）
- 楷体（KaiTi, 楷体, STKaiti）
- Times New Roman

如果文档使用了其他字体，会被替换为默认的宋体。

