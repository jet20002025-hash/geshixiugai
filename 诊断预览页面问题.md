# 预览页面问题诊断指南

## 问题：预览界面一直转圈圈，没有输出

### 步骤1：确认你在预览页面

预览页面的URL应该是：
- `https://www.geshixiugai.cn/web/preview.html?id=文档ID`
- 或 `https://www.geshixiugai.cn/web/preview.html?document_id=文档ID`

**不是**主页（`/web/` 或 `/web/index.html`）

### 步骤2：打开浏览器开发者工具

1. 按 `F12` 或右键点击页面 → "检查" / "Inspect"
2. 切换到 **Console（控制台）** 标签
3. 刷新预览页面

### 步骤3：查看控制台输出

预览页面应该输出以下日志：

```
========== 页面初始化 ==========
文档就绪状态: complete
文档ID: xxx
当前URL: https://...
========== 开始加载预览 ==========
文档ID: xxx
当前URL: https://...
时间戳: ...
开始加载预览，文档ID: xxx
✅ 加载元素已显示
✅ 加载步骤元素已更新
```

### 步骤4：检查网络请求

1. 在开发者工具中切换到 **Network（网络）** 标签
2. 刷新预览页面
3. 查找以下请求：
   - `/documents/{文档ID}/preview-docx` - Word文档预览
   - `/documents/{文档ID}/preview` - PDF/HTML预览

**检查请求状态：**
- ✅ **200 OK** - 请求成功
- ❌ **404 Not Found** - 文档不存在
- ❌ **500 Internal Server Error** - 服务器错误
- ❌ **502 Bad Gateway** - Nginx配置问题
- ❌ **504 Gateway Timeout** - 请求超时
- ❌ **Failed to fetch** - 网络连接失败

### 步骤5：常见问题和解决方案

#### 问题1：控制台没有任何输出

**可能原因：**
- JavaScript文件未加载
- 页面路径错误

**解决方案：**
```javascript
// 在控制台运行以下代码检查
console.log('文档ID:', new URLSearchParams(window.location.search).get('id'));
console.log('当前URL:', window.location.href);
```

#### 问题2：显示"缺少文档ID参数"

**解决方案：**
- 确保URL包含文档ID：`/web/preview.html?id=文档ID`
- 从主页点击"预览"按钮，不要直接输入URL

#### 问题3：请求返回404

**可能原因：**
- 文档ID不存在
- 文档尚未处理完成

**解决方案：**
- 返回主页重新上传文档
- 等待文档处理完成后再预览

#### 问题4：请求返回500或502

**可能原因：**
- 后端服务错误
- Nginx配置问题

**解决方案：**
```bash
# 检查后端服务状态
sudo systemctl status geshixiugai

# 查看后端日志
sudo journalctl -u geshixiugai -n 50

# 检查Nginx状态
sudo systemctl status nginx

# 重启服务
sudo systemctl restart geshixiugai
sudo systemctl restart nginx
```

#### 问题5：请求超时

**可能原因：**
- 文档太大，处理时间过长
- 服务器负载过高

**解决方案：**
- 等待更长时间（大文档可能需要30-60秒）
- 检查服务器资源使用情况

### 步骤6：手动测试API

在浏览器控制台运行：

```javascript
// 替换为实际的文档ID
const docId = '你的文档ID';

// 测试预览API
fetch(`/documents/${docId}/preview`)
  .then(response => {
    console.log('状态:', response.status);
    console.log('Content-Type:', response.headers.get('content-type'));
    return response.blob();
  })
  .then(blob => {
    console.log('文件大小:', blob.size, 'bytes');
    console.log('文件类型:', blob.type);
  })
  .catch(error => {
    console.error('错误:', error);
  });
```

### 步骤7：检查页面元素

在控制台运行：

```javascript
// 检查关键元素是否存在
console.log('加载元素:', document.getElementById('loading'));
console.log('错误元素:', document.getElementById('error'));
console.log('预览容器:', document.getElementById('mainPreview'));
console.log('加载步骤:', document.getElementById('loadingStep'));
```

### 需要提供的信息

如果问题仍然存在，请提供：

1. **预览页面的完整URL**
2. **控制台的完整输出**（包括所有错误和警告）
3. **Network标签中的请求详情**（特别是 `/documents/{id}/preview` 请求）
4. **浏览器类型和版本**（Chrome、Firefox、Safari等）

### 快速修复尝试

如果页面一直转圈，可以尝试：

1. **强制刷新页面**：`Ctrl+Shift+R` (Windows) 或 `Cmd+Shift+R` (Mac)
2. **清除浏览器缓存**
3. **使用无痕模式**打开预览页面
4. **检查浏览器控制台**是否有JavaScript错误阻止了页面加载



