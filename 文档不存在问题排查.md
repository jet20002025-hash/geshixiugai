# 文档不存在问题排查指南

## 🔍 问题描述

点击"立即支付"后，提示"文档不存在"。

## ⚠️ 可能的原因

### 原因 1：Vercel Serverless Functions 无状态问题（最可能）

**问题**：
- Vercel 的 Serverless Functions 是无状态的
- 每次请求可能在不同的实例上执行
- 使用 `/tmp` 目录存储文件，但 `/tmp` 目录在函数实例之间**不共享**
- 文档上传时保存在一个实例的 `/tmp` 目录，但支付时可能在不同的实例上，找不到文件

**解决方案**：
需要使用持久化存储（如 Cloudflare R2）替代 `/tmp` 目录。

---

### 原因 2：文档 ID 传递错误

**问题**：
- 前端传递的 `document_id` 不正确
- 或 `document_id` 为空

**检查方法**：
1. 打开浏览器开发者工具（F12）
2. 查看 Network 标签
3. 找到支付请求（`/payments/mock`）
4. 检查请求体中的 `document_id` 是否正确

---

### 原因 3：文档未正确保存

**问题**：
- 文档上传时保存失败
- 或保存路径不正确

**检查方法**：
1. 查看 Vercel 日志
2. 查找文档上传时的日志
3. 确认文档是否成功保存

---

## 🔧 排查步骤

### 步骤 1：查看 Vercel 日志

1. 登录 Vercel Dashboard
2. 进入你的项目
3. 点击 **Functions** → **Logs**
4. 查找以下日志：
   - `[Mock Payment API]` 开头的日志
   - `[PaymentService]` 开头的日志

**关键信息**：
- `document_id` 的值
- `DOCUMENT_DIR` 的路径
- `DOCUMENT_DIR` 是否存在
- 所有文档目录列表

---

### 步骤 2：检查前端传递的 document_id

1. 打开浏览器开发者工具（F12）
2. 查看 Console 标签
3. 查找 `documentId` 相关的日志
4. 或查看 Network 标签，找到支付请求，检查请求体

---

### 步骤 3：验证文档是否存在

访问以下 URL 检查文档是否存在：

```
https://geshixiugai.org/documents/{document_id}
```

将 `{document_id}` 替换为实际的文档 ID。

如果返回 404，说明文档确实不存在。

---

## 💡 临时解决方案

### 方案 1：在同一会话中完成支付

**说明**：
- 文档上传和支付在短时间内完成
- 可能使用同一个函数实例
- 文件可能还在 `/tmp` 目录中

**操作**：
1. 上传文档后，**立即**点击支付
2. 不要等待太长时间
3. 如果还是失败，继续看下面的方案

---

### 方案 2：使用持久化存储（推荐）

**说明**：
- 使用 Cloudflare R2 或其他对象存储
- 文件保存在持久化存储中
- 所有函数实例都可以访问

**需要做的**：
1. 配置 Cloudflare R2
2. 修改代码使用 R2 存储
3. 重新部署

---

## 🚀 长期解决方案

### 使用 Cloudflare R2 存储

#### 1. 创建 R2 Bucket

1. 登录 Cloudflare Dashboard
2. 进入 R2 → Create bucket
3. 创建 bucket（如：`word-formatter-storage`）

#### 2. 创建 API Token

1. R2 → Manage R2 API Tokens → Create API Token
2. 保存：
   - `Account ID`
   - `Access Key ID`
   - `Secret Access Key`

#### 3. 配置环境变量

在 Vercel 中添加：

```
R2_ACCOUNT_ID=你的Account ID
R2_ACCESS_KEY_ID=你的Access Key ID
R2_SECRET_ACCESS_KEY=你的Secret Access Key
R2_BUCKET_NAME=word-formatter-storage
R2_ENDPOINT=https://你的Account ID.r2.cloudflarestorage.com
```

#### 4. 修改代码使用 R2

需要修改 `DocumentService` 和 `TemplateService` 使用 R2 存储。

---

## 📋 当前状态检查

我已经添加了详细的调试日志。请：

1. **等待部署完成**（约 1-3 分钟）
2. **再次测试支付**
3. **查看 Vercel 日志**，找到以下信息：
   - `[Mock Payment API]` 开头的日志
   - `document_id` 的值
   - `DOCUMENT_DIR` 的路径
   - 所有文档目录列表

4. **告诉我日志内容**，我会帮你进一步分析

---

## ❓ 常见问题

### Q1: 为什么本地测试正常，但部署后不行？

**A**: 
- 本地使用项目目录存储，文件持久化
- Vercel 使用 `/tmp` 目录，文件不持久化
- 这是 Serverless 无状态的特性

### Q2: 可以继续使用 `/tmp` 目录吗？

**A**: 
- 理论上可以，但不可靠
- 如果上传和支付在同一个实例上，可能可以
- 但不同实例之间无法共享文件
- **不推荐**，建议使用持久化存储

### Q3: 使用 R2 存储需要多长时间？

**A**: 
- 配置 R2：约 10 分钟
- 修改代码：约 30 分钟
- 测试部署：约 10 分钟
- **总计：约 1 小时**

---

## 🎯 下一步

1. **立即检查**：查看 Vercel 日志，找到调试信息
2. **告诉我结果**：把日志内容告诉我，我会帮你分析
3. **如果需要**：我可以帮你实现 R2 存储方案

**先查看日志，告诉我具体的错误信息！**

