# 支付宝配置检查清单

## ✅ 配置状态检查

根据你提供的 Vercel 环境变量信息，以下是配置检查：

### 已配置的环境变量

- ✅ `ALIPAY_APP_ID` - 已添加（2小时前）
- ✅ `ALIPAY_PRIVATE_KEY` - 已更新（3分钟前）
- ✅ `ALIPAY_PUBLIC_KEY` - 已更新（2分钟前）
- ✅ `ALIPAY_SIGN_TYPE` - 已添加（刚刚）
- ✅ `ALIPAY_GATEWAY` - 已添加（刚刚）

### 配置完整性检查

所有必需的环境变量都已配置！✅

---

## 🔍 详细配置检查

### 方法 1：使用调试端点（推荐）

部署完成后，访问以下 URL 检查配置：

```
https://geshixiugai.org/payments/debug/config
```

或者：

```
https://geshixiugai-app.vercel.app/payments/debug/config
```

**返回的配置信息包括**：

```json
{
  "alipay": {
    "app_id_exists": true/false,
    "app_id_preview": "2021****",
    "private_key_exists": true/false,
    "private_key_length": 数字,
    "private_key_has_begin": true/false,
    "public_key_exists": true/false,
    "public_key_length": 数字,
    "public_key_has_begin": true/false,
    "sign_type": "RSA2" 或 "未设置",
    "gateway": "https://openapi.alipay.com/gateway.do" 或 "未设置",
    "configured": true/false
  },
  "available_payment_methods": ["mock", "wechat", "alipay"]
}
```

### 方法 2：检查配置项

#### ✅ 1. ALIPAY_APP_ID

- **要求**：必须设置
- **格式**：数字字符串，如 `2021006109680085`
- **检查**：`app_id_exists: true`

#### ✅ 2. ALIPAY_PRIVATE_KEY

- **要求**：必须设置
- **格式**：应用私钥，应包含 `-----BEGIN PRIVATE KEY-----` 和 `-----END PRIVATE KEY-----`
- **检查**：
  - `private_key_exists: true`
  - `private_key_length: > 0`（通常 > 1000）
  - `private_key_has_begin: true`（推荐）

#### ✅ 3. ALIPAY_PUBLIC_KEY

- **要求**：必须设置
- **格式**：支付宝公钥（从支付宝获取的），可能没有 BEGIN/END 标记（系统会自动添加）
- **检查**：
  - `public_key_exists: true`
  - `public_key_length: > 0`（通常 > 200）
  - `public_key_has_begin: true/false`（都可以，系统会自动处理）

#### ✅ 4. ALIPAY_SIGN_TYPE

- **要求**：建议设置
- **格式**：`RSA2`
- **检查**：`sign_type: "RSA2"`

#### ✅ 5. ALIPAY_GATEWAY

- **要求**：建议设置
- **格式**：`https://openapi.alipay.com/gateway.do`
- **检查**：`gateway: "https://openapi.alipay.com/gateway.do"`

---

## ⚠️ 重要检查项

### 1. 密钥匹配检查

**关键问题**：如果之前遇到 `invalid-signature` 错误，必须确认：

- ✅ 应用私钥和应用公钥是配对的（从同一个密钥对生成）
- ✅ 应用公钥已正确上传到支付宝开放平台
- ✅ 支付宝公钥是从支付宝获取的（不是应用公钥）

### 2. 密钥格式检查

**应用私钥格式**（推荐）：
```
-----BEGIN PRIVATE KEY-----
MIIEvQIBADANBgkqhkiG9w0BAQEFAASCBKcwggSjAgEAAoIBAQC...
（多行内容）
-----END PRIVATE KEY-----
```

**支付宝公钥格式**（可以没有 BEGIN/END 标记）：
```
MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA...
（长字符串）
```

或者：
```
-----BEGIN PUBLIC KEY-----
MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA...
-----END PUBLIC KEY-----
```

---

## 🧪 测试步骤

### 步骤 1：等待部署完成

1. 更新环境变量后，Vercel 会自动重新部署
2. 等待部署完成（约 1-3 分钟）
3. 查看 Vercel Dashboard 确认部署状态为 "Ready"

### 步骤 2：检查配置

访问调试端点：
```
https://geshixiugai.org/payments/debug/config
```

确认：
- `alipay.configured: true`
- `available_payment_methods` 包含 `"alipay"`

### 步骤 3：测试支付

1. 上传文档
2. 选择"支付宝支付"
3. 点击"立即支付"
4. 检查是否能正常跳转到支付宝支付页面

---

## ❌ 如果配置检查失败

### 问题 1：`configured: false`

**可能原因**：
- 环境变量未正确设置
- 密钥为空或格式错误

**解决**：
1. 检查 Vercel 环境变量是否都已设置
2. 确认密钥值不为空
3. 重新部署

### 问题 2：`private_key_has_begin: false`

**可能原因**：
- 私钥格式不正确

**解决**：
- 系统会自动添加 BEGIN/END 标记
- 但建议在环境变量中直接使用完整格式

### 问题 3：支付时仍然报 `invalid-signature` 错误

**可能原因**：
- 应用私钥和应用公钥不匹配

**解决**：
1. 重新生成密钥对
2. 上传新的应用公钥到支付宝
3. 更新 Vercel 环境变量
4. 重新部署

---

## 📋 配置清单

完成以下检查：

- [ ] `ALIPAY_APP_ID` 已设置
- [ ] `ALIPAY_PRIVATE_KEY` 已设置（应用私钥）
- [ ] `ALIPAY_PUBLIC_KEY` 已设置（支付宝公钥）
- [ ] `ALIPAY_SIGN_TYPE` 已设置为 `RSA2`
- [ ] `ALIPAY_GATEWAY` 已设置为 `https://openapi.alipay.com/gateway.do`
- [ ] 应用公钥已上传到支付宝开放平台
- [ ] 应用私钥和应用公钥是配对的
- [ ] Vercel 部署已完成
- [ ] 调试端点显示 `configured: true`
- [ ] 支付功能测试通过

---

## 🎯 下一步

1. **等待 Vercel 部署完成**
2. **访问调试端点检查配置**：`https://geshixiugai.org/payments/debug/config`
3. **测试支付功能**
4. **如果仍有问题，查看 Vercel 日志**

配置看起来已经完整了！等待部署完成后，使用调试端点验证配置是否正确。

