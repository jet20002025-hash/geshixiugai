# 如何查看诊断日志

诊断日志会输出到服务器的日志文件中，可以通过以下几种方式查看：

## 📋 方法1：查看错误日志中的诊断信息（推荐）

诊断信息会输出到 `/var/log/geshixiugai/error.log` 文件中，包含 `[诊断]` 标记。

### 查看最近的诊断信息

```bash
# 查看最近的诊断信息（最后50条）
sudo grep "\[诊断\]" /var/log/geshixiugai/error.log | tail -n 50
```

### 查看完整的最后100行日志

```bash
sudo tail -n 100 /var/log/geshixiugai/error.log
```

---

## 📺 方法2：实时查看诊断日志

在上传文档时，实时查看诊断日志：

```bash
# 只查看诊断信息
sudo tail -f /var/log/geshixiugai/error.log | grep "\[诊断\]"

# 或者查看所有日志（包括诊断）
sudo tail -f /var/log/geshixiugai/error.log
```

**使用说明：**
- 执行命令后，日志会实时显示
- 上传文档时，会看到诊断信息输出
- 按 `Ctrl+C` 退出实时查看

---

## 🔍 方法3：查看 systemd 服务日志

如果错误日志文件不存在或为空，可以查看 systemd 服务日志：

```bash
# 查看最近的诊断信息
sudo journalctl -u geshixiugai -n 200 --no-pager | grep "\[诊断\]"

# 实时查看诊断日志
sudo journalctl -u geshixiugai -f | grep "\[诊断\]"
```

---

## 📝 方法4：使用脚本查看

项目根目录有一个脚本 `查看诊断日志.sh`，可以直接运行：

```bash
# 在项目根目录执行
./查看诊断日志.sh
```

---

## 🔎 诊断日志示例

诊断日志会显示类似以下内容：

```
[诊断] ========== 开始诊断：原始文档 ==========
[诊断] 找到诚信承诺，段落索引: 15, 文本: 诚信承诺
[诊断] 找到摘要，段落索引: 25, 文本: 摘要
[诊断] 诚信承诺和摘要之间的段落索引: 15 到 25
[诊断] 段落 20 有分页符 (paragraph_format.page_break_before): 
[诊断] 原始文档诊断结果: 有分页符
[诊断] 分页符位置: 1 个

[诊断] ========== 开始诊断：格式修改后的文档 ==========
[诊断] 格式修改后诊断结果: 有分页符
[诊断] 分页符位置: 1 个

[诊断] ========== 开始诊断：预览文档（带水印） ==========
[诊断] 预览文档诊断结果: 有分页符
[诊断] 分页符位置: 1 个

[诊断] ========== PDF生成后诊断 ==========
[诊断] PDF总页数: 50
[诊断] 第2页包含诚信承诺: True, 包含摘要: True
[诊断] ⚠️ 警告：PDF中诚信承诺和摘要在同一页！问题出现在Word转PDF过程中
```

---

## 🎯 根据诊断结果判断问题

### 情况1：原始文档就没有分页符

```
[诊断] ⚠️ 警告：原始文档中就没有分页符！
```

**解决方案：** 需要在原始文档中添加分页符，或者在代码中自动添加。

---

### 情况2：格式修改过程中丢失了分页符

```
[诊断] ⚠️ 警告：格式修改过程中丢失了分页符！
```

**解决方案：** 需要修复格式修改逻辑，确保不删除分页符。

---

### 情况3：Word转PDF过程中丢失了分页符

```
[诊断] ⚠️ 警告：PDF中诚信承诺和摘要在同一页！问题出现在Word转PDF过程中
```

**解决方案：** 需要修复PDF转换逻辑，或者在转换前确保Word文档中有分页符。

---

## 📌 快速命令汇总

```bash
# 1. 查看最近的诊断信息
sudo grep "\[诊断\]" /var/log/geshixiugai/error.log | tail -n 50

# 2. 实时查看诊断日志
sudo tail -f /var/log/geshixiugai/error.log | grep "\[诊断\]"

# 3. 查看完整错误日志（最后100行）
sudo tail -n 100 /var/log/geshixiugai/error.log

# 4. 查看 systemd 服务日志中的诊断信息
sudo journalctl -u geshixiugai -n 200 --no-pager | grep "\[诊断\]"
```

---

## ⚠️ 注意事项

1. **需要 sudo 权限**：查看日志文件需要管理员权限
2. **日志文件位置**：确保 `/var/log/geshixiugai/` 目录存在且有写权限
3. **日志轮转**：如果日志文件很大，可以使用 `tail` 命令查看最近的内容
4. **实时查看**：使用 `tail -f` 可以实时查看日志，适合调试时使用

---

**执行查看命令后，把诊断日志发给我，我会根据结果进行修复！** 🔧

