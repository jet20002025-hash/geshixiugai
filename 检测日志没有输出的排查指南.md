# 检测日志没有输出的排查指南

## 🔍 问题

执行 `sudo grep "\[检测\]" /var/log/geshixiugai/error.log | tail -n 50` 没有任何输出。

## ⚠️ 可能的原因

### 原因1：代码还没有更新

**检查方法：**
```bash
cd /var/www/geshixiugai
git pull origin main

# 检查代码是否包含检测功能
sudo grep -c "\[检测\]" backend/app/services/document_service.py
```

**如果输出是 0：**
- 说明代码还没有更新
- 需要执行 `git pull origin main` 和 `sudo systemctl restart geshixiugai`

---

### 原因2：服务还没有重启

即使代码更新了，服务也需要重启才能加载新代码。

**检查方法：**
```bash
# 检查服务状态
sudo systemctl status geshixiugai

# 检查服务启动时间
sudo systemctl show -p ActiveEnterTimestamp geshixiugai
```

**如果服务启动时间早于代码更新时间：**
- 需要重启服务：`sudo systemctl restart geshixiugai`

---

### 原因3：还没有处理过文档

**检测功能只在处理文档时才会运行！**

如果还没有上传过文档，日志中不会有检测信息。

**解决方法：**
1. 访问网站
2. 上传一个包含"诚信承诺"和"摘要"的文档
3. 等待文档处理完成
4. 然后查看检测日志

---

### 原因4：检测代码没有执行

可能因为：
- 文档处理流程中断
- 代码执行出错
- 检测条件不满足

**检查方法：**
```bash
# 查看所有日志，检查是否有错误
sudo tail -n 100 /var/log/geshixiugai/error.log

# 查看是否有其他错误信息
sudo grep -i "error\|exception\|traceback" /var/log/geshixiugai/error.log | tail -n 20
```

---

## 🔧 完整排查步骤

### 步骤1：检查代码是否已更新

```bash
cd /var/www/geshixiugai
git pull origin main

# 检查代码是否包含检测功能
sudo grep -c "\[检测\]" backend/app/services/document_service.py
```

**预期输出：** 应该大于 0（例如：5、10等）

---

### 步骤2：重启服务

```bash
sudo systemctl restart geshixiugai
sudo systemctl status geshixiugai
```

**预期输出：** `Active: active (running)`

---

### 步骤3：检查日志文件

```bash
# 检查日志文件是否存在
sudo ls -lh /var/log/geshixiugai/error.log

# 查看日志内容（不筛选）
sudo tail -n 20 /var/log/geshixiugai/error.log
```

---

### 步骤4：上传文档测试

1. **访问网站**
2. **上传一个包含"诚信承诺"和"摘要"的文档**
3. **等待文档处理完成**

---

### 步骤5：查看检测日志

```bash
# 查看检测信息
sudo grep "\[检测\]" /var/log/geshixiugai/error.log | tail -n 50

# 查看修复信息
sudo grep "\[修复\]" /var/log/geshixiugai/error.log | tail -n 50

# 查看所有相关信息
sudo grep -E "\[检测\]|\[修复\]|\[诊断\]" /var/log/geshixiugai/error.log | tail -n 50
```

---

## 📋 使用排查脚本

项目根目录有一个排查脚本，可以直接运行：

```bash
# 在服务器上执行
cd /var/www/geshixiugai
./排查检测日志没有输出的步骤.sh
```

或者如果脚本在本地，上传到服务器后执行。

---

## 🎯 快速排查命令

```bash
# 1. 更新代码
cd /var/www/geshixiugai
git pull origin main

# 2. 检查代码是否包含检测功能
sudo grep -c "\[检测\]" backend/app/services/document_service.py

# 3. 重启服务
sudo systemctl restart geshixiugai

# 4. 检查服务状态
sudo systemctl status geshixiugai

# 5. 查看日志（不筛选）
sudo tail -n 20 /var/log/geshixiugai/error.log

# 6. 上传文档测试（在网页上操作）

# 7. 查看检测日志
sudo grep "\[检测\]" /var/log/geshixiugai/error.log | tail -n 50
```

---

## 📊 预期的检测日志输出

如果一切正常，应该看到类似以下输出：

```
[修复] 诚信承诺范围: X 到 Y
[修复] 摘要起始位置: Z
[修复] ⚠️ 诚信承诺和摘要之间没有分页符，强制添加分页符
[修复] 方法1：已设置摘要标题段落的 page_break_before = True
[修复] 方法2：已在摘要标题前插入空白段落并设置分页符
[修复] 方法3：已在摘要标题的第一个run前添加分页符
[修复] ✅ 已使用多种方法强制添加分页符，确保诚信承诺和摘要分开

[检测] ========== 修复后检测：诚信承诺和摘要分页结果 ==========
[检测] ✅ 修复成功：诚信承诺和摘要已分开在不同页
[检测] 分页符位置: 1 个

[检测] ========== PDF生成后检测：诚信承诺和摘要分页结果 ==========
[检测] PDF总页数: 50
[检测] 第 2 页包含诚信承诺
[检测] 第 3 页包含摘要
[检测] ✅ PDF中诚信承诺和摘要分开在不同页
```

---

## ⚠️ 重要提示

**检测日志只在处理文档时才会生成！**

如果没有输出，请按以下顺序排查：
1. ✅ 检查代码是否已更新
2. ✅ 重启服务
3. ✅ 上传文档进行测试
4. ✅ 然后查看检测日志

---

**执行完这些步骤后，再上传一个文档，然后查看检测日志！** 🔧

