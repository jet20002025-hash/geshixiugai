# 大文件上传解决方案

## 🔍 问题

Vercel 平台对请求体大小有限制：
- **Hobby 计划**：4.5 MB（无法修改）
- **Pro 计划**：4.5 MB（无法通过配置文件修改）
- **Enterprise 计划**：可能可以配置更大限制（需要联系 Vercel 销售）

**重要**：Vercel **不支持**通过 `vercel.json` 配置 `maxRequestSize`。请求体大小限制是平台级别的，无法通过配置文件修改。

即使我们在代码中设置了 20MB 的限制，Vercel 平台本身的限制仍然会阻止超过 4.5MB 的文件上传。

## ✅ 解决方案

### 方案 1：直接上传到对象存储（推荐）⭐

**原理**：前端直接上传文件到对象存储（R2/Supabase/B2），绕过 Vercel 的限制。

**优点**：
- ✅ 支持任意大小的文件（取决于对象存储的限制）
- ✅ 不经过 Vercel，不受 4.5MB 限制
- ✅ 上传速度快（直接到对象存储）

**实现步骤**：
1. 后端提供获取预签名上传 URL 的接口
2. 前端使用预签名 URL 直接上传到对象存储
3. 上传完成后，通知后端处理文件

**当前状态**：代码已支持，但需要配置对象存储。

---

### 方案 2：压缩文件（临时方案）

**如果文件超过 4.5MB**：

1. **在 Word 中压缩图片**：
   - 打开 Word 文档
   - 选择图片 → 右键 → "图片格式" → "压缩图片"
   - 选择"压缩文档中的所有图片"
   - 选择分辨率（Web 质量 150 ppi 或 打印质量 220 ppi）
   - 点击"确定"

2. **删除不必要的图片**：
   - 删除装饰性图片
   - 删除重复的图片
   - 删除水印（如果不需要）

3. **使用在线工具压缩**：
   - TinyPNG：https://tinypng.com/
   - Squoosh：https://squoosh.app/

---

### 方案 3：配置对象存储（长期方案）

**推荐使用 Supabase Storage**（最简单）：

1. **注册 Supabase**：
   - 访问：https://supabase.com
   - 使用 GitHub 登录
   - 创建新项目

2. **创建 Storage Bucket**：
   - 左侧菜单 → Storage
   - 创建 Bucket：`word-formatter-storage`
   - 取消勾选 "Public bucket"（私有存储）

3. **配置 Vercel 环境变量**：
   ```
   SUPABASE_URL=https://你的项目ID.supabase.co
   SUPABASE_KEY=你的service_role key
   SUPABASE_BUCKET=word-formatter-storage
   ```

4. **重新部署**：
   - Vercel 会自动检测环境变量
   - 重新部署项目

**完成后**：系统会自动使用 Supabase Storage，支持大文件上传。

---

## 📋 当前限制说明

### 如果未配置对象存储：

- ✅ **文件 ≤ 4.5 MB**：可以正常上传
- ❌ **文件 > 4.5 MB**：会被 Vercel 拒绝（平台限制）

### 如果已配置对象存储：

- ✅ **任意大小文件**：都可以上传（取决于对象存储的限制）
- ✅ **直接上传到对象存储**：绕过 Vercel 限制

---

## 🔧 技术实现

### 后端检查逻辑

```python
# 如果文件超过 4.5MB 且未配置对象存储
if file.size > 4.5 * 1024 * 1024:
    storage = get_storage()
    if not storage or not storage.is_available():
        # 提示用户配置对象存储或压缩文件
        raise HTTPException(
            status_code=413,
            detail="文件超过 4.5MB，请配置对象存储或压缩文件"
        )
    else:
        # 使用预签名URL直接上传
        presigned_url = storage.get_presigned_upload_url(key)
```

### 前端上传逻辑

```javascript
// 如果文件超过 4.5MB，使用预签名URL直接上传
if (file.size > 4.5 * 1024 * 1024) {
  // 1. 获取预签名URL
  const { upload_url, file_key } = await fetch('/api/upload-url', {
    method: 'POST',
    body: JSON.stringify({ filename: file.name })
  }).then(r => r.json());
  
  // 2. 直接上传到对象存储
  await fetch(upload_url, {
    method: 'PUT',
    body: file,
    headers: { 'Content-Type': file.type }
  });
  
  // 3. 通知后端处理文件
  await fetch('/api/process', {
    method: 'POST',
    body: JSON.stringify({ file_key })
  });
}
```

---

## 🚀 快速开始

### 立即使用（压缩文件）

如果文件超过 4.5MB，最简单的方法是压缩文件中的图片：

1. 打开 Word 文档
2. 选择任意图片 → 右键 → "图片格式" → "压缩图片"
3. 选择"压缩文档中的所有图片"
4. 选择"Web 质量"（150 ppi）
5. 保存文档
6. 重新上传

### 长期方案（配置对象存储）

1. 按照"方案 3"配置 Supabase Storage
2. 重新部署项目
3. 之后就可以上传任意大小的文件了

---

## 📝 总结

- **当前限制**：Vercel 平台限制 4.5MB
- **临时方案**：压缩文件中的图片
- **长期方案**：配置对象存储（Supabase/R2/B2）
- **代码状态**：已支持大文件上传，需要配置对象存储

**如果遇到文件上传问题，请先尝试压缩文件中的图片！**

