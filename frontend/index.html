<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>è®ºæ–‡æ ¼å¼è‡ªåŠ¨ä¿®å¤</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='.9em' font-size='90'%3EğŸ“„%3C/text%3E%3C/svg%3E" />
    <!-- ä¸å†ä½¿ç”¨Googleå­—ä½“ï¼Œä½¿ç”¨ç³»ç»Ÿé»˜è®¤å­—ä½“ç¡®ä¿æ˜¾ç¤º -->
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        margin: 2rem auto;
        max-width: 760px;
        line-height: 1.6;
      }
      h1,
      h2 {
        color: #16324f;
      }
      section {
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 6px 20px rgba(15, 23, 42, 0.04);
      }
      label {
        display: block;
        font-weight: 600;
        margin-bottom: 0.5rem;
      }
      input[type="file"],
      select,
      button {
        width: 100%;
        padding: 0.6rem;
        margin-bottom: 1rem;
        border-radius: 8px;
        border: 1px solid #d1d5db;
        font-size: 1rem;
      }
      button {
        background: linear-gradient(135deg, #2563eb, #1e3a8a);
        color: white;
        cursor: pointer;
        transition: transform 0.15s ease, box-shadow 0.15s ease;
        border: none;
      }
      button:hover {
        transform: translateY(-1px);
        box-shadow: 0 12px 24px rgba(37, 99, 235, 0.2);
      }
      .card-title {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 1rem;
      }
      .status {
        padding: 0.75rem;
        border-radius: 8px;
        background: #ecfdf5;
        border: 1px solid #10b98133;
        color: #047857;
        font-size: 0.95rem;
      }
      .status.error {
        background: #fef2f2;
        border-color: #dc262633;
        color: #b91c1c;
      }
      .list {
        background: #f9fafb;
        border-radius: 8px;
        padding: 1rem;
        border: 1px solid #e5e7eb;
      }
      .list ul {
        margin: 0;
        padding-left: 1.2rem;
      }
      .divider {
        height: 1px;
        margin: 1.5rem 0;
        background: linear-gradient(90deg, rgba(229, 231, 235, 0), rgba(209, 213, 219, 0.9), rgba(229, 231, 235, 0));
        border: none;
      }
      .small {
        font-size: 0.9rem;
        color: #6b7280;
      }
      .links a {
        display: inline-block;
        margin-right: 1rem;
        color: #2563eb;
        text-decoration: none;
      }
      /* ç¡®ä¿æ”¶æ¬¾è´¦æˆ·ä¿¡æ¯åŒºåŸŸå§‹ç»ˆéšè— */
      #paymentAccountInfo,
      #accountDetails,
      [id*="account"],
      [class*="account"] {
        display: none !important;
      }
      /* æ ‡è¯­æ ·å¼ */
      .slogan {
        text-align: center;
        margin: 2rem 0 1.5rem 0;
        padding: 1.5rem;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 15px;
        box-shadow: 0 8px 32px rgba(102, 126, 234, 0.3);
        position: relative;
        overflow: hidden;
        display: block !important; /* å¼ºåˆ¶æ˜¾ç¤º */
        visibility: visible !important; /* ç¡®ä¿å¯è§ */
        opacity: 1 !important; /* ç¡®ä¿ä¸é€æ˜ */
        min-height: 80px; /* ç¡®ä¿æœ‰è¶³å¤Ÿé«˜åº¦ */
      }
      .slogan::before {
        content: '';
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.1), transparent);
        animation: shine 3s infinite;
      }
      @keyframes shine {
        0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
        100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
      }
      .slogan-text {
        font-family: Arial, "Microsoft YaHei", "SimHei", sans-serif !important; /* ä½¿ç”¨æœ€ç®€å•çš„ç³»ç»Ÿå­—ä½“ */
        font-size: 2.5rem !important;
        font-weight: bold !important;
        color: #ffffff !important; /* å¼ºåˆ¶ç™½è‰² */
        text-shadow: 
          2px 2px 4px rgba(0, 0, 0, 0.3),
          0 0 20px rgba(255, 255, 255, 0.5) !important;
        letter-spacing: 0.1em !important;
        position: relative !important;
        z-index: 1 !important;
        display: inline-block !important; /* å¼ºåˆ¶æ˜¾ç¤º */
        visibility: visible !important; /* ç¡®ä¿å¯è§ */
        opacity: 1 !important; /* ç¡®ä¿ä¸é€æ˜ */
        transform: rotate(-1deg) !important;
        animation: float 2s ease-in-out infinite !important;
      }
      @keyframes float {
        0%, 100% { transform: rotate(-1deg) translateY(0px); }
        50% { transform: rotate(1deg) translateY(-5px); }
      }
      .slogan-text::after {
        content: 'âš¡';
        display: inline-block;
        margin-left: 0.3em;
        animation: flash 1.5s ease-in-out infinite;
        font-size: 1.2em;
      }
      @keyframes flash {
        0%, 100% { opacity: 1; transform: scale(1); }
        50% { opacity: 0.7; transform: scale(1.2); }
      }
      @media (max-width: 768px) {
        .slogan-text {
          font-size: 1.8rem;
        }
      }
      /* ç¡®ä¿æ ‡è¯­ä¸è¢«éšè— - æœ€é«˜ä¼˜å…ˆçº§ */
      .slogan,
      .slogan * {
        display: block !important;
        visibility: visible !important;
        opacity: 1 !important;
      }
      .slogan-text {
        display: inline-block !important;
      }
      .version-badge {
        font-size: 0.5em;
        color: #ffffff;
        background: #dc2626;
        padding: 0.15rem 0.6rem;
        border-radius: 9999px;
        font-weight: 600;
        white-space: nowrap;
        box-shadow: 0 2px 6px rgba(220, 38, 38, 0.25);
      }
    </style>
    <script>
      // æ ‡è¯­å·²ç»ä½¿ç”¨å†…è”æ ·å¼ï¼Œä¸éœ€è¦ JavaScript å¤„ç†
      
      // å…¨å±€é”™è¯¯å¤„ç†ï¼šæ•è·æœªå¤„ç†çš„ Promise é”™è¯¯
      // æ³¨æ„ï¼šè¿™ä¸ªé”™è¯¯å¤„ç†å¿…é¡»åœ¨é¡µé¢æœ€å‰é¢ï¼Œç¡®ä¿èƒ½æ•è·æ‰€æœ‰é”™è¯¯
      window.addEventListener('unhandledrejection', function(event) {
        const reason = event.reason;
        
        // æ£€æŸ¥æ˜¯å¦æ˜¯ç½‘ç»œé”™è¯¯ï¼ˆå¤šç§æ ¼å¼ï¼‰
        const isNetworkError = 
          (reason && typeof reason === 'object' && (
            reason.message === 'Failed to fetch' ||
            reason.httpStatusText === 'TypeError: Failed to fetch' ||
            (reason.httpStatusText && reason.httpStatusText.includes('Failed to fetch')) ||
            (reason.name && reason.name === 'TypeError' && reason.message && reason.message.includes('fetch')) ||
            // æ£€æŸ¥æ˜¯å¦æ˜¯æ¥è‡ªæµè§ˆå™¨æ‰©å±•çš„é”™è¯¯ï¼ˆcontent.jsï¼‰
            (reason.name === 'i' && reason.httpStatusText && reason.httpStatusText.includes('Failed to fetch'))
          )) ||
          (reason && typeof reason === 'string' && reason.includes('Failed to fetch'));
        
        // å¦‚æœæ˜¯ç½‘ç»œé”™è¯¯æˆ–æ¥è‡ªæµè§ˆå™¨æ‰©å±•çš„é”™è¯¯ï¼Œé™é»˜å¤„ç†
        if (isNetworkError || (reason && reason.name === 'i')) {
          // é™é»˜å¤„ç†ï¼Œä¸å½±å“é¡µé¢æ˜¾ç¤º
          event.preventDefault();
          return;
        }
        
        // å…¶ä»–é”™è¯¯æ‰æ˜¾ç¤ºï¼ˆä½†ä¹Ÿè¦æ£€æŸ¥æ˜¯å¦æ¥è‡ªæ‰©å±•ï¼‰
        const isFromExtension = event.promise && (
          String(event.promise).includes('content.js') ||
          String(event.promise).includes('extension')
        );
        
        if (!isFromExtension) {
          console.error('=== æœªæ•è·çš„ Promise é”™è¯¯ ===');
          console.error('é”™è¯¯åŸå› :', reason);
          console.error('Promise:', event.promise);
          console.error('å®Œæ•´é”™è¯¯å¯¹è±¡:', event);
          if (reason && reason.stack) {
            console.error('é”™è¯¯å †æ ˆ:', reason.stack);
          }
          console.error('===========================');
        } else {
          // æ¥è‡ªæ‰©å±•çš„é”™è¯¯ï¼Œé™é»˜å¤„ç†
          event.preventDefault();
        }
      });
      
      // å…¨å±€é”™è¯¯å¤„ç†ï¼šæ•è·å…¶ä»–é”™è¯¯
      window.addEventListener('error', function(event) {
        console.error('=== é¡µé¢é”™è¯¯ ===');
        console.error('é”™è¯¯æ¶ˆæ¯:', event.message);
        console.error('é”™è¯¯æ–‡ä»¶:', event.filename);
        console.error('é”™è¯¯è¡Œå·:', event.lineno);
        console.error('é”™è¯¯åˆ—å·:', event.colno);
        console.error('é”™è¯¯å¯¹è±¡:', event.error);
        if (event.error && event.error.stack) {
          console.error('é”™è¯¯å †æ ˆ:', event.error.stack);
        }
        console.error('================');
      });
      
      // ç¡®ä¿æ¨ªå¹…ç«‹å³æ˜¾ç¤ºï¼ˆä½¿ç”¨æœ€ç®€å•çš„ä»£ç ï¼‰
      (function() {
        function ensureBannerVisible() {
          const banner = document.getElementById('banner');
          console.log('=== æ¨ªå¹…æ£€æŸ¥ ===');
          console.log('bannerå…ƒç´ å­˜åœ¨:', !!banner);
          
          if (banner) {
            const computedStyle = window.getComputedStyle(banner);
            console.log('banner display:', computedStyle.display);
            console.log('banner visibility:', computedStyle.visibility);
            console.log('banner opacity:', computedStyle.opacity);
            console.log('banner height:', computedStyle.height);
            console.log('banner width:', computedStyle.width);
            console.log('banner background:', computedStyle.backgroundColor);
            
            // å¼ºåˆ¶è®¾ç½®æ ·å¼ï¼Œç¡®ä¿å¯è§ï¼ˆWindowså…¼å®¹ï¼Œä½¿ç”¨flexboxå±…ä¸­ï¼‰
            banner.style.cssText = 'display: flex !important; align-items: center !important; justify-content: center !important; visibility: visible !important; opacity: 1 !important; min-height: 80px !important; background-color: #667eea !important; background: #667eea !important; padding: 25px 20px !important; border-radius: 15px !important; margin: 20px auto !important; box-shadow: 0 4px 6px rgba(0,0,0,0.1) !important; position: relative !important; z-index: 9999 !important; width: 100% !important; max-width: 760px !important;';
            
            // ç¡®ä¿å…ƒç´ åœ¨è§†å£ä¸­å¯è§
            const rect = banner.getBoundingClientRect();
            if (rect.top < 0 || rect.left < 0) {
              banner.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
            
            const textDiv = banner.querySelector('div');
            if (textDiv) {
              const textStyle = window.getComputedStyle(textDiv);
              console.log('textDiv display:', textStyle.display);
              console.log('textDiv visibility:', textStyle.visibility);
              console.log('textDiv color:', textStyle.color);
              console.log('textDiv text:', textDiv.textContent);
              
              textDiv.style.cssText = 'display: inline-block !important; visibility: visible !important; opacity: 1 !important; color: #ffffff !important; font-family: Arial, Helvetica, "Microsoft YaHei", "SimHei", sans-serif !important; font-size: 28px !important; font-weight: bold !important; line-height: 1.4 !important; text-shadow: 1px 1px 2px rgba(0,0,0,0.3) !important; margin: 0 !important; padding: 0 !important;';
            } else {
              console.warn('æœªæ‰¾åˆ°textDiv');
            }
            
            // å†æ¬¡æ£€æŸ¥
            const finalStyle = window.getComputedStyle(banner);
            console.log('è®¾ç½®å display:', finalStyle.display);
            console.log('è®¾ç½®å visibility:', finalStyle.visibility);
            console.log('è®¾ç½®å opacity:', finalStyle.opacity);
            console.log('è®¾ç½®å z-index:', finalStyle.zIndex);
            console.log('å…ƒç´ ä½ç½® top:', rect.top, 'left:', rect.left);
          } else {
            console.error('é”™è¯¯ï¼šæ‰¾ä¸åˆ° #banner å…ƒç´ ï¼');
            // å°è¯•é€šè¿‡æ–‡æœ¬æŸ¥æ‰¾
            const allDivs = document.querySelectorAll('div');
            for (let div of allDivs) {
              if (div.textContent && div.textContent.includes('ä¸€ç§’è§£å†³ä½ çš„è®ºæ–‡æ ¼å¼é—®é¢˜')) {
                console.log('é€šè¿‡æ–‡æœ¬æ‰¾åˆ°å…ƒç´ :', div);
                div.id = 'banner';
                div.style.cssText = 'display: block !important; visibility: visible !important; opacity: 1 !important; min-height: 80px !important; background: #667eea !important; text-align: center !important; padding: 20px !important; border-radius: 15px !important; margin: 20px 0 !important; box-shadow: 0 4px 6px rgba(0,0,0,0.1) !important;';
                break;
              }
            }
          }
          console.log('================');
        }
        
        // ç«‹å³æ‰§è¡Œ
        ensureBannerVisible();
        // DOMContentLoadedæ—¶å†æ¬¡æ‰§è¡Œ
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', ensureBannerVisible);
        } else {
          ensureBannerVisible();
        }
        // å»¶è¿Ÿæ‰§è¡Œ
        setTimeout(ensureBannerVisible, 100);
        setTimeout(ensureBannerVisible, 500);
        
        // æš´éœ²åˆ°å…¨å±€ï¼Œæ–¹ä¾¿åœ¨æ§åˆ¶å°è°ƒç”¨
        window.checkBanner = ensureBannerVisible;
      })();
    </script>
  </head>
  <body>
    <!-- æ ‡è¯­æ¨ªå¹… - ä½¿ç”¨æœ€ç®€å•çš„å†…è”æ ·å¼ï¼Œä¸ä¾èµ–ä»»ä½•å¤–éƒ¨èµ„æºï¼Œå…¼å®¹Windows -->
    <div id="banner" style="display: flex !important; align-items: center !important; justify-content: center !important; visibility: visible !important; opacity: 1 !important; min-height: 80px !important; background-color: #667eea !important; background: #667eea !important; padding: 25px 20px !important; border-radius: 15px !important; margin: 20px auto !important; box-shadow: 0 4px 6px rgba(0,0,0,0.1) !important; position: relative !important; z-index: 9999 !important; width: 100% !important; max-width: 760px !important;">
      <div style="display: inline-block !important; visibility: visible !important; opacity: 1 !important; color: #ffffff !important; font-family: Arial, Helvetica, 'Microsoft YaHei', 'SimHei', sans-serif !important; font-size: 28px !important; font-weight: bold !important; line-height: 1.4 !important; text-shadow: 1px 1px 2px rgba(0,0,0,0.3) !important; margin: 0 !important; padding: 0 !important;">ä¸€ç§’è§£å†³ä½ çš„è®ºæ–‡æ ¼å¼é—®é¢˜ï¼</div>
    </div>
    
    <h1 style="display: flex; align-items: baseline; gap: 0.75rem;">è®ºæ–‡æ ¼å¼è‡ªåŠ¨ä¿®å¤ <span class="version-badge">v1.0.0</span></h1>
    <p class="small">æµç¨‹ï¼šå…ˆçœ‹ç¬¬äºŒæ­¥åˆ—è¡¨æ¡†æœ‰æ²¡æœ‰é€‚åˆä½ çš„æ¨¡ç‰ˆï¼Œæ²¡æœ‰åˆ™ä¸Šä¼ è‡ªå·±å­¦æ ¡çš„æ¨¡ç‰ˆï¼Œå†ä¸Šä¼ è‡ªå·±çš„æ¯•ä¸šè®ºæ–‡ï¼Œé¢„è§ˆæ°´å°ç‰ˆï¼Œæ”¯ä»˜åä¸‹è½½æ­£å¼ç‰ˆã€‚</p>

    <section>
      <div class="card-title">
        <h2>1. ä¸Šä¼ æ¨¡æ¿</h2>
      </div>
      <form id="templateForm">
        <label for="templateFile">é€‰æ‹©æ¨¡æ¿ï¼ˆ.docxï¼‰</label>
        <input id="templateFile" type="file" accept=".docx" required />
        <button type="submit">ä¸Šä¼ æ¨¡æ¿</button>
      </form>
      <div id="templateStatus" class="status" style="display: none"></div>
    </section>

    <section>
      <div class="card-title">
        <h2>2. ä¸Šä¼ æ‚¨çš„æ–‡æ¡£</h2>
      </div>
      <form id="documentForm">
        <!-- é¢„è®¾æ¨¡æ¿ï¼šå¤§å­¦é€‰æ‹©ï¼ˆé»˜è®¤æ˜¾ç¤ºï¼‰ -->
        <div id="presetTemplateSection">
          <label for="universitySelect">é€‰æ‹©æ‚¨çš„å¤§å­¦</label>
          <select id="universitySelect" required>
            <option value="">åŠ è½½ä¸­...</option>
          </select>
        </div>
        
        <!-- è‡ªå®šä¹‰æ¨¡æ¿ï¼šæ¨¡æ¿é€‰æ‹©ï¼ˆä»…å½“ç”¨æˆ·ä¸Šä¼ äº†æ¨¡æ¿æ—¶æ˜¾ç¤ºï¼‰ -->
        <div id="customTemplateSection" style="display: none;">
          <label for="templateSelect">æˆ–ä½¿ç”¨æ‚¨ä¸Šä¼ çš„æ¨¡æ¿</label>
          <select id="templateSelect">
            <option value="">è¯·å…ˆä¸Šä¼ æ¨¡æ¿</option>
          </select>
        </div>
        
        <label for="documentFile">é€‰æ‹©æ‚¨çš„æ–‡æ¡£ï¼ˆ.docxï¼‰</label>
        <input id="documentFile" type="file" accept=".docx" required />
        <button type="submit">ä¸Šä¼ å¹¶è‡ªåŠ¨ä¿®å¤</button>
      </form>
      <div id="documentStatus" class="status" style="display: none"></div>
    </section>

    <section>
      <div class="card-title">
        <h2>3. ä¸‹è½½ä¸æ”¯ä»˜</h2>
      </div>
      <div id="result" class="list" style="display: none">
        <p><strong>æ–‡æ¡£ IDï¼š</strong><span id="docId"></span></p>
        <p><strong>å¤„ç†çŠ¶æ€ï¼š</strong><span id="docStatus"></span></p>
        <p><strong>å·²ä»˜è´¹ï¼š</strong><span id="docPaid"></span></p>
        <div id="changesSummary" style="background: #e7f3ff; padding: 15px; border-radius: 5px; margin: 15px 0; display: none;">
          <h3 style="margin-top: 0; color: #1976D2;">ğŸ“ æ ¼å¼ä¿®æ”¹æ‘˜è¦</h3>
          <div id="changesContent"></div>
        </div>
        <div id="figureIssues" style="background: #fff3cd; border: 2px solid #ffc107; padding: 15px; border-radius: 5px; margin: 15px 0; display: none;">
          <h3 style="margin-top: 0; color: #856404;">âš ï¸ å›¾ç‰‡æ£€æµ‹ç»“æœ</h3>
          <div id="figureIssuesContent"></div>
        </div>
        <div id="referenceIssues" style="background: #ffe0e0; border: 2px solid #f44336; padding: 15px; border-radius: 5px; margin: 15px 0; display: none;">
          <h3 style="margin-top: 0; color: #c62828;">ğŸ“š å‚è€ƒæ–‡çŒ®å¼•ç”¨æ£€æµ‹ç»“æœ</h3>
          <div id="referenceIssuesContent"></div>
        </div>
        <div id="blankIssues" style="background: #fff3e0; border: 2px solid #ff9800; padding: 15px; border-radius: 5px; margin: 15px 0; display: none;">
          <h3 style="margin-top: 0; color: #e65100;">ğŸ“„ ç©ºç™½æ£€æµ‹ç»“æœ</h3>
          <div id="blankIssuesContent"></div>
        </div>
        <div class="links" id="previewLinks"></div>
        <hr class="divider" />
        
        <!-- æ”¯ä»˜ä¿¡æ¯æ˜¾ç¤º -->
        <div id="paymentInfo" style="background: #f5f5f5; padding: 20px; border-radius: 5px; margin: 20px 0; display: none;">
          <h3 style="margin-top: 0; color: #1976D2;">ğŸ’³ æ”¯ä»˜ä¿¡æ¯</h3>
          <div id="paymentInfoContent">
            <p><strong>æ”¯ä»˜é‡‘é¢ï¼š</strong><span id="paymentAmount" style="color: #f44336; font-size: 24px; font-weight: bold;">Â¥0.00</span></p>
            <p style="margin-top: 15px;"><strong>æ”¯ä»˜æ–¹å¼ï¼š</strong></p>
            <div id="paymentMethods" style="margin-top: 10px;"></div>
          </div>
        </div>
        
        <!-- æ”¯ä»˜æŒ‰é’® -->
        <button id="payButton" style="display: none; width: 100%; padding: 15px; font-size: 16px; background: #4CAF50; color: white; border: none; border-radius: 5px; cursor: pointer; margin-top: 10px;">
          ç«‹å³æ”¯ä»˜
        </button>
        
        <!-- å·²æ”¯ä»˜æç¤º -->
        <div id="paidNotice" style="background: #e8f5e9; border: 2px solid #4CAF50; padding: 15px; border-radius: 5px; margin: 20px 0; display: none;">
          <p style="margin: 0; color: #2e7d32; font-weight: bold;">âœ… å·²æ”¯ä»˜ï¼Œå¯ä»¥ä¸‹è½½æ­£å¼ç‰ˆæ–‡æ¡£</p>
        </div>
      </div>
      <div id="resultStatus" class="status" style="display: none"></div>
    </section>

    <!-- è”ç³»æ–¹å¼ -->
    <section style="text-align: center; padding: 20px; background: #f9fafb; border-radius: 12px; margin-top: 2rem;">
      <p style="margin: 0; color: #6b7280; font-size: 0.95rem;">
        å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·è”ç³»æˆ‘ä»¬ï¼š
        <a href="mailto:522168878@qq.com" style="color: #2563eb; text-decoration: none; font-weight: 600;">522168878@qq.com</a>
      </p>
    </section>

    <!-- å¤‡æ¡ˆå· -->
    <footer style="text-align: center; padding: 20px; color: #666; font-size: 12px; border-top: 1px solid #eee; margin-top: 40px;">
      <p style="margin: 0;">
        å¤‡æ¡ˆå·ï¼š<a href="https://beian.miit.gov.cn/" target="_blank" style="color: #666; text-decoration: none;">æµ™ICPå¤‡2025213303å·-1</a>
      </p>
    </footer>

    <script>
      const templateForm = document.getElementById("templateForm");
      const documentForm = document.getElementById("documentForm");
      const templateStatus = document.getElementById("templateStatus");
      const documentStatus = document.getElementById("documentStatus");
      const resultStatus = document.getElementById("resultStatus");
      const presetTemplateSection = document.getElementById("presetTemplateSection");
      const customTemplateSection = document.getElementById("customTemplateSection");
      const universitySelect = document.getElementById("universitySelect");
      const templateSelect = document.getElementById("templateSelect");
      const resultCard = document.getElementById("result");
      const docIdSpan = document.getElementById("docId");
      const docStatusSpan = document.getElementById("docStatus");
      const docPaidSpan = document.getElementById("docPaid");
      const previewLinks = document.getElementById("previewLinks");
      const paymentInfo = document.getElementById("paymentInfo");
      const paymentAmount = document.getElementById("paymentAmount");
      const paymentMethods = document.getElementById("paymentMethods");
      const payButton = document.getElementById("payButton");
      const paidNotice = document.getElementById("paidNotice");
      
      // æ·»åŠ å…¨å±€æ”¯ä»˜æŒ‰é’®ç‚¹å‡»ç›‘å¬ï¼ˆç”¨äºè°ƒè¯•ï¼‰
      if (payButton) {
        payButton.addEventListener("click", function(e) {
          console.log("æ”¯ä»˜æŒ‰é’®è¢«ç‚¹å‡»ï¼ˆå…¨å±€ç›‘å¬ï¼‰", e);
        }, true); // ä½¿ç”¨æ•è·é˜¶æ®µ
      }
      const changesSummary = document.getElementById("changesSummary");
      const changesContent = document.getElementById("changesContent");
      const figureIssues = document.getElementById("figureIssues");
      const figureIssuesContent = document.getElementById("figureIssuesContent");

      let latestDocumentId = null;

      function showMessage(element, message, isError = false) {
        element.textContent = message;
        element.classList.toggle("error", isError);
        element.style.display = "block";
      }

      function addTemplateOption(templateId, label) {
        const option = document.createElement("option");
        option.value = templateId;
        option.textContent = `${label} (${templateId.slice(0, 8)})`;
        templateSelect.appendChild(option);
        templateSelect.value = templateId;
      }

      // åŠ è½½ç”¨æˆ·æ¨¡æ¿åˆ—è¡¨
      async function loadUserTemplates() {
        try {
          const response = await fetch("/templates");
          if (!response.ok) {
            console.warn("åŠ è½½æ¨¡æ¿åˆ—è¡¨å¤±è´¥:", response.status);
            // è®¾ç½®é»˜è®¤é€‰é¡¹
            templateSelect.innerHTML = '<option value="">è¯·å…ˆä¸Šä¼ æ¨¡æ¿</option>';
            return [];
          }
          
          const templates = await response.json();
          
          // æ¸…ç©ºç°æœ‰é€‰é¡¹ï¼ˆä¿ç•™ç¬¬ä¸€ä¸ªç©ºé€‰é¡¹ï¼‰
          templateSelect.innerHTML = '<option value="">è¯·å…ˆä¸Šä¼ æ¨¡æ¿</option>';
          
          if (templates.length === 0) {
            const option = document.createElement("option");
            option.value = "";
            option.textContent = "æš‚æ— æ¨¡æ¿ï¼Œè¯·å…ˆä¸Šä¼ ";
            templateSelect.appendChild(option);
            return [];
          }
          
          // æ·»åŠ ç”¨æˆ·æ¨¡æ¿ï¼ˆåªæ˜¾ç¤ºæœ€æ–°çš„ï¼Œåç«¯å·²é™åˆ¶ä¸º10ä¸ªï¼‰
          templates.forEach(template => {
            // æ˜¾ç¤ºæ¨¡æ¿åç§°å’Œåˆ›å»ºæ—¶é—´ï¼ˆå¦‚æœæœ‰ï¼‰
            let displayName = template.name || "æœªå‘½åæ¨¡æ¿";
            if (template.created_at) {
              try {
                const date = new Date(template.created_at);
                const dateStr = date.toLocaleDateString('zh-CN', { 
                  year: 'numeric', 
                  month: '2-digit', 
                  day: '2-digit' 
                });
                displayName = `${displayName} (${dateStr})`;
              } catch (e) {
                // å¦‚æœæ—¥æœŸè§£æå¤±è´¥ï¼Œåªæ˜¾ç¤ºåç§°
              }
            }
            addTemplateOption(template.template_id, displayName);
          });
          
          // å¦‚æœæ¨¡æ¿æ•°é‡è¾¾åˆ°10ä¸ªï¼Œæ˜¾ç¤ºæç¤º
          if (templates.length >= 10) {
            const option = document.createElement("option");
            option.disabled = true;
            option.textContent = "--- ä»…æ˜¾ç¤ºæœ€æ–°10ä¸ªæ¨¡æ¿ ---";
            templateSelect.appendChild(option);
          }
          
          return templates;
        } catch (error) {
          // ç½‘ç»œé”™è¯¯æˆ–å…¶ä»–é”™è¯¯ï¼Œé™é»˜å¤„ç†ï¼Œä¸å½±å“é¡µé¢æ˜¾ç¤º
          console.warn("åŠ è½½æ¨¡æ¿åˆ—è¡¨å¤±è´¥ï¼ˆå¯èƒ½æ˜¯åç«¯æœåŠ¡æœªå¯åŠ¨ï¼‰:", error.message || error);
          // è®¾ç½®é»˜è®¤é€‰é¡¹ï¼Œç¡®ä¿é¡µé¢å¯ä»¥æ­£å¸¸ä½¿ç”¨
          templateSelect.innerHTML = '<option value="">è¯·å…ˆä¸Šä¼ æ¨¡æ¿</option>';
          return [];
        }
      }

      // åŠ è½½å¤§å­¦æ¨¡æ¿åˆ—è¡¨ï¼ˆåŒ…å«é¢„è®¾æ¨¡æ¿å’Œç”¨æˆ·ä¸Šä¼ çš„æ¨¡æ¿ï¼‰
      async function loadUniversityTemplates() {
        try {
          // åŠ è½½é¢„è®¾å¤§å­¦æ¨¡æ¿
          const presetResponse = await fetch("/templates/presets");
          let presetUniversities = [];
          if (presetResponse.ok) {
            presetUniversities = await presetResponse.json();
          }
          
          // åŠ è½½ç”¨æˆ·ä¸Šä¼ çš„æ¨¡æ¿ï¼ˆåç§°åŒ…å«"å¤§å­¦"çš„ï¼‰
          const userTemplates = await loadUserTemplates().catch(function(error) {
            console.warn("åŠ è½½ç”¨æˆ·æ¨¡æ¿åˆ—è¡¨å¤±è´¥ï¼ˆä¸å½±å“ä½¿ç”¨ï¼‰:", error.message || error);
            return [];
          });
          
          // æ¸…ç©ºä¸‹æ‹‰æ¡†
          universitySelect.innerHTML = '<option value="">è¯·é€‰æ‹©æ‚¨çš„å¤§å­¦</option>';
          
          // å…ˆæ·»åŠ é¢„è®¾æ¨¡æ¿
          presetUniversities.forEach(uni => {
            const option = document.createElement("option");
            option.value = `preset_${uni.id}`; // ä½¿ç”¨ preset_ å‰ç¼€åŒºåˆ†é¢„è®¾æ¨¡æ¿
            option.textContent = uni.display_name || uni.name;
            if (uni.description) {
              option.title = uni.description;
            }
            universitySelect.appendChild(option);
          });
          
          // å†æ·»åŠ ç”¨æˆ·ä¸Šä¼ çš„æ¨¡æ¿ï¼ˆåç§°åŒ…å«"å¤§å­¦"çš„ï¼‰
          if (userTemplates && userTemplates.length > 0) {
            userTemplates.forEach(template => {
              const option = document.createElement("option");
              option.value = `custom_${template.template_id}`; // ä½¿ç”¨ custom_ å‰ç¼€åŒºåˆ†è‡ªå®šä¹‰æ¨¡æ¿
              // æå–æ¨¡æ¿åç§°ï¼ˆå»æ‰ .docx æ‰©å±•åï¼‰
              let displayName = template.name || "æœªå‘½åæ¨¡æ¿";
              if (displayName.toLowerCase().endsWith(".docx")) {
                displayName = displayName.slice(0, -5);
              }
              option.textContent = displayName;
              universitySelect.appendChild(option);
            });
          }
        } catch (error) {
          console.warn("åŠ è½½å¤§å­¦æ¨¡æ¿åˆ—è¡¨å¤±è´¥:", error.message || error);
          universitySelect.innerHTML = '<option value="">åŠ è½½å¤±è´¥</option>';
        }
      }

      // åˆå§‹åŒ–æ¨¡æ¿é€‰æ‹©ï¼ˆåŠ è½½æ‰€æœ‰å¤§å­¦æ¨¡æ¿åˆ°ä¸‹æ‹‰æ¡†ï¼‰
      async function initializeTemplateSelection() {
        // åŠ è½½æ‰€æœ‰å¤§å­¦æ¨¡æ¿ï¼ˆé¢„è®¾æ¨¡æ¿ + ç”¨æˆ·ä¸Šä¼ çš„æ¨¡æ¿ï¼‰
        await loadUniversityTemplates();
        
        // å§‹ç»ˆæ˜¾ç¤ºå¤§å­¦æ¨¡æ¿é€‰æ‹©
        presetTemplateSection.style.display = "block";
        universitySelect.required = true;
        
        // ä¸å†éœ€è¦å•ç‹¬çš„è‡ªå®šä¹‰æ¨¡æ¿é€‰æ‹©æ¡†
        customTemplateSection.style.display = "none";
      }

      // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–æ¨¡æ¿é€‰æ‹©
      initializeTemplateSelection();
      
      // æ£€æµ‹æ”¯ä»˜å®æ”¯ä»˜æˆåŠŸå›è°ƒ
      (function() {
        const urlParams = new URLSearchParams(window.location.search);
        const outTradeNo = urlParams.get("out_trade_no");
        const tradeStatus = urlParams.get("trade_status");
        
        // å¦‚æœURLä¸­åŒ…å«æ”¯ä»˜å®å›è°ƒå‚æ•°ï¼Œè¯´æ˜æ˜¯ä»æ”¯ä»˜å®è·³è½¬å›æ¥çš„
        if (outTradeNo) {
          console.log("æ£€æµ‹åˆ°æ”¯ä»˜å®æ”¯ä»˜å›è°ƒï¼Œè®¢å•å·:", outTradeNo, "æ”¯ä»˜çŠ¶æ€:", tradeStatus);
          
          // è®¾ç½®latestDocumentIdï¼Œä»¥ä¾¿åç»­åˆ·æ–°çŠ¶æ€
          latestDocumentId = outTradeNo;
          
          // ä¸»åŠ¨ç¡®è®¤æ”¯ä»˜ï¼ˆåŸºäºåŒæ­¥è¿”å›å‚æ•°ï¼‰
          const tradeNo = urlParams.get("trade_no");
          const totalAmount = urlParams.get("total_amount");
          const sign = urlParams.get("sign");
          
          // æ‰“å°æ‰€æœ‰URLå‚æ•°ï¼Œç”¨äºè°ƒè¯•
          console.log("æ”¯ä»˜å®è¿”å›çš„æ‰€æœ‰å‚æ•°:", {
            out_trade_no: outTradeNo,
            trade_status: tradeStatus,
            trade_no: urlParams.get("trade_no"),
            total_amount: urlParams.get("total_amount"),
            method: urlParams.get("method"),
            all_params: Object.fromEntries(urlParams.entries())
          });
          
          if (tradeNo && totalAmount) {
            console.log("æ£€æµ‹åˆ°æ”¯ä»˜å®åŒæ­¥è¿”å›å‚æ•°ï¼Œä¸»åŠ¨ç¡®è®¤æ”¯ä»˜", {
              out_trade_no: outTradeNo,
              trade_no: tradeNo,
              total_amount: totalAmount
            });
            
            fetch("/payments/alipay/confirm", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                out_trade_no: outTradeNo,
                trade_no: tradeNo,
                total_amount: totalAmount,
                sign: sign,
              }),
            })
              .then(async r => {
                console.log("æ”¯ä»˜ç¡®è®¤APIå“åº”çŠ¶æ€:", r.status, r.statusText);
                if (!r.ok) {
                  const errorText = await r.text();
                  console.error("æ”¯ä»˜ç¡®è®¤APIè¿”å›é”™è¯¯:", errorText);
                  throw new Error(`APIè¿”å›é”™è¯¯: ${r.status} ${errorText}`);
                }
                return r.json();
              })
              .then(result => {
                console.log("æ”¯ä»˜ç¡®è®¤ç»“æœ:", result);
                if (result.success && result.paid) {
                  console.log("âœ… æ”¯ä»˜å·²ç¡®è®¤ï¼Œæ–‡æ¡£å·²æ ‡è®°ä¸ºå·²æ”¯ä»˜");
                  // ç«‹å³åˆ·æ–°æ–‡æ¡£çŠ¶æ€
                  setTimeout(() => {
                    refreshDocumentStatus().then(() => {
                      console.log("æ–‡æ¡£çŠ¶æ€å·²åˆ·æ–°");
                    });
                  }, 500);
                } else {
                  console.warn("âš ï¸ æ”¯ä»˜ç¡®è®¤è¿”å›ç»“æœå¼‚å¸¸:", result);
                }
              })
              .catch(err => {
                console.error("âŒ æ”¯ä»˜ç¡®è®¤å¤±è´¥:", err);
                // å³ä½¿ç¡®è®¤å¤±è´¥ï¼Œä¹Ÿç»§ç»­è½®è¯¢æ£€æŸ¥
              });
          } else {
            console.warn("âš ï¸ ç¼ºå°‘å¿…è¦çš„æ”¯ä»˜å‚æ•°", {
              trade_no: tradeNo,
              total_amount: totalAmount,
              all_params: Object.fromEntries(urlParams.entries())
            });
          }
          
          // ç¡®ä¿ç»“æœå¡ç‰‡æ˜¾ç¤º
          if (resultCard) {
            resultCard.style.display = "block";
          }
          
          // å»¶è¿Ÿä¸€ä¸‹ï¼Œç¡®ä¿é¡µé¢å…ƒç´ å·²åŠ è½½
          setTimeout(async () => {
            try {
              console.log("å¼€å§‹åˆ·æ–°æ–‡æ¡£çŠ¶æ€ï¼ŒdocumentId:", latestDocumentId);
              
              // ç¡®ä¿ç»“æœå¡ç‰‡æ˜¾ç¤º
              if (resultCard) {
                resultCard.style.display = "block";
                console.log("ç»“æœå¡ç‰‡å·²æ˜¾ç¤º");
              }
              
              // åˆ·æ–°æ–‡æ¡£çŠ¶æ€
              await refreshDocumentStatus();
              
              // å†æ¬¡ç¡®ä¿ç»“æœå¡ç‰‡æ˜¾ç¤º
              if (resultCard) {
                resultCard.style.display = "block";
              }
              
              // ç«‹å³æ£€æŸ¥ä¸€æ¬¡æ”¯ä»˜çŠ¶æ€ï¼ˆä¸ç­‰å¾…ï¼‰
              fetch(`/documents/${latestDocumentId}`)
                .then(r => r.json())
                .then(data => {
                  console.log("ç«‹å³æ£€æŸ¥ï¼šæ–‡æ¡£çŠ¶æ€", { paid: data.paid, document_id: data.document_id });
                  if (data.paid && previewLinks) {
                    // å¦‚æœå·²æ”¯ä»˜ï¼Œç«‹å³æ›´æ–°é¡µé¢
                    console.log("ç«‹å³æ£€æŸ¥ï¼šæ–‡æ¡£å·²æ”¯ä»˜ï¼Œç«‹å³æ›´æ–°é¡µé¢");
                    updatePageForPaidStatus(data, latestDocumentId);
                  }
                })
                .catch(err => console.error("ç«‹å³æ£€æŸ¥æ”¯ä»˜çŠ¶æ€å¤±è´¥:", err));
              
              // è½®è¯¢æ£€æŸ¥æ”¯ä»˜çŠ¶æ€ï¼ˆæ”¯ä»˜å®å›è°ƒå¯èƒ½æœ‰å»¶è¿Ÿï¼‰
              let pollCount = 0;
              const maxPolls = 20; // æœ€å¤šæ£€æŸ¥20æ¬¡ï¼ˆçº¦1åˆ†é’Ÿï¼‰
              const pollInterval = setInterval(() => {
                pollCount++;
                console.log(`è½®è¯¢æ£€æŸ¥æ”¯ä»˜çŠ¶æ€ï¼ˆç¬¬ ${pollCount} æ¬¡ï¼‰`);
                
                fetch(`/documents/${latestDocumentId}`)
                  .then(r => r.json())
                  .then(data => {
                    console.log("è½®è¯¢æ£€æŸ¥ï¼šæ–‡æ¡£çŠ¶æ€", { paid: data.paid, document_id: data.document_id, pollCount });
                    
                    if (data.paid && previewLinks) {
                      // åœæ­¢è½®è¯¢
                      clearInterval(pollInterval);
                      console.log("æ”¯ä»˜çŠ¶æ€å·²æ›´æ–°ä¸ºå·²æ”¯ä»˜ï¼Œåœæ­¢è½®è¯¢");
                      // æ›´æ–°é¡µé¢çŠ¶æ€
                      updatePageForPaidStatus(data, latestDocumentId);
                    } else if (pollCount >= maxPolls) {
                      // è¾¾åˆ°æœ€å¤§è½®è¯¢æ¬¡æ•°ï¼Œåœæ­¢è½®è¯¢
                      clearInterval(pollInterval);
                      console.warn("è¾¾åˆ°æœ€å¤§è½®è¯¢æ¬¡æ•°ï¼Œæ–‡æ¡£ä»æœªæ ‡è®°ä¸ºå·²æ”¯ä»˜", { paid: data.paid, pollCount });
                      // æ˜¾ç¤ºæç¤ºä¿¡æ¯
                      if (resultStatus) {
                        showMessage(resultStatus, "æ”¯ä»˜å¯èƒ½å·²æˆåŠŸï¼Œä½†çŠ¶æ€æ›´æ–°æœ‰å»¶è¿Ÿã€‚è¯·ç¨å€™åˆ·æ–°é¡µé¢ï¼Œæˆ–è”ç³»å®¢æœã€‚", false);
                      }
                    }
                  })
                  .catch(err => {
                    console.error("è½®è¯¢æ£€æŸ¥æ”¯ä»˜çŠ¶æ€å¤±è´¥:", err);
                    if (pollCount >= maxPolls) {
                      clearInterval(pollInterval);
                    }
                  });
              }, 3000); // æ¯3ç§’æ£€æŸ¥ä¸€æ¬¡
              
              // æ˜¾ç¤ºæˆåŠŸæç¤º
              if (resultStatus) {
                showMessage(resultStatus, "æ”¯ä»˜æˆåŠŸï¼å¯ä»¥ä¸‹è½½æ­£å¼ç‰ˆæ–‡æ¡£äº†ã€‚", false);
              }
              
              // æ¸…ç†URLå‚æ•°ï¼Œé¿å…åˆ·æ–°æ—¶é‡å¤æ£€æµ‹
              const cleanUrl = window.location.pathname;
              window.history.replaceState({}, document.title, cleanUrl);
              
              console.log("æ”¯ä»˜çŠ¶æ€åˆ·æ–°å®Œæˆ");
            } catch (error) {
              console.error("åˆ·æ–°æ”¯ä»˜çŠ¶æ€å¤±è´¥:", error);
              // å³ä½¿å‡ºé”™ï¼Œä¹Ÿå°è¯•æ˜¾ç¤ºç»“æœå¡ç‰‡
              if (resultCard) {
                resultCard.style.display = "block";
              }
            }
          }, 500);
        }
      })();

      // æ–‡ä»¶å¤§å°é™åˆ¶ï¼š20 MBï¼ˆæ”¯æŒæ¯•ä¸šè®ºæ–‡ç­‰å¤§æ–‡ä»¶ï¼‰
      const MAX_FILE_SIZE = 20 * 1024 * 1024; // 20 MB

      templateForm.addEventListener("submit", async (event) => {
        event.preventDefault();
        const file = document.getElementById("templateFile").files[0];
        if (!file) {
          showMessage(templateStatus, "è¯·é€‰æ‹©æ¨¡æ¿æ–‡ä»¶", true);
          return;
        }

        // æ£€æŸ¥æ–‡ä»¶å¤§å°
        if (file.size > MAX_FILE_SIZE) {
          const fileSizeMB = (file.size / (1024 * 1024)).toFixed(2);
          showMessage(templateStatus, `æ–‡ä»¶å¤ªå¤§ï¼ˆ${fileSizeMB} MBï¼‰ï¼Œæœ€å¤§æ”¯æŒ 20 MBã€‚è¯·å‹ç¼©æ–‡æ¡£ä¸­çš„å›¾ç‰‡æˆ–åˆ é™¤ä¸å¿…è¦çš„å›¾ç‰‡åå†ä¸Šä¼ ã€‚`, true);
          return;
        }

        const formData = new FormData();
        formData.append("file", file);

        try {
          showMessage(templateStatus, "ä¸Šä¼ ä¸­...", false);
          const response = await fetch("/templates", {
            method: "POST",
            body: formData,
          });
          
          // æ£€æŸ¥å“åº”å†…å®¹ç±»å‹
          const contentType = response.headers.get("content-type");
          let errorMessage = "æ¨¡æ¿ä¸Šä¼ å¤±è´¥";
          
          if (!response.ok) {
            // å°è¯•è§£æ JSON é”™è¯¯
            if (contentType && contentType.includes("application/json")) {
              try {
                const detail = await response.json();
                errorMessage = detail.detail || detail.message || `ä¸Šä¼ å¤±è´¥ (${response.status})`;
              } catch (e) {
                // å¦‚æœä¸æ˜¯ JSONï¼Œè¯»å–æ–‡æœ¬
                const text = await response.text();
                errorMessage = text || `ä¸Šä¼ å¤±è´¥ (${response.status} ${response.statusText})`;
              }
            } else {
              // è¯»å–æ–‡æœ¬å“åº”
              const text = await response.text();
              errorMessage = text || `ä¸Šä¼ å¤±è´¥ (${response.status} ${response.statusText})`;
            }
            throw new Error(errorMessage);
          }
          
          // æˆåŠŸå“åº”ï¼Œè§£æ JSON
          if (contentType && contentType.includes("application/json")) {
            const data = await response.json();
            showMessage(templateStatus, `æ¨¡æ¿ä¸Šä¼ æˆåŠŸï¼š${data.name}ï¼ˆæ ·å¼æ•° ${data.style_count}ï¼‰`);
            // åˆ·æ–°æ¨¡æ¿åˆ—è¡¨å¹¶é‡æ–°åˆå§‹åŒ–æ¨¡æ¿é€‰æ‹©ï¼ˆå¦‚æœæœ‰æ¨¡æ¿äº†ï¼Œä¼šè‡ªåŠ¨åˆ‡æ¢åˆ°è‡ªå®šä¹‰æ¨¡æ¿ï¼‰
            await initializeTemplateSelection();
          } else {
            throw new Error("æœåŠ¡å™¨è¿”å›äº†æ„å¤–çš„å“åº”æ ¼å¼");
          }
        } catch (error) {
          console.error("ä¸Šä¼ é”™è¯¯:", error);
          showMessage(templateStatus, error.message || "æ¨¡æ¿ä¸Šä¼ å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•", true);
        }
      });

      documentForm.addEventListener("submit", async (event) => {
        event.preventDefault();
        const selectedValue = universitySelect.value;
        const file = document.getElementById("documentFile").files[0];

        // éªŒè¯ï¼šå¿…é¡»é€‰æ‹©æ¨¡æ¿
        if (!selectedValue) {
          showMessage(documentStatus, "è¯·å…ˆé€‰æ‹©æ‚¨çš„å¤§å­¦", true);
          return;
        }
        
        if (!file) {
          showMessage(documentStatus, "è¯·é€‰æ‹©æ‚¨çš„æ–‡æ¡£", true);
          return;
        }

        // æ£€æŸ¥æ–‡ä»¶å¤§å°
        if (file.size > MAX_FILE_SIZE) {
          const fileSizeMB = (file.size / (1024 * 1024)).toFixed(2);
          showMessage(documentStatus, `æ–‡ä»¶å¤ªå¤§ï¼ˆ${fileSizeMB} MBï¼‰ï¼Œæœ€å¤§æ”¯æŒ 20 MBã€‚è¯·å‹ç¼©æ–‡æ¡£ä¸­çš„å›¾ç‰‡æˆ–åˆ é™¤ä¸å¿…è¦çš„å›¾ç‰‡åå†ä¸Šä¼ ã€‚`, true);
          return;
        }

        const formData = new FormData();
        formData.append("file", file);
        
        // æ ¹æ®é€‰æ‹©çš„å€¼åˆ¤æ–­æ˜¯é¢„è®¾æ¨¡æ¿è¿˜æ˜¯è‡ªå®šä¹‰æ¨¡æ¿
        let url = "/documents";
        if (selectedValue.startsWith("preset_")) {
          // é¢„è®¾æ¨¡æ¿
          const universityId = selectedValue.replace("preset_", "");
          url += `?university_id=${encodeURIComponent(universityId)}`;
        } else if (selectedValue.startsWith("custom_")) {
          // ç”¨æˆ·ä¸Šä¼ çš„æ¨¡æ¿
          const templateId = selectedValue.replace("custom_", "");
          url += `?template_id=${encodeURIComponent(templateId)}`;
        } else {
          // å…¼å®¹æ—§æ ¼å¼ï¼ˆç›´æ¥æ˜¯IDï¼‰
          url += `?university_id=${encodeURIComponent(selectedValue)}`;
        }

        try {
          showMessage(documentStatus, "å¤„ç†ä¸­ï¼Œè¯·ç¨å€™...", false);
          const response = await fetch(url, {
            method: "POST",
            body: formData,
          });
          
          // æ£€æŸ¥å“åº”å†…å®¹ç±»å‹
          const contentType = response.headers.get("content-type");
          let errorMessage = "æ–‡æ¡£å¤„ç†å¤±è´¥";
          
          if (!response.ok) {
            // å°è¯•è§£æ JSON é”™è¯¯
            if (contentType && contentType.includes("application/json")) {
              try {
                const detail = await response.json();
                errorMessage = detail.detail || detail.message || `å¤„ç†å¤±è´¥ (${response.status})`;
              } catch (e) {
                // å¦‚æœä¸æ˜¯ JSONï¼Œè¯»å–æ–‡æœ¬
                const text = await response.text();
                errorMessage = text || `å¤„ç†å¤±è´¥ (${response.status} ${response.statusText})`;
              }
            } else {
              // è¯»å–æ–‡æœ¬å“åº”
              const text = await response.text();
              errorMessage = text || `å¤„ç†å¤±è´¥ (${response.status} ${response.statusText})`;
            }
            throw new Error(errorMessage);
          }
          
          // æˆåŠŸå“åº”ï¼Œè§£æ JSON
          if (contentType && contentType.includes("application/json")) {
            const data = await response.json();
            console.log("æ–‡æ¡£ä¸Šä¼ æˆåŠŸï¼ŒdocumentId:", data.document_id);
            latestDocumentId = data.document_id;
            showMessage(documentStatus, "æ–‡æ¡£å¤„ç†å®Œæˆ");
            await refreshDocumentStatus();
          } else {
            throw new Error("æœåŠ¡å™¨è¿”å›äº†æ„å¤–çš„å“åº”æ ¼å¼");
          }
        } catch (error) {
          console.error("æ–‡æ¡£å¤„ç†é”™è¯¯:", error);
          showMessage(documentStatus, error.message || "æ–‡æ¡£å¤„ç†å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•", true);
        }
      });

      // æ›´æ–°é¡µé¢ä¸ºå·²æ”¯ä»˜çŠ¶æ€ï¼ˆç»Ÿä¸€å‡½æ•°ï¼‰
      function updatePageForPaidStatus(data, documentId) {
        console.log("æ›´æ–°é¡µé¢ä¸ºå·²æ”¯ä»˜çŠ¶æ€", { document_id: documentId, download_token: data.download_token });
        
        // ç¡®ä¿ç»“æœå¡ç‰‡æ˜¾ç¤º
        if (resultCard) {
          resultCard.style.display = "block";
        }
        
        // æ›´æ–°å·²ä»˜è´¹çŠ¶æ€æ˜¾ç¤º
        if (docPaidSpan) {
          docPaidSpan.textContent = "æ˜¯";
          docPaidSpan.style.color = "#4CAF50";
          docPaidSpan.style.fontWeight = "bold";
        }
        
        // å¼ºåˆ¶éšè—æ”¯ä»˜ç›¸å…³å…ƒç´ 
        if (paymentInfo) {
          paymentInfo.style.display = "none";
          paymentInfo.style.setProperty("display", "none", "important");
        }
        if (payButton) {
          payButton.style.display = "none";
          payButton.style.setProperty("display", "none", "important");
        }
        if (paidNotice) {
          paidNotice.style.display = "block";
          paidNotice.style.setProperty("display", "block", "important");
        }
        
        // æ›´æ–°é¢„è§ˆæŒ‰é’®
        if (previewLinks) {
          const previewBtn = previewLinks.querySelector('.preview-btn');
          if (previewBtn) {
            previewBtn.textContent = "æŸ¥çœ‹æ­£å¼ç‰ˆæ–‡æ¡£";
            const downloadToken = data.download_token || documentId;
            previewBtn.onclick = () => {
              window.open(`/documents/${documentId}/download?token=${encodeURIComponent(downloadToken)}`, '_blank');
            };
          }
          
          // æ£€æŸ¥å¹¶æ·»åŠ ä¸‹è½½æŒ‰é’®
          const existingBtn = previewLinks.querySelector('.download-btn');
          if (!existingBtn) {
            const finalLink = document.createElement("a");
            const downloadToken = data.download_token || documentId;
            finalLink.href = `/documents/${documentId}/download?token=${encodeURIComponent(downloadToken)}`;
            finalLink.textContent = "â¬‡ï¸ ä¸‹è½½æ­£å¼ç‰ˆæ–‡æ¡£ï¼ˆå·²ä»˜è´¹ï¼‰";
            finalLink.target = "_blank";
            finalLink.className = "download-btn";
            finalLink.style.cssText = "margin-left: 10px; padding: 15px 30px; background: #4CAF50; color: white; text-decoration: none; border-radius: 8px; display: inline-block; font-weight: bold; cursor: pointer; font-size: 16px; box-shadow: 0 4px 6px rgba(76, 175, 80, 0.3);";
            previewLinks.appendChild(finalLink);
            console.log("ä¸‹è½½æŒ‰é’®å·²æ·»åŠ ");
          }
        }
      }

      async function refreshDocumentStatus() {
        // å¦‚æœ latestDocumentId ä¸ºç©ºï¼Œå°è¯•ä»é¡µé¢å…ƒç´ æ¢å¤
        if (!latestDocumentId) {
          const docIdText = docIdSpan ? docIdSpan.textContent : null;
          if (docIdText && docIdText.trim()) {
            latestDocumentId = docIdText.trim();
            console.log("ä»é¡µé¢å…ƒç´ æ¢å¤ documentId:", latestDocumentId);
          } else {
            console.warn("refreshDocumentStatus: latestDocumentId ä¸ºç©ºï¼Œæ— æ³•åˆ·æ–°çŠ¶æ€");
            return;
          }
        }
        
        console.log("åˆ·æ–°æ–‡æ¡£çŠ¶æ€ï¼ŒdocumentId:", latestDocumentId);
        try {
          const response = await fetch(`/documents/${latestDocumentId}`);
          if (!response.ok) {
            const detail = await response.json();
            throw new Error(detail.detail || "è·å–æ–‡æ¡£ä¿¡æ¯å¤±è´¥");
          }
          const data = await response.json();
          console.log("æ–‡æ¡£è¯¦æƒ…æ•°æ®:", data);
          
          docIdSpan.textContent = data.document_id;
          docStatusSpan.textContent = data.status;
          docPaidSpan.textContent = data.paid ? "æ˜¯" : "å¦";

          // æ˜¾ç¤ºä¿®æ”¹æ‘˜è¦
          if (data.summary && data.summary.changes_summary) {
            const fieldNames = {
              "font_name": "å­—ä½“",
              "font_size": "å­—å·",
              "bold": "åŠ ç²—",
              "alignment": "å¯¹é½æ–¹å¼",
              "line_spacing": "è¡Œè·",
              "space_before": "æ®µå‰é—´è·",
              "space_after": "æ®µåé—´è·",
              "first_line_indent": "é¦–è¡Œç¼©è¿›",
              "left_indent": "å·¦ç¼©è¿›",
              "right_indent": "å³ç¼©è¿›",
            };
            
            let html = "<ul style='list-style: none; padding-left: 0;'>";
            const sorted = Object.entries(data.summary.changes_summary)
              .sort((a, b) => b[1] - a[1]);
            for (const [field, count] of sorted) {
              const fieldName = fieldNames[field] || field;
              html += `<li style='padding: 5px 0;'><strong>${fieldName}</strong>: ä¿®æ”¹äº† <strong style='color: #1976D2;'>${count}</strong> å¤„</li>`;
            }
            html += `</ul><p style='margin-top: 10px; font-weight: bold; color: #1976D2;'>æ€»è®¡ä¿®æ”¹äº† <strong>${data.summary.paragraphs_adjusted || 0}</strong> ä¸ªæ®µè½</p>`;
            changesContent.innerHTML = html;
            changesSummary.style.display = "block";
          } else {
            changesSummary.style.display = "none";
          }

          // æ˜¾ç¤ºå›¾ç‰‡æ£€æµ‹ç»“æœ
          if (data.summary && data.summary.figure_issues && data.summary.figure_issues.length > 0) {
            const issues = data.summary.figure_issues;
            let html = `<p style="color: #856404; font-weight: bold;">å‘ç° <strong>${issues.length}</strong> å¤„å›¾ç‰‡ç¼ºå°‘å›¾é¢˜ï¼š</p><ul style="list-style: none; padding-left: 0;">`;
            for (const issue of issues.slice(0, 10)) {
              html += `<li style="padding: 8px 0; border-bottom: 1px solid #ffc107;"><strong>ç¬¬ ${issue.paragraph_index + 1} æ®µ</strong>: ${issue.message}<br><small style="color: #666;">${issue.suggestion}</small></li>`;
            }
            if (issues.length > 10) {
              html += `<li style="padding: 8px 0; color: #666;">... è¿˜æœ‰ ${issues.length - 10} å¤„é—®é¢˜æœªæ˜¾ç¤º</li>`;
            }
            html += '</ul>';
            figureIssuesContent.innerHTML = html;
            figureIssues.style.display = "block";
          } else {
            figureIssues.style.display = "none";
          }

          // æ˜¾ç¤ºå‚è€ƒæ–‡çŒ®å¼•ç”¨æ£€æµ‹ç»“æœ
          const referenceIssues = document.getElementById("referenceIssues");
          const referenceIssuesContent = document.getElementById("referenceIssuesContent");
          if (data.summary && data.summary.reference_issues && data.summary.reference_issues.length > 0) {
            const issues = data.summary.reference_issues;
            let html = "";
            for (const issue of issues) {
              if (issue.type === "no_reference_section") {
                html += `<p style="color: #c62828; font-weight: bold;">âš ï¸ ${issue.message}</p><p style="color: #666; margin-top: 5px;">${issue.suggestion}</p>`;
              } else if (issue.type === "no_reference_items") {
                html += `<p style="color: #c62828; font-weight: bold;">âš ï¸ ${issue.message}</p><p style="color: #666; margin-top: 5px;">${issue.suggestion}</p>`;
              } else if (issue.type === "uncited_references") {
                html += `<p style="color: #c62828; font-weight: bold;">âš ï¸ ${issue.message}</p>`;
                if (issue.uncited_count) {
                  html += `<p style="color: #666; margin-top: 5px;">å‘ç° <strong style="color: #c62828;">${issue.uncited_count}</strong> æ¡å‚è€ƒæ–‡çŒ®åœ¨æ­£æ–‡ä¸­æœªè¢«å¼•ç”¨ï¼Œå·²åœ¨æ–‡æ¡£ä¸­æ ‡è®°ä¸º<strong style="color: #c62828;">çº¢è‰²</strong>ã€‚</p>`;
                }
                html += `<p style="color: #666; margin-top: 5px;"><strong>å»ºè®®ï¼š</strong>${issue.suggestion}</p>`;
                if (issue.uncited_references && issue.uncited_references.length > 0) {
                  html += `<p style="color: #666; margin-top: 10px; font-weight: bold;">æœªè¢«å¼•ç”¨çš„å‚è€ƒæ–‡çŒ®ï¼š</p><ul style="list-style: none; padding-left: 0; margin-top: 5px;">`;
                  for (const ref of issue.uncited_references) {
                    html += `<li style="padding: 5px 0; border-bottom: 1px solid #f44336;"><strong style="color: #c62828;">[${ref.number}]</strong>: ${ref.text_preview}</li>`;
                  }
                  if (issue.uncited_count > issue.uncited_references.length) {
                    html += `<li style="padding: 5px 0; color: #666;">... è¿˜æœ‰ ${issue.uncited_count - issue.uncited_references.length} æ¡æœªè¢«å¼•ç”¨çš„å‚è€ƒæ–‡çŒ®</li>`;
                  }
                  html += '</ul>';
                }
              } else if (issue.type === "insufficient_references") {
                html += `<p style="color: #c62828; font-weight: bold;">âš ï¸ ${issue.message}</p>`;
                if (issue.current_count !== undefined && issue.required_count !== undefined) {
                  html += `<p style="color: #666; margin-top: 5px;">å½“å‰æœ‰ <strong style="color: #c62828;">${issue.current_count}</strong> ç¯‡å‚è€ƒæ–‡çŒ®ï¼Œéœ€è¦è‡³å°‘ <strong style="color: #c62828;">${issue.required_count}</strong> ç¯‡ï¼Œè¿˜ç¼ºå°‘ <strong style="color: #c62828;">${issue.missing_count}</strong> ç¯‡ã€‚</p>`;
                }
                html += `<p style="color: #666; margin-top: 5px;"><strong>å»ºè®®ï¼š</strong>${issue.suggestion}</p>`;
              } else if (issue.type === "missing_citations") {
                html += `<p style="color: #c62828; font-weight: bold;">âš ï¸ ${issue.message}</p>`;
                if (issue.reference_count) {
                  html += `<p style="color: #666; margin-top: 5px;">å‘ç° <strong>${issue.reference_count}</strong> æ¡å‚è€ƒæ–‡çŒ®ï¼Œä½†æ­£æ–‡ä¸­æœªæ‰¾åˆ°å¼•ç”¨æ ‡æ³¨ã€‚</p>`;
                }
                html += `<p style="color: #666; margin-top: 5px;"><strong>å»ºè®®ï¼š</strong>${issue.suggestion}</p>`;
                if (issue.missing_citation_paragraphs && issue.missing_citation_paragraphs.length > 0) {
                  html += `<p style="color: #666; margin-top: 10px; font-weight: bold;">å¯èƒ½ç¼ºå°‘å¼•ç”¨çš„æ®µè½ï¼š</p><ul style="list-style: none; padding-left: 0; margin-top: 5px;">`;
                  for (const para of issue.missing_citation_paragraphs) {
                    html += `<li style="padding: 5px 0; border-bottom: 1px solid #f44336;"><strong>ç¬¬ ${para.paragraph_index + 1} æ®µ</strong>: ${para.text_preview}</li>`;
                  }
                  html += '</ul>';
                }
              }
            }
            referenceIssuesContent.innerHTML = html;
            referenceIssues.style.display = "block";
          } else {
            referenceIssues.style.display = "none";
          }

          // æ˜¾ç¤ºç©ºç™½æ£€æµ‹ç»“æœ
          const blankIssues = document.getElementById("blankIssues");
          const blankIssuesContent = document.getElementById("blankIssuesContent");
          if (data.summary && data.summary.blank_issues && data.summary.blank_issues.length > 0) {
            const issues = data.summary.blank_issues;
            let html = "";
            for (const issue of issues) {
              if (issue.type === "excessive_blanks_in_chapter") {
                html += `<p style="color: #e65100; font-weight: bold; margin-top: 10px;">âš ï¸ ${issue.message}</p>`;
                html += `<p style="color: #666; margin-top: 5px;"><strong>å»ºè®®ï¼š</strong>${issue.suggestion}</p>`;
                if (issue.paragraph_indices && issue.paragraph_indices.length > 0) {
                  html += `<p style="color: #666; margin-top: 5px;">æ¶‰åŠæ®µè½ï¼šç¬¬ ${issue.paragraph_indices[0] + 1} æ®µåˆ°ç¬¬ ${issue.paragraph_indices[issue.paragraph_indices.length - 1] + 1} æ®µï¼ˆå…± ${issue.blank_count} ä¸ªç©ºç™½æ®µè½ï¼‰</p>`;
                }
              }
            }
            blankIssuesContent.innerHTML = html;
            blankIssues.style.display = "block";
          } else {
            blankIssues.style.display = "none";
          }

          previewLinks.innerHTML = "";
          
          // é¢„è§ˆæŒ‰é’®ï¼ˆæ ¹æ®æ”¯ä»˜çŠ¶æ€æ˜¾ç¤ºä¸åŒæ–‡æœ¬ï¼‰
          const previewBtn = document.createElement("button");
          if (data.paid) {
            // å·²æ”¯ä»˜ï¼Œæ˜¾ç¤ºæ­£å¼ç‰ˆæŸ¥çœ‹æŒ‰é’®
            previewBtn.textContent = "æŸ¥çœ‹æ­£å¼ç‰ˆæ–‡æ¡£";
            previewBtn.className = "preview-btn";
            previewBtn.onclick = () => {
              // å·²æ”¯ä»˜åï¼Œé¢„è§ˆé¡µé¢åº”è¯¥æ˜¾ç¤ºæ­£å¼ç‰ˆï¼ˆä¸å¸¦æ°´å°ï¼‰
              // æˆ–è€…ç›´æ¥æ‰“å¼€ä¸‹è½½é“¾æ¥
              const downloadToken = data.download_token || data.document_id;
              window.open(`/documents/${data.document_id}/download?token=${encodeURIComponent(downloadToken)}`, '_blank');
            };
          } else {
            // æœªæ”¯ä»˜ï¼Œæ˜¾ç¤ºé¢„è§ˆæŒ‰é’®ï¼ˆä»…æŸ¥çœ‹ï¼Œä¸å¯ä¸‹è½½ï¼‰
            previewBtn.textContent = "é¢„è§ˆæ–‡æ¡£ï¼ˆä»…æŸ¥çœ‹ï¼Œä¸å¯ä¸‹è½½ï¼‰";
            previewBtn.className = "preview-btn";
            previewBtn.onclick = () => {
              window.open(`/documents/${data.document_id}/preview`, '_blank', 'width=1200,height=800');
            };
          }
          previewLinks.appendChild(previewBtn);

          // å¤„ç†å·²æ”¯ä»˜çŠ¶æ€
          if (data.paid) {
            console.log("æ–‡æ¡£å·²æ”¯ä»˜ï¼Œå‡†å¤‡æ˜¾ç¤ºä¸‹è½½æŒ‰é’®", { 
              document_id: data.document_id, 
              download_token: data.download_token,
              previewLinks: !!previewLinks 
            });
            
            // éšè—æ‰€æœ‰æ”¯ä»˜ç›¸å…³å…ƒç´ 
            if (paymentInfo) paymentInfo.style.display = "none";
            if (payButton) payButton.style.display = "none";
            if (paidNotice) paidNotice.style.display = "block";
            
            // æ›´æ–°"å·²ä»˜è´¹"çŠ¶æ€æ˜¾ç¤º
            if (docPaidSpan) {
              docPaidSpan.textContent = "æ˜¯";
              docPaidSpan.style.color = "#4CAF50";
              docPaidSpan.style.fontWeight = "bold";
            }
            
            // ä» metadata ä¸­è·å–ä¸‹è½½ tokenï¼ˆæ”¯ä»˜æˆåŠŸåï¼Œtoken åœ¨ metadata ä¸­ï¼‰
            let downloadToken = data.download_token || localStorage.getItem(`download_token_${data.document_id}`);
            
            // ç¡®ä¿ previewLinks å…ƒç´ å­˜åœ¨
            if (!previewLinks) {
              console.error("previewLinks å…ƒç´ ä¸å­˜åœ¨ï¼");
              return;
            }
            
            // æ£€æŸ¥æ˜¯å¦å·²ç»æ·»åŠ äº†ä¸‹è½½æŒ‰é’®ï¼ˆé¿å…é‡å¤æ·»åŠ ï¼‰
            const existingDownloadBtn = previewLinks.querySelector('.download-btn');
            if (existingDownloadBtn) {
              console.log("ä¸‹è½½æŒ‰é’®å·²å­˜åœ¨ï¼Œè·³è¿‡æ·»åŠ ");
              // æ›´æ–°ç°æœ‰æŒ‰é’®çš„hrefï¼ˆç¡®ä¿tokenæ­£ç¡®ï¼‰
              if (downloadToken && downloadToken !== data.document_id) {
                existingDownloadBtn.href = `/documents/${data.document_id}/download?token=${encodeURIComponent(downloadToken)}`;
              }
              return;
            }
            
            // æ˜¾ç¤ºä¸‹è½½é“¾æ¥ï¼ˆå¤§æŒ‰é’®ï¼Œçªå‡ºæ˜¾ç¤ºï¼‰
            const finalLink = document.createElement("a");
            if (downloadToken && downloadToken !== data.document_id) {
              // æœ‰ tokenï¼Œä½¿ç”¨ token ä¸‹è½½
              finalLink.href = `/documents/${data.document_id}/download?token=${encodeURIComponent(downloadToken)}`;
              localStorage.setItem(`download_token_${data.document_id}`, downloadToken);
            } else {
              // æ²¡æœ‰ tokenï¼Œä½¿ç”¨æ–‡æ¡£IDä½œä¸ºä¸´æ—¶tokenï¼ˆåç«¯ä¼šéªŒè¯æ”¯ä»˜çŠ¶æ€ï¼‰
              finalLink.href = `/documents/${data.document_id}/download?token=${data.document_id}`;
              console.warn("ä¸‹è½½ token æœªæ‰¾åˆ°ï¼Œä½¿ç”¨æ–‡æ¡£IDä½œä¸ºä¸´æ—¶token");
            }
            
            finalLink.textContent = "â¬‡ï¸ ä¸‹è½½æ­£å¼ç‰ˆæ–‡æ¡£ï¼ˆå·²ä»˜è´¹ï¼‰";
            finalLink.target = "_blank";
            finalLink.className = "download-btn";
            finalLink.style.cssText = "margin-left: 10px; padding: 15px 30px; background: #4CAF50; color: white; text-decoration: none; border-radius: 8px; display: inline-block; font-weight: bold; cursor: pointer; font-size: 16px; box-shadow: 0 4px 6px rgba(76, 175, 80, 0.3); transition: all 0.3s;";
            
            // æ·»åŠ æ‚¬åœæ•ˆæœ
            finalLink.onmouseover = function() {
              this.style.background = "#45a049";
              this.style.transform = "translateY(-2px)";
              this.style.boxShadow = "0 6px 12px rgba(76, 175, 80, 0.4)";
            };
            finalLink.onmouseout = function() {
              this.style.background = "#4CAF50";
              this.style.transform = "translateY(0)";
              this.style.boxShadow = "0 4px 6px rgba(76, 175, 80, 0.3)";
            };
            
            previewLinks.appendChild(finalLink);
            
            console.log("ä¸‹è½½æŒ‰é’®å·²æ·»åŠ ", { 
              href: finalLink.href, 
              hasToken: !!downloadToken,
              previewLinksChildren: previewLinks.children.length
            });
          } else {
            // æœªæ”¯ä»˜ï¼Œç¡®ä¿æ”¯ä»˜ä¿¡æ¯æ˜¾ç¤º
            if (paidNotice) paidNotice.style.display = "none";
            if (docPaidSpan) {
              docPaidSpan.textContent = "å¦";
              docPaidSpan.style.color = "#666";
            }
          }

          resultCard.style.display = "block";
          resultStatus.style.display = "none";
          
          // æ ¹æ®æ”¯ä»˜çŠ¶æ€å†³å®šæ˜¯å¦åŠ è½½æ”¯ä»˜ä¿¡æ¯
          if (data.paid) {
            // å·²æ”¯ä»˜ï¼Œç¡®ä¿æ”¯ä»˜ä¿¡æ¯éšè—ï¼Œä¸åŠ è½½æ”¯ä»˜ä¿¡æ¯
            console.log("æ–‡æ¡£å·²æ”¯ä»˜ï¼Œè·³è¿‡åŠ è½½æ”¯ä»˜ä¿¡æ¯ï¼Œç¡®ä¿æ”¯ä»˜ä¿¡æ¯éšè—");
            if (paymentInfo) {
              paymentInfo.style.display = "none";
              console.log("æ”¯ä»˜ä¿¡æ¯å·²éšè—");
            }
            if (payButton) {
              payButton.style.display = "none";
              console.log("æ”¯ä»˜æŒ‰é’®å·²éšè—");
            }
            if (paidNotice) {
              paidNotice.style.display = "block";
              console.log("å·²æ”¯ä»˜æç¤ºå·²æ˜¾ç¤º");
            }
          } else {
            // æœªæ”¯ä»˜ï¼ŒåŠ è½½æ”¯ä»˜ä¿¡æ¯
            console.log("å‡†å¤‡åŠ è½½æ”¯ä»˜ä¿¡æ¯ï¼ŒdocumentId:", data.document_id, "paid:", data.paid);
            try {
              await loadPaymentInfo(data.document_id, data.paid);
              console.log("æ”¯ä»˜ä¿¡æ¯åŠ è½½å®Œæˆï¼Œå‡½æ•°å·²è¿”å›");
            } catch (paymentError) {
              console.error("åŠ è½½æ”¯ä»˜ä¿¡æ¯æ—¶å‡ºé”™:", paymentError);
              // å³ä½¿å‡ºé”™ï¼Œä¹Ÿæ˜¾ç¤ºé»˜è®¤æ”¯ä»˜ä¿¡æ¯
              console.log("ä½¿ç”¨é»˜è®¤æ”¯ä»˜ä¿¡æ¯");
              showDefaultPaymentInfo(data.document_id);
            }
          }
        } catch (error) {
          console.error("åˆ·æ–°æ–‡æ¡£çŠ¶æ€æ—¶å‡ºé”™:", error);
          showMessage(resultStatus, error.message, true);
        }
      }

      // åŠ è½½æ”¯ä»˜ä¿¡æ¯
      async function loadPaymentInfo(documentId, isPaid) {
        if (!documentId) {
          console.error("loadPaymentInfo: documentId ä¸ºç©º");
          return;
        }

        if (isPaid) {
          // å·²æ”¯ä»˜ï¼Œæ˜¾ç¤ºæç¤º
          paymentInfo.style.display = "none";
          payButton.style.display = "none";
          paidNotice.style.display = "block";
          return;
        }

        try {
          console.log("æ­£åœ¨åŠ è½½æ”¯ä»˜ä¿¡æ¯ï¼ŒdocumentId:", documentId);
          const response = await fetch(`/payments/info/${documentId}`);
          console.log("æ”¯ä»˜ä¿¡æ¯ API å“åº”çŠ¶æ€:", response.status);
          
          if (!response.ok) {
            const errorText = await response.text();
            console.error("è·å–æ”¯ä»˜ä¿¡æ¯å¤±è´¥:", response.status, errorText);
            // å³ä½¿å¤±è´¥ï¼Œä¹Ÿæ˜¾ç¤ºé»˜è®¤æ”¯ä»˜ä¿¡æ¯
            showDefaultPaymentInfo(documentId);
            return;
          }
          
          const paymentData = await response.json();
          console.log("æ”¯ä»˜ä¿¡æ¯æ•°æ®:", paymentData);
          console.log("å¯ç”¨æ”¯ä»˜æ–¹å¼:", paymentData.payment_methods);
          
          // æ˜¾ç¤ºæ”¯ä»˜é‡‘é¢
          paymentAmount.textContent = `Â¥${paymentData.amount.toFixed(2)}`;
          
          // æ˜¾ç¤ºæ”¯ä»˜æ–¹å¼
          paymentMethods.innerHTML = "";
          let selectedMethod = paymentData.payment_methods[0] || null;
          
          // æ£€æŸ¥æ”¯ä»˜æ–¹å¼åˆ—è¡¨æ˜¯å¦ä¸ºç©º
          if (!paymentData.payment_methods || paymentData.payment_methods.length === 0) {
            console.warn("æ”¯ä»˜æ–¹å¼åˆ—è¡¨ä¸ºç©º");
            paymentMethods.innerHTML = "";
            const noMethodDiv = document.createElement("div");
            noMethodDiv.style.padding = "15px";
            noMethodDiv.style.backgroundColor = "#fff3cd";
            noMethodDiv.style.border = "2px solid #ffc107";
            noMethodDiv.style.borderRadius = "5px";
            noMethodDiv.style.color = "#856404";
            noMethodDiv.textContent = "âš ï¸ æœªé…ç½®ä»»ä½•æ”¯ä»˜æ–¹å¼ï¼Œè¯·è”ç³»ç®¡ç†å‘˜";
            paymentMethods.appendChild(noMethodDiv);
            paymentInfo.style.display = "block";
            payButton.style.display = "none";
            return;
          }
          
          console.log("å¼€å§‹æ¸²æŸ“æ”¯ä»˜æ–¹å¼ï¼Œæ•°é‡:", paymentData.payment_methods.length);
          paymentData.payment_methods.forEach(method => {
            console.log("æ¸²æŸ“æ”¯ä»˜æ–¹å¼:", method);
            const methodDiv = document.createElement("div");
            methodDiv.style.marginBottom = "10px";
            
            const label = document.createElement("label");
            label.style.display = "flex";
            label.style.alignItems = "center";
            label.style.cursor = "pointer";
            label.style.padding = "10px";
            label.style.border = "2px solid #ddd";
            label.style.borderRadius = "5px";
            label.style.backgroundColor = "#fff";
            label.style.transition = "all 0.3s";
            
            const radio = document.createElement("input");
            radio.type = "radio";
            radio.id = `paymentMethod_${method}`;
            radio.name = "paymentMethod";
            radio.value = method;
            radio.style.marginRight = "10px";
            
            if (method === selectedMethod) {
              radio.checked = true;
              label.style.borderColor = "#4CAF50";
              label.style.backgroundColor = "#f1f8f4";
            }
            
             const methodName = {
               "payjs": "PayJS æ”¯ä»˜ï¼ˆæ”¯ä»˜å®/å¾®ä¿¡ï¼‰",
               "alipay": "æ”¯ä»˜å®",
               "wechat": "å¾®ä¿¡æ”¯ä»˜",
               "stripe": "Stripeï¼ˆå›½é™…æ”¯ä»˜ï¼‰"
             }[method] || method;
            
            label.appendChild(radio);
            label.appendChild(document.createTextNode(methodName));
            
            // ç‚¹å‡»æ—¶æ›´æ–°é€‰ä¸­çŠ¶æ€
            label.addEventListener("click", (e) => {
              // æ›´æ–°æ‰€æœ‰å•é€‰æŒ‰é’®
              document.querySelectorAll('input[name="paymentMethod"]').forEach(r => {
                r.checked = false;
                r.closest('label').style.borderColor = "#ddd";
                r.closest('label').style.backgroundColor = "#fff";
              });
              
              radio.checked = true;
              selectedMethod = method;
              label.style.borderColor = "#4CAF50";
              label.style.backgroundColor = "#f1f8f4";
            });
            
            methodDiv.appendChild(label);
            paymentMethods.appendChild(methodDiv);
          });
          
          // æ˜¾ç¤ºæ”¯ä»˜ç•Œé¢
          console.log("å‡†å¤‡æ˜¾ç¤ºæ”¯ä»˜ç•Œé¢");
          paymentInfo.style.display = "block";
          payButton.style.display = "block";
          paidNotice.style.display = "none";
          console.log("æ”¯ä»˜ç•Œé¢å·²æ˜¾ç¤ºï¼ŒpayButtonå­˜åœ¨:", !!payButton);
          
          // æ›´æ–°æ”¯ä»˜æŒ‰é’®äº‹ä»¶
          console.log("è®¾ç½®æ”¯ä»˜æŒ‰é’®äº‹ä»¶ï¼ŒdocumentId:", documentId, "selectedMethod:", selectedMethod, "payButton:", payButton);
          payButton.onclick = function(e) {
            e.preventDefault();
            e.stopPropagation();
            console.log("æ”¯ä»˜æŒ‰é’®onclickäº‹ä»¶è§¦å‘");
            
            // ç¡®ä¿ documentId å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™ä»é¡µé¢å…ƒç´ è·å–
            let currentDocumentId = documentId;
            if (!currentDocumentId) {
              const docIdText = docIdSpan ? docIdSpan.textContent : null;
              if (docIdText && docIdText.trim()) {
                currentDocumentId = docIdText.trim();
                console.log("ä»é¡µé¢å…ƒç´ è·å– documentId:", currentDocumentId);
              } else {
                console.error("æ— æ³•è·å– documentIdï¼Œæ”¯ä»˜æŒ‰é’®ç‚¹å‡»å¤±è´¥");
                showMessage(resultStatus, "æ— æ³•è·å–æ–‡æ¡£IDï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•", true);
                return;
              }
            }
            
            const selected = document.querySelector('input[name="paymentMethod"]:checked');
            const methodValue = selected ? selected.value : selectedMethod;
            console.log("æ”¯ä»˜æŒ‰é’®ç‚¹å‡»ï¼Œé€‰ä¸­çš„æ”¯ä»˜æ–¹å¼:", methodValue, "selected:", selected, "selectedMethod:", selectedMethod);
            console.log("æ‰€æœ‰æ”¯ä»˜æ–¹å¼radio:", document.querySelectorAll('input[name="paymentMethod"]'));
            console.log("ä½¿ç”¨çš„ documentId:", currentDocumentId);
            handlePayment(currentDocumentId, methodValue);
          };
          console.log("æ”¯ä»˜æŒ‰é’®äº‹ä»¶è®¾ç½®å®Œæˆ");
        } catch (error) {
          console.error("åŠ è½½æ”¯ä»˜ä¿¡æ¯å¤±è´¥:", error);
          console.error("é”™è¯¯è¯¦æƒ…:", error.stack);
          // å³ä½¿å‡ºé”™ï¼Œä¹Ÿæ˜¾ç¤ºé»˜è®¤æ”¯ä»˜ä¿¡æ¯
          showDefaultPaymentInfo(documentId);
        }
      }

      // æ˜¾ç¤ºé»˜è®¤æ”¯ä»˜ä¿¡æ¯ï¼ˆå½“ API å¤±è´¥æ—¶ä½¿ç”¨ï¼‰
      function showDefaultPaymentInfo(documentId) {
        console.log("æ˜¾ç¤ºé»˜è®¤æ”¯ä»˜ä¿¡æ¯");
        // æ˜¾ç¤ºé»˜è®¤ä»·æ ¼
        paymentAmount.textContent = "Â¥9.90";
        
          // å¦‚æœæ²¡æœ‰æ”¯ä»˜æ–¹å¼ï¼Œæ˜¾ç¤ºæç¤º
          paymentMethods.innerHTML = "";
          const noMethodDiv = document.createElement("div");
          noMethodDiv.style.padding = "15px";
          noMethodDiv.style.backgroundColor = "#fff3cd";
          noMethodDiv.style.border = "2px solid #ffc107";
          noMethodDiv.style.borderRadius = "5px";
          noMethodDiv.style.color = "#856404";
          noMethodDiv.textContent = "âš ï¸ æœªé…ç½®ä»»ä½•æ”¯ä»˜æ–¹å¼ï¼Œè¯·è”ç³»ç®¡ç†å‘˜";
          paymentMethods.appendChild(noMethodDiv);
        
        // æ˜¾ç¤ºæ”¯ä»˜ç•Œé¢
        paymentInfo.style.display = "block";
        payButton.style.display = "block";
        paidNotice.style.display = "none";
        
        // æ›´æ–°æ”¯ä»˜æŒ‰é’®äº‹ä»¶
        console.log("è®¾ç½®é»˜è®¤æ”¯ä»˜æŒ‰é’®äº‹ä»¶ï¼ˆmockæ”¯ä»˜ï¼‰");
        payButton.onclick = function(e) {
          e.preventDefault();
          e.stopPropagation();
          console.log("é»˜è®¤æ”¯ä»˜æŒ‰é’®onclickäº‹ä»¶è§¦å‘ï¼ˆmockæ”¯ä»˜ï¼‰");
          
          // ç¡®ä¿ documentId å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™ä»é¡µé¢å…ƒç´ è·å–
          let currentDocumentId = documentId;
          if (!currentDocumentId) {
            const docIdText = docIdSpan ? docIdSpan.textContent : null;
            if (docIdText && docIdText.trim()) {
              currentDocumentId = docIdText.trim();
              console.log("ä»é¡µé¢å…ƒç´ è·å– documentId:", currentDocumentId);
            } else {
              console.error("æ— æ³•è·å– documentIdï¼Œæ”¯ä»˜æŒ‰é’®ç‚¹å‡»å¤±è´¥");
              showMessage(resultStatus, "æ— æ³•è·å–æ–‡æ¡£IDï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•", true);
              return;
            }
          }
          
          console.log("ä½¿ç”¨çš„ documentId:", currentDocumentId);
          handlePayment(currentDocumentId, "mock");
        };
      }

      // å¤„ç†æ”¯ä»˜
      async function handlePayment(documentId, paymentMethod) {
        // å¦‚æœ documentId ä¸ºç©ºï¼Œå°è¯•ä»é¡µé¢å…ƒç´ è·å–
        if (!documentId) {
          const docIdText = docIdSpan ? docIdSpan.textContent : null;
          if (docIdText && docIdText.trim()) {
            documentId = docIdText.trim();
            console.log("handlePayment: ä»é¡µé¢å…ƒç´ è·å– documentId:", documentId);
          } else {
            console.error("handlePayment: documentId ä¸ºç©ºï¼Œæ— æ³•å¤„ç†æ”¯ä»˜");
            showMessage(resultStatus, "æ— æ³•è·å–æ–‡æ¡£IDï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•", true);
            return;
          }
        }
        
        if (!paymentMethod) {
          showMessage(resultStatus, "è¯·é€‰æ‹©æ”¯ä»˜æ–¹å¼", true);
          return;
        }

        // ç»Ÿä¸€è½¬æ¢ä¸ºå°å†™ï¼Œç¡®ä¿å¤§å°å†™ä¸æ•æ„Ÿ
        if (paymentMethod && typeof paymentMethod === 'string') {
          paymentMethod = paymentMethod.toLowerCase().trim();
        }
        console.log("handlePayment: documentId:", documentId, "paymentMethod:", paymentMethod, "ç±»å‹:", typeof paymentMethod);

        try {
          showMessage(resultStatus, "å¤„ç†æ”¯ä»˜ä¸­...", false);
          
          if (paymentMethod === "payjs") {
            // PayJS æ”¯ä»˜
            const response = await fetch("/payments/payjs/create", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ 
                document_id: documentId,
                payment_method: "payjs"
              }),
            });
            
            if (!response.ok) {
              const detail = await response.json();
              throw new Error(detail.detail || "åˆ›å»ºæ”¯ä»˜è®¢å•å¤±è´¥");
            }
            
            const paymentData = await response.json();
            
            // è·³è½¬åˆ° PayJS æ”¶é“¶å°
            if (paymentData.payment_url) {
              // æ‰“å¼€æ–°çª—å£è¿›è¡Œæ”¯ä»˜
              const payWindow = window.open(paymentData.payment_url, '_blank', 'width=800,height=600');
              
              // è½®è¯¢æ£€æŸ¥æ”¯ä»˜çŠ¶æ€
              const checkInterval = setInterval(async () => {
                try {
                  const statusResponse = await fetch(`/documents/${documentId}/status`);
                  const statusData = await statusResponse.json();
                  
                  if (statusData.paid) {
                    clearInterval(checkInterval);
                    payWindow?.close();
                    showMessage(resultStatus, "æ”¯ä»˜æˆåŠŸï¼Œæ­£å¼ç‰ˆå·²è§£é”ï¼", false);
                    await refreshDocumentStatus();
                  }
                } catch (error) {
                  console.error("æ£€æŸ¥æ”¯ä»˜çŠ¶æ€å¤±è´¥:", error);
                }
              }, 3000); // æ¯3ç§’æ£€æŸ¥ä¸€æ¬¡
              
              // 30åˆ†é’Ÿååœæ­¢æ£€æŸ¥
              setTimeout(() => {
                clearInterval(checkInterval);
              }, 30 * 60 * 1000);
              
              showMessage(resultStatus, "æ­£åœ¨è·³è½¬åˆ°æ”¯ä»˜é¡µé¢...", false);
            } else {
              throw new Error("æœªè·å–åˆ°æ”¯ä»˜é“¾æ¥");
            }
          } else if (paymentMethod === "wechat") {
            // å¾®ä¿¡æ”¯ä»˜ï¼ˆH5æ”¯ä»˜æˆ–æ‰«ç æ”¯ä»˜ï¼‰
            const response = await fetch("/payments/wechat/create", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ 
                document_id: documentId,
                payment_method: "wechat"
              }),
            });
            
            if (!response.ok) {
              const detail = await response.json();
              throw new Error(detail.detail || "åˆ›å»ºæ”¯ä»˜è®¢å•å¤±è´¥");
            }
            
            const paymentData = await response.json();
            
            if (paymentData.payment_url) {
              if (paymentData.payment_type === "native") {
                // Nativeæ”¯ä»˜ï¼ˆæ‰«ç æ”¯ä»˜ï¼‰- æ˜¾ç¤ºäºŒç»´ç 
                showMessage(resultStatus, "è¯·ä½¿ç”¨å¾®ä¿¡æ‰«ç æ”¯ä»˜", false);
                
                // åˆ›å»ºäºŒç»´ç æ˜¾ç¤ºåŒºåŸŸ
                const qrCodeDiv = document.createElement("div");
                qrCodeDiv.style.cssText = "text-align: center; padding: 20px; background: #fff; border-radius: 5px; margin: 20px 0;";
                qrCodeDiv.innerHTML = `
                  <p style="margin-bottom: 15px; font-weight: bold; color: #1976D2;">è¯·ä½¿ç”¨å¾®ä¿¡æ‰«ç æ”¯ä»˜</p>
                  <img src="https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${encodeURIComponent(paymentData.payment_url)}" 
                       alt="å¾®ä¿¡æ”¯ä»˜äºŒç»´ç " 
                       style="max-width: 300px; border: 2px solid #ddd; padding: 10px; background: #fff;">
                  <p style="margin-top: 15px; color: #666; font-size: 14px;">æ”¯ä»˜å®Œæˆåï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨æ›´æ–°è®¢å•çŠ¶æ€</p>
                `;
                
                // å°†äºŒç»´ç æ’å…¥åˆ°æ”¯ä»˜ä¿¡æ¯åŒºåŸŸ
                const paymentInfo = document.getElementById("paymentInfo");
                if (paymentInfo) {
                  paymentInfo.appendChild(qrCodeDiv);
                }
                
                // è½®è¯¢æ£€æŸ¥æ”¯ä»˜çŠ¶æ€
                const checkInterval = setInterval(async () => {
                  try {
                    const statusResponse = await fetch(`/documents/${documentId}/status`);
                    const statusData = await statusResponse.json();
                    
                    if (statusData.paid) {
                      clearInterval(checkInterval);
                      qrCodeDiv.remove();
                      showMessage(resultStatus, "æ”¯ä»˜æˆåŠŸï¼Œæ­£å¼ç‰ˆå·²è§£é”ï¼", false);
                      await refreshDocumentStatus();
                    }
                  } catch (error) {
                    console.error("æ£€æŸ¥æ”¯ä»˜çŠ¶æ€å¤±è´¥:", error);
                  }
                }, 3000); // æ¯3ç§’æ£€æŸ¥ä¸€æ¬¡
                
                // 30åˆ†é’Ÿååœæ­¢æ£€æŸ¥
                setTimeout(() => {
                  clearInterval(checkInterval);
                }, 30 * 60 * 1000);
              } else {
                // H5æ”¯ä»˜ - ç›´æ¥è·³è½¬
                window.location.href = paymentData.payment_url;
              }
            } else {
              throw new Error("æœªè·å–åˆ°æ”¯ä»˜é“¾æ¥");
            }
          } else if (paymentMethod === "alipay" || paymentMethod === "æ”¯ä»˜å®" || (paymentMethod && paymentMethod.includes && paymentMethod.includes("alipay"))) {
            // æ”¯ä»˜å®æ”¯ä»˜ï¼ˆæ‰‹æœºç½‘ç«™æ”¯ä»˜ï¼‰
            console.log("å¼€å§‹åˆ›å»ºæ”¯ä»˜å®æ”¯ä»˜è®¢å•...", "paymentMethod:", paymentMethod);
            const response = await fetch("/payments/alipay/create", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ 
                document_id: documentId,
                payment_method: "alipay"
              }),
            });
            
            if (!response.ok) {
              const detail = await response.json();
              throw new Error(detail.detail || "åˆ›å»ºæ”¯ä»˜è®¢å•å¤±è´¥");
            }
            
            const paymentData = await response.json();
            
            if (paymentData.payment_url) {
              // æ”¯ä»˜å®æ”¯ä»˜ - ç›´æ¥è·³è½¬åˆ°æ”¯ä»˜é¡µé¢
              showMessage(resultStatus, "æ­£åœ¨è·³è½¬åˆ°æ”¯ä»˜å®æ”¯ä»˜é¡µé¢...", false);
              window.location.href = paymentData.payment_url;
            } else {
              throw new Error("æœªè·å–åˆ°æ”¯ä»˜é“¾æ¥");
            }
          } else {
            // å…¶ä»–æ”¯ä»˜æ–¹å¼ï¼ˆå¾…å®ç°ï¼‰
            console.error("æœªåŒ¹é…çš„æ”¯ä»˜æ–¹å¼:", paymentMethod, "ç±»å‹:", typeof paymentMethod);
            console.error("æ‰€æœ‰æ”¯ä»˜æ–¹å¼æ£€æŸ¥:", {
              "mock": paymentMethod === "mock",
              "payjs": paymentMethod === "payjs",
              "wechat": paymentMethod === "wechat",
              "alipay": paymentMethod === "alipay",
              "æ”¯ä»˜å®": paymentMethod === "æ”¯ä»˜å®",
              "includes alipay": paymentMethod.includes && paymentMethod.includes("alipay")
            });
            showMessage(resultStatus, `${paymentMethod} æ”¯ä»˜åŠŸèƒ½å¼€å‘ä¸­...`, true);
          }
        } catch (error) {
          console.error("æ”¯ä»˜é”™è¯¯:", error);
          showMessage(resultStatus, error.message || "æ”¯ä»˜å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•", true);
        }
      }

    </script>
  </body>
</html>



