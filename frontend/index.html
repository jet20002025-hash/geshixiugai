<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>è®ºæ–‡æ ¼å¼è‡ªåŠ¨ä¿®å¤</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='.9em' font-size='90'%3EğŸ“„%3C/text%3E%3C/svg%3E" />
    <!-- ä¸å†ä½¿ç”¨Googleå­—ä½“ï¼Œä½¿ç”¨ç³»ç»Ÿé»˜è®¤å­—ä½“ç¡®ä¿æ˜¾ç¤º -->
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        margin: 2rem auto;
        max-width: 760px;
        line-height: 1.6;
      }
      h1,
      h2 {
        color: #16324f;
      }
      section {
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 6px 20px rgba(15, 23, 42, 0.04);
      }
      label {
        display: block;
        font-weight: 600;
        margin-bottom: 0.5rem;
      }
      input[type="file"],
      select,
      button {
        width: 100%;
        padding: 0.6rem;
        margin-bottom: 1rem;
        border-radius: 8px;
        border: 1px solid #d1d5db;
        font-size: 1rem;
      }
      button {
        background: linear-gradient(135deg, #2563eb, #1e3a8a);
        color: white;
        cursor: pointer;
        transition: transform 0.15s ease, box-shadow 0.15s ease;
        border: none;
      }
      button:hover {
        transform: translateY(-1px);
        box-shadow: 0 12px 24px rgba(37, 99, 235, 0.2);
      }
      .card-title {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 1rem;
      }
      .status {
        padding: 0.75rem;
        border-radius: 8px;
        background: #ecfdf5;
        border: 1px solid #10b98133;
        color: #047857;
        font-size: 0.95rem;
      }
      .status.error {
        background: #fef2f2;
        border-color: #dc262633;
        color: #b91c1c;
      }
      .list {
        background: #f9fafb;
        border-radius: 8px;
        padding: 1rem;
        border: 1px solid #e5e7eb;
      }
      .list ul {
        margin: 0;
        padding-left: 1.2rem;
      }
      .divider {
        height: 1px;
        margin: 1.5rem 0;
        background: linear-gradient(90deg, rgba(229, 231, 235, 0), rgba(209, 213, 219, 0.9), rgba(229, 231, 235, 0));
        border: none;
      }
      .small {
        font-size: 0.9rem;
        color: #6b7280;
      }
      .links a {
        display: inline-block;
        margin-right: 1rem;
        color: #2563eb;
        text-decoration: none;
      }
      /* ç¡®ä¿æ”¶æ¬¾è´¦æˆ·ä¿¡æ¯åŒºåŸŸå§‹ç»ˆéšè— */
      #paymentAccountInfo,
      #accountDetails,
      [id*="account"],
      [class*="account"] {
        display: none !important;
      }
      /* å¹¿å‘Šè¯­æ ·å¼ - è‰ä¹¦é£æ ¼ä½†æ¸…æ™° */
      .slogan {
        text-align: center;
        margin: 2rem 0 1.5rem 0;
        padding: 1.5rem;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 15px;
        box-shadow: 0 8px 32px rgba(102, 126, 234, 0.3);
        position: relative;
        overflow: hidden;
        display: block !important; /* å¼ºåˆ¶æ˜¾ç¤º */
        visibility: visible !important; /* ç¡®ä¿å¯è§ */
        opacity: 1 !important; /* ç¡®ä¿ä¸é€æ˜ */
        min-height: 80px; /* ç¡®ä¿æœ‰è¶³å¤Ÿé«˜åº¦ */
      }
      .slogan::before {
        content: '';
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.1), transparent);
        animation: shine 3s infinite;
      }
      @keyframes shine {
        0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
        100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
      }
      .slogan-text {
        font-family: Arial, "Microsoft YaHei", "SimHei", sans-serif !important; /* ä½¿ç”¨æœ€ç®€å•çš„ç³»ç»Ÿå­—ä½“ */
        font-size: 2.5rem !important;
        font-weight: bold !important;
        color: #ffffff !important; /* å¼ºåˆ¶ç™½è‰² */
        text-shadow: 
          2px 2px 4px rgba(0, 0, 0, 0.3),
          0 0 20px rgba(255, 255, 255, 0.5) !important;
        letter-spacing: 0.1em !important;
        position: relative !important;
        z-index: 1 !important;
        display: inline-block !important; /* å¼ºåˆ¶æ˜¾ç¤º */
        visibility: visible !important; /* ç¡®ä¿å¯è§ */
        opacity: 1 !important; /* ç¡®ä¿ä¸é€æ˜ */
        transform: rotate(-1deg) !important;
        animation: float 2s ease-in-out infinite !important;
      }
      @keyframes float {
        0%, 100% { transform: rotate(-1deg) translateY(0px); }
        50% { transform: rotate(1deg) translateY(-5px); }
      }
      .slogan-text::after {
        content: 'âš¡';
        display: inline-block;
        margin-left: 0.3em;
        animation: flash 1.5s ease-in-out infinite;
        font-size: 1.2em;
      }
      @keyframes flash {
        0%, 100% { opacity: 1; transform: scale(1); }
        50% { opacity: 0.7; transform: scale(1.2); }
      }
      @media (max-width: 768px) {
        .slogan-text {
          font-size: 1.8rem;
        }
      }
      /* ç¡®ä¿å¹¿å‘Šä¸è¢«éšè— - æœ€é«˜ä¼˜å…ˆçº§ */
      .slogan,
      .slogan * {
        display: block !important;
        visibility: visible !important;
        opacity: 1 !important;
      }
      .slogan-text {
        display: inline-block !important;
      }
    </style>
    <script>
      // ç«‹å³æ‰§è¡Œï¼Œä¸ç­‰å¾…DOMContentLoaded
      (function() {
        function ensureSloganVisible() {
          const slogan = document.querySelector('.slogan');
          if (slogan) {
            slogan.style.cssText = 'display: block !important; visibility: visible !important; opacity: 1 !important; min-height: 80px !important;';
            const sloganText = document.querySelector('.slogan-text');
            if (sloganText) {
              sloganText.style.cssText = 'display: inline-block !important; visibility: visible !important; opacity: 1 !important; color: #ffffff !important; font-family: Arial, "Microsoft YaHei", "SimHei", sans-serif !important; font-size: 2.5rem !important; font-weight: bold !important;';
            }
          }
        }
        
        // ç«‹å³æ‰§è¡Œ
        ensureSloganVisible();
        
        // DOMContentLoadedæ—¶å†æ¬¡æ‰§è¡Œ
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', ensureSloganVisible);
        } else {
          ensureSloganVisible();
        }
        
        // å»¶è¿Ÿæ‰§è¡Œï¼Œç¡®ä¿æ‰€æœ‰æ ·å¼éƒ½åº”ç”¨å
        setTimeout(ensureSloganVisible, 100);
        setTimeout(ensureSloganVisible, 500);
        setTimeout(ensureSloganVisible, 1000);
      })();
      
      // ä¸å†éœ€è¦å­—ä½“åŠ è½½æ£€æŸ¥ï¼Œç›´æ¥ä½¿ç”¨ç³»ç»Ÿå­—ä½“
    </script>
  </head>
  <body>
    <!-- å¹¿å‘Šè¯­ - ç¡®ä¿å§‹ç»ˆæ˜¾ç¤º -->
    <div class="slogan" style="display: block !important; visibility: visible !important; opacity: 1 !important; min-height: 80px !important;">
      <div class="slogan-text" style="display: inline-block !important; visibility: visible !important; opacity: 1 !important; color: #ffffff !important;">ä¸€ç§’è§£å†³ä½ çš„è®ºæ–‡æ ¼å¼é—®é¢˜ï¼</div>
    </div>
    
    <h1>è®ºæ–‡æ ¼å¼è‡ªåŠ¨ä¿®å¤</h1>
    <p class="small">æµç¨‹ï¼šä¸Šä¼ æ¨¡æ¿ â†’ ä¸Šä¼ å­¦ç”Ÿæ–‡æ¡£ â†’ é¢„è§ˆæ°´å°ç‰ˆ â†’ æ”¯ä»˜åä¸‹è½½æ­£å¼ç‰ˆã€‚</p>

    <section>
      <div class="card-title">
        <h2>1. ä¸Šä¼ æ¨¡æ¿</h2>
      </div>
      <form id="templateForm">
        <label for="templateFile">é€‰æ‹©æ¨¡æ¿ï¼ˆ.docxï¼‰</label>
        <input id="templateFile" type="file" accept=".docx" required />
        <button type="submit">ä¸Šä¼ æ¨¡æ¿</button>
      </form>
      <div id="templateStatus" class="status" style="display: none"></div>
    </section>

    <section>
      <div class="card-title">
        <h2>2. ä¸Šä¼ å­¦ç”Ÿæ–‡æ¡£</h2>
      </div>
      <form id="documentForm">
        <label for="templateSelect">é€‰æ‹©æ¨¡æ¿</label>
        <select id="templateSelect" required>
          <option value="">è¯·å…ˆä¸Šä¼ æ¨¡æ¿</option>
        </select>
        <label for="documentFile">é€‰æ‹©å­¦ç”Ÿæ–‡æ¡£ï¼ˆ.docxï¼‰</label>
        <input id="documentFile" type="file" accept=".docx" required />
        <button type="submit">ä¸Šä¼ å¹¶è‡ªåŠ¨ä¿®å¤</button>
      </form>
      <div id="documentStatus" class="status" style="display: none"></div>
    </section>

    <section>
      <div class="card-title">
        <h2>3. ä¸‹è½½ä¸æ”¯ä»˜</h2>
      </div>
      <div id="result" class="list" style="display: none">
        <p><strong>æ–‡æ¡£ IDï¼š</strong><span id="docId"></span></p>
        <p><strong>å¤„ç†çŠ¶æ€ï¼š</strong><span id="docStatus"></span></p>
        <p><strong>å·²ä»˜è´¹ï¼š</strong><span id="docPaid"></span></p>
        <div id="changesSummary" style="background: #e7f3ff; padding: 15px; border-radius: 5px; margin: 15px 0; display: none;">
          <h3 style="margin-top: 0; color: #1976D2;">ğŸ“ æ ¼å¼ä¿®æ”¹æ‘˜è¦</h3>
          <div id="changesContent"></div>
        </div>
        <div id="figureIssues" style="background: #fff3cd; border: 2px solid #ffc107; padding: 15px; border-radius: 5px; margin: 15px 0; display: none;">
          <h3 style="margin-top: 0; color: #856404;">âš ï¸ å›¾ç‰‡æ£€æµ‹ç»“æœ</h3>
          <div id="figureIssuesContent"></div>
        </div>
        <div id="referenceIssues" style="background: #ffe0e0; border: 2px solid #f44336; padding: 15px; border-radius: 5px; margin: 15px 0; display: none;">
          <h3 style="margin-top: 0; color: #c62828;">ğŸ“š å‚è€ƒæ–‡çŒ®å¼•ç”¨æ£€æµ‹ç»“æœ</h3>
          <div id="referenceIssuesContent"></div>
        </div>
        <div id="blankIssues" style="background: #fff3e0; border: 2px solid #ff9800; padding: 15px; border-radius: 5px; margin: 15px 0; display: none;">
          <h3 style="margin-top: 0; color: #e65100;">ğŸ“„ ç©ºç™½æ£€æµ‹ç»“æœ</h3>
          <div id="blankIssuesContent"></div>
        </div>
        <div class="links" id="previewLinks"></div>
        <hr class="divider" />
        
        <!-- æ”¯ä»˜ä¿¡æ¯æ˜¾ç¤º -->
        <div id="paymentInfo" style="background: #f5f5f5; padding: 20px; border-radius: 5px; margin: 20px 0; display: none;">
          <h3 style="margin-top: 0; color: #1976D2;">ğŸ’³ æ”¯ä»˜ä¿¡æ¯</h3>
          <div id="paymentInfoContent">
            <p><strong>æ”¯ä»˜é‡‘é¢ï¼š</strong><span id="paymentAmount" style="color: #f44336; font-size: 24px; font-weight: bold;">Â¥0.00</span></p>
            <p style="margin-top: 15px;"><strong>æ”¯ä»˜æ–¹å¼ï¼š</strong></p>
            <div id="paymentMethods" style="margin-top: 10px;"></div>
          </div>
        </div>
        
        <!-- æ”¯ä»˜æŒ‰é’® -->
        <button id="payButton" style="display: none; width: 100%; padding: 15px; font-size: 16px; background: #4CAF50; color: white; border: none; border-radius: 5px; cursor: pointer; margin-top: 10px;">
          ç«‹å³æ”¯ä»˜
        </button>
        
        <!-- å·²æ”¯ä»˜æç¤º -->
        <div id="paidNotice" style="background: #e8f5e9; border: 2px solid #4CAF50; padding: 15px; border-radius: 5px; margin: 20px 0; display: none;">
          <p style="margin: 0; color: #2e7d32; font-weight: bold;">âœ… å·²æ”¯ä»˜ï¼Œå¯ä»¥ä¸‹è½½æ­£å¼ç‰ˆæ–‡æ¡£</p>
        </div>
      </div>
      <div id="resultStatus" class="status" style="display: none"></div>
    </section>

    <!-- è”ç³»æ–¹å¼ -->
    <section style="text-align: center; padding: 20px; background: #f9fafb; border-radius: 12px; margin-top: 2rem;">
      <p style="margin: 0; color: #6b7280; font-size: 0.95rem;">
        å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·è”ç³»æˆ‘ä»¬ï¼š
        <a href="mailto:522168878@qq.com" style="color: #2563eb; text-decoration: none; font-weight: 600;">522168878@qq.com</a>
      </p>
    </section>

    <script>
      const templateForm = document.getElementById("templateForm");
      const documentForm = document.getElementById("documentForm");
      const templateStatus = document.getElementById("templateStatus");
      const documentStatus = document.getElementById("documentStatus");
      const resultStatus = document.getElementById("resultStatus");
      const templateSelect = document.getElementById("templateSelect");
      const resultCard = document.getElementById("result");
      const docIdSpan = document.getElementById("docId");
      const docStatusSpan = document.getElementById("docStatus");
      const docPaidSpan = document.getElementById("docPaid");
      const previewLinks = document.getElementById("previewLinks");
      const paymentInfo = document.getElementById("paymentInfo");
      const paymentAmount = document.getElementById("paymentAmount");
      const paymentMethods = document.getElementById("paymentMethods");
      const payButton = document.getElementById("payButton");
      const paidNotice = document.getElementById("paidNotice");
      
      // æ·»åŠ å…¨å±€æ”¯ä»˜æŒ‰é’®ç‚¹å‡»ç›‘å¬ï¼ˆç”¨äºè°ƒè¯•ï¼‰
      if (payButton) {
        payButton.addEventListener("click", function(e) {
          console.log("æ”¯ä»˜æŒ‰é’®è¢«ç‚¹å‡»ï¼ˆå…¨å±€ç›‘å¬ï¼‰", e);
        }, true); // ä½¿ç”¨æ•è·é˜¶æ®µ
      }
      const changesSummary = document.getElementById("changesSummary");
      const changesContent = document.getElementById("changesContent");
      const figureIssues = document.getElementById("figureIssues");
      const figureIssuesContent = document.getElementById("figureIssuesContent");

      let latestDocumentId = null;

      function showMessage(element, message, isError = false) {
        element.textContent = message;
        element.classList.toggle("error", isError);
        element.style.display = "block";
      }

      function addTemplateOption(templateId, label) {
        const option = document.createElement("option");
        option.value = templateId;
        option.textContent = `${label} (${templateId.slice(0, 8)})`;
        templateSelect.appendChild(option);
        templateSelect.value = templateId;
      }

      // åŠ è½½ç”¨æˆ·æ¨¡æ¿åˆ—è¡¨
      async function loadUserTemplates() {
        try {
          const response = await fetch("/templates");
          if (!response.ok) {
            console.error("åŠ è½½æ¨¡æ¿åˆ—è¡¨å¤±è´¥:", response.status);
            return;
          }
          
          const templates = await response.json();
          
          // æ¸…ç©ºç°æœ‰é€‰é¡¹ï¼ˆä¿ç•™ç¬¬ä¸€ä¸ªç©ºé€‰é¡¹ï¼‰
          templateSelect.innerHTML = '<option value="">è¯·å…ˆä¸Šä¼ æ¨¡æ¿</option>';
          
          if (templates.length === 0) {
            const option = document.createElement("option");
            option.value = "";
            option.textContent = "æš‚æ— æ¨¡æ¿ï¼Œè¯·å…ˆä¸Šä¼ ";
            templateSelect.appendChild(option);
            return;
          }
          
          // æ·»åŠ ç”¨æˆ·æ¨¡æ¿
          templates.forEach(template => {
            addTemplateOption(template.template_id, template.name);
          });
        } catch (error) {
          console.error("åŠ è½½æ¨¡æ¿åˆ—è¡¨é”™è¯¯:", error);
        }
      }

      // é¡µé¢åŠ è½½æ—¶è·å–ç”¨æˆ·æ¨¡æ¿åˆ—è¡¨
      loadUserTemplates();

      // æ–‡ä»¶å¤§å°é™åˆ¶ï¼š20 MBï¼ˆæ”¯æŒæ¯•ä¸šè®ºæ–‡ç­‰å¤§æ–‡ä»¶ï¼‰
      const MAX_FILE_SIZE = 20 * 1024 * 1024; // 20 MB

      templateForm.addEventListener("submit", async (event) => {
        event.preventDefault();
        const file = document.getElementById("templateFile").files[0];
        if (!file) {
          showMessage(templateStatus, "è¯·é€‰æ‹©æ¨¡æ¿æ–‡ä»¶", true);
          return;
        }

        // æ£€æŸ¥æ–‡ä»¶å¤§å°
        if (file.size > MAX_FILE_SIZE) {
          const fileSizeMB = (file.size / (1024 * 1024)).toFixed(2);
          showMessage(templateStatus, `æ–‡ä»¶å¤ªå¤§ï¼ˆ${fileSizeMB} MBï¼‰ï¼Œæœ€å¤§æ”¯æŒ 20 MBã€‚è¯·å‹ç¼©æ–‡æ¡£ä¸­çš„å›¾ç‰‡æˆ–åˆ é™¤ä¸å¿…è¦çš„å›¾ç‰‡åå†ä¸Šä¼ ã€‚`, true);
          return;
        }

        const formData = new FormData();
        formData.append("file", file);

        try {
          showMessage(templateStatus, "ä¸Šä¼ ä¸­...", false);
          const response = await fetch("/templates", {
            method: "POST",
            body: formData,
          });
          
          // æ£€æŸ¥å“åº”å†…å®¹ç±»å‹
          const contentType = response.headers.get("content-type");
          let errorMessage = "æ¨¡æ¿ä¸Šä¼ å¤±è´¥";
          
          if (!response.ok) {
            // å°è¯•è§£æ JSON é”™è¯¯
            if (contentType && contentType.includes("application/json")) {
              try {
                const detail = await response.json();
                errorMessage = detail.detail || detail.message || `ä¸Šä¼ å¤±è´¥ (${response.status})`;
              } catch (e) {
                // å¦‚æœä¸æ˜¯ JSONï¼Œè¯»å–æ–‡æœ¬
                const text = await response.text();
                errorMessage = text || `ä¸Šä¼ å¤±è´¥ (${response.status} ${response.statusText})`;
              }
            } else {
              // è¯»å–æ–‡æœ¬å“åº”
              const text = await response.text();
              errorMessage = text || `ä¸Šä¼ å¤±è´¥ (${response.status} ${response.statusText})`;
            }
            throw new Error(errorMessage);
          }
          
          // æˆåŠŸå“åº”ï¼Œè§£æ JSON
          if (contentType && contentType.includes("application/json")) {
            const data = await response.json();
            showMessage(templateStatus, `æ¨¡æ¿ä¸Šä¼ æˆåŠŸï¼š${data.name}ï¼ˆæ ·å¼æ•° ${data.style_count}ï¼‰`);
            // åˆ·æ–°æ¨¡æ¿åˆ—è¡¨
            await loadUserTemplates();
          } else {
            throw new Error("æœåŠ¡å™¨è¿”å›äº†æ„å¤–çš„å“åº”æ ¼å¼");
          }
        } catch (error) {
          console.error("ä¸Šä¼ é”™è¯¯:", error);
          showMessage(templateStatus, error.message || "æ¨¡æ¿ä¸Šä¼ å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•", true);
        }
      });

      documentForm.addEventListener("submit", async (event) => {
        event.preventDefault();
        const templateId = templateSelect.value;
        const file = document.getElementById("documentFile").files[0];

        if (!templateId) {
          showMessage(documentStatus, "è¯·å…ˆé€‰æ‹©æ¨¡æ¿", true);
          return;
        }
        if (!file) {
          showMessage(documentStatus, "è¯·é€‰æ‹©å­¦ç”Ÿæ–‡æ¡£", true);
          return;
        }

        // æ£€æŸ¥æ–‡ä»¶å¤§å°
        if (file.size > MAX_FILE_SIZE) {
          const fileSizeMB = (file.size / (1024 * 1024)).toFixed(2);
          showMessage(documentStatus, `æ–‡ä»¶å¤ªå¤§ï¼ˆ${fileSizeMB} MBï¼‰ï¼Œæœ€å¤§æ”¯æŒ 20 MBã€‚è¯·å‹ç¼©æ–‡æ¡£ä¸­çš„å›¾ç‰‡æˆ–åˆ é™¤ä¸å¿…è¦çš„å›¾ç‰‡åå†ä¸Šä¼ ã€‚`, true);
          return;
        }

        const formData = new FormData();
        formData.append("file", file);

        try {
          showMessage(documentStatus, "å¤„ç†ä¸­ï¼Œè¯·ç¨å€™...", false);
          const response = await fetch(`/documents?template_id=${templateId}`, {
            method: "POST",
            body: formData,
          });
          
          // æ£€æŸ¥å“åº”å†…å®¹ç±»å‹
          const contentType = response.headers.get("content-type");
          let errorMessage = "æ–‡æ¡£å¤„ç†å¤±è´¥";
          
          if (!response.ok) {
            // å°è¯•è§£æ JSON é”™è¯¯
            if (contentType && contentType.includes("application/json")) {
              try {
                const detail = await response.json();
                errorMessage = detail.detail || detail.message || `å¤„ç†å¤±è´¥ (${response.status})`;
              } catch (e) {
                // å¦‚æœä¸æ˜¯ JSONï¼Œè¯»å–æ–‡æœ¬
                const text = await response.text();
                errorMessage = text || `å¤„ç†å¤±è´¥ (${response.status} ${response.statusText})`;
              }
            } else {
              // è¯»å–æ–‡æœ¬å“åº”
              const text = await response.text();
              errorMessage = text || `å¤„ç†å¤±è´¥ (${response.status} ${response.statusText})`;
            }
            throw new Error(errorMessage);
          }
          
          // æˆåŠŸå“åº”ï¼Œè§£æ JSON
          if (contentType && contentType.includes("application/json")) {
            const data = await response.json();
            console.log("æ–‡æ¡£ä¸Šä¼ æˆåŠŸï¼ŒdocumentId:", data.document_id);
            latestDocumentId = data.document_id;
            showMessage(documentStatus, "æ–‡æ¡£å¤„ç†å®Œæˆ");
            await refreshDocumentStatus();
          } else {
            throw new Error("æœåŠ¡å™¨è¿”å›äº†æ„å¤–çš„å“åº”æ ¼å¼");
          }
        } catch (error) {
          console.error("æ–‡æ¡£å¤„ç†é”™è¯¯:", error);
          showMessage(documentStatus, error.message || "æ–‡æ¡£å¤„ç†å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•", true);
        }
      });

      async function refreshDocumentStatus() {
        // å¦‚æœ latestDocumentId ä¸ºç©ºï¼Œå°è¯•ä»é¡µé¢å…ƒç´ æ¢å¤
        if (!latestDocumentId) {
          const docIdText = docIdSpan ? docIdSpan.textContent : null;
          if (docIdText && docIdText.trim()) {
            latestDocumentId = docIdText.trim();
            console.log("ä»é¡µé¢å…ƒç´ æ¢å¤ documentId:", latestDocumentId);
          } else {
            console.warn("refreshDocumentStatus: latestDocumentId ä¸ºç©ºï¼Œæ— æ³•åˆ·æ–°çŠ¶æ€");
            return;
          }
        }
        
        console.log("åˆ·æ–°æ–‡æ¡£çŠ¶æ€ï¼ŒdocumentId:", latestDocumentId);
        try {
          const response = await fetch(`/documents/${latestDocumentId}`);
          if (!response.ok) {
            const detail = await response.json();
            throw new Error(detail.detail || "è·å–æ–‡æ¡£ä¿¡æ¯å¤±è´¥");
          }
          const data = await response.json();
          console.log("æ–‡æ¡£è¯¦æƒ…æ•°æ®:", data);
          
          docIdSpan.textContent = data.document_id;
          docStatusSpan.textContent = data.status;
          docPaidSpan.textContent = data.paid ? "æ˜¯" : "å¦";

          // æ˜¾ç¤ºä¿®æ”¹æ‘˜è¦
          if (data.summary && data.summary.changes_summary) {
            const fieldNames = {
              "font_name": "å­—ä½“",
              "font_size": "å­—å·",
              "bold": "åŠ ç²—",
              "alignment": "å¯¹é½æ–¹å¼",
              "line_spacing": "è¡Œè·",
              "space_before": "æ®µå‰é—´è·",
              "space_after": "æ®µåé—´è·",
              "first_line_indent": "é¦–è¡Œç¼©è¿›",
              "left_indent": "å·¦ç¼©è¿›",
              "right_indent": "å³ç¼©è¿›",
            };
            
            let html = "<ul style='list-style: none; padding-left: 0;'>";
            const sorted = Object.entries(data.summary.changes_summary)
              .sort((a, b) => b[1] - a[1]);
            for (const [field, count] of sorted) {
              const fieldName = fieldNames[field] || field;
              html += `<li style='padding: 5px 0;'><strong>${fieldName}</strong>: ä¿®æ”¹äº† <strong style='color: #1976D2;'>${count}</strong> å¤„</li>`;
            }
            html += `</ul><p style='margin-top: 10px; font-weight: bold; color: #1976D2;'>æ€»è®¡ä¿®æ”¹äº† <strong>${data.summary.paragraphs_adjusted || 0}</strong> ä¸ªæ®µè½</p>`;
            changesContent.innerHTML = html;
            changesSummary.style.display = "block";
          } else {
            changesSummary.style.display = "none";
          }

          // æ˜¾ç¤ºå›¾ç‰‡æ£€æµ‹ç»“æœ
          if (data.summary && data.summary.figure_issues && data.summary.figure_issues.length > 0) {
            const issues = data.summary.figure_issues;
            let html = `<p style="color: #856404; font-weight: bold;">å‘ç° <strong>${issues.length}</strong> å¤„å›¾ç‰‡ç¼ºå°‘å›¾é¢˜ï¼š</p><ul style="list-style: none; padding-left: 0;">`;
            for (const issue of issues.slice(0, 10)) {
              html += `<li style="padding: 8px 0; border-bottom: 1px solid #ffc107;"><strong>ç¬¬ ${issue.paragraph_index + 1} æ®µ</strong>: ${issue.message}<br><small style="color: #666;">${issue.suggestion}</small></li>`;
            }
            if (issues.length > 10) {
              html += `<li style="padding: 8px 0; color: #666;">... è¿˜æœ‰ ${issues.length - 10} å¤„é—®é¢˜æœªæ˜¾ç¤º</li>`;
            }
            html += '</ul>';
            figureIssuesContent.innerHTML = html;
            figureIssues.style.display = "block";
          } else {
            figureIssues.style.display = "none";
          }

          // æ˜¾ç¤ºå‚è€ƒæ–‡çŒ®å¼•ç”¨æ£€æµ‹ç»“æœ
          const referenceIssues = document.getElementById("referenceIssues");
          const referenceIssuesContent = document.getElementById("referenceIssuesContent");
          if (data.summary && data.summary.reference_issues && data.summary.reference_issues.length > 0) {
            const issues = data.summary.reference_issues;
            let html = "";
            for (const issue of issues) {
              if (issue.type === "no_reference_section") {
                html += `<p style="color: #c62828; font-weight: bold;">âš ï¸ ${issue.message}</p><p style="color: #666; margin-top: 5px;">${issue.suggestion}</p>`;
              } else if (issue.type === "no_reference_items") {
                html += `<p style="color: #c62828; font-weight: bold;">âš ï¸ ${issue.message}</p><p style="color: #666; margin-top: 5px;">${issue.suggestion}</p>`;
              } else if (issue.type === "uncited_references") {
                html += `<p style="color: #c62828; font-weight: bold;">âš ï¸ ${issue.message}</p>`;
                if (issue.uncited_count) {
                  html += `<p style="color: #666; margin-top: 5px;">å‘ç° <strong style="color: #c62828;">${issue.uncited_count}</strong> æ¡å‚è€ƒæ–‡çŒ®åœ¨æ­£æ–‡ä¸­æœªè¢«å¼•ç”¨ï¼Œå·²åœ¨æ–‡æ¡£ä¸­æ ‡è®°ä¸º<strong style="color: #c62828;">çº¢è‰²</strong>ã€‚</p>`;
                }
                html += `<p style="color: #666; margin-top: 5px;"><strong>å»ºè®®ï¼š</strong>${issue.suggestion}</p>`;
                if (issue.uncited_references && issue.uncited_references.length > 0) {
                  html += `<p style="color: #666; margin-top: 10px; font-weight: bold;">æœªè¢«å¼•ç”¨çš„å‚è€ƒæ–‡çŒ®ï¼š</p><ul style="list-style: none; padding-left: 0; margin-top: 5px;">`;
                  for (const ref of issue.uncited_references) {
                    html += `<li style="padding: 5px 0; border-bottom: 1px solid #f44336;"><strong style="color: #c62828;">[${ref.number}]</strong>: ${ref.text_preview}</li>`;
                  }
                  if (issue.uncited_count > issue.uncited_references.length) {
                    html += `<li style="padding: 5px 0; color: #666;">... è¿˜æœ‰ ${issue.uncited_count - issue.uncited_references.length} æ¡æœªè¢«å¼•ç”¨çš„å‚è€ƒæ–‡çŒ®</li>`;
                  }
                  html += '</ul>';
                }
              } else if (issue.type === "missing_citations") {
                html += `<p style="color: #c62828; font-weight: bold;">âš ï¸ ${issue.message}</p>`;
                if (issue.reference_count) {
                  html += `<p style="color: #666; margin-top: 5px;">å‘ç° <strong>${issue.reference_count}</strong> æ¡å‚è€ƒæ–‡çŒ®ï¼Œä½†æ­£æ–‡ä¸­æœªæ‰¾åˆ°å¼•ç”¨æ ‡æ³¨ã€‚</p>`;
                }
                html += `<p style="color: #666; margin-top: 5px;"><strong>å»ºè®®ï¼š</strong>${issue.suggestion}</p>`;
                if (issue.missing_citation_paragraphs && issue.missing_citation_paragraphs.length > 0) {
                  html += `<p style="color: #666; margin-top: 10px; font-weight: bold;">å¯èƒ½ç¼ºå°‘å¼•ç”¨çš„æ®µè½ï¼š</p><ul style="list-style: none; padding-left: 0; margin-top: 5px;">`;
                  for (const para of issue.missing_citation_paragraphs) {
                    html += `<li style="padding: 5px 0; border-bottom: 1px solid #f44336;"><strong>ç¬¬ ${para.paragraph_index + 1} æ®µ</strong>: ${para.text_preview}</li>`;
                  }
                  html += '</ul>';
                }
              }
            }
            referenceIssuesContent.innerHTML = html;
            referenceIssues.style.display = "block";
          } else {
            referenceIssues.style.display = "none";
          }

          // æ˜¾ç¤ºç©ºç™½æ£€æµ‹ç»“æœ
          const blankIssues = document.getElementById("blankIssues");
          const blankIssuesContent = document.getElementById("blankIssuesContent");
          if (data.summary && data.summary.blank_issues && data.summary.blank_issues.length > 0) {
            const issues = data.summary.blank_issues;
            let html = "";
            for (const issue of issues) {
              if (issue.type === "excessive_blanks_in_chapter") {
                html += `<p style="color: #e65100; font-weight: bold; margin-top: 10px;">âš ï¸ ${issue.message}</p>`;
                html += `<p style="color: #666; margin-top: 5px;"><strong>å»ºè®®ï¼š</strong>${issue.suggestion}</p>`;
                if (issue.paragraph_indices && issue.paragraph_indices.length > 0) {
                  html += `<p style="color: #666; margin-top: 5px;">æ¶‰åŠæ®µè½ï¼šç¬¬ ${issue.paragraph_indices[0] + 1} æ®µåˆ°ç¬¬ ${issue.paragraph_indices[issue.paragraph_indices.length - 1] + 1} æ®µï¼ˆå…± ${issue.blank_count} ä¸ªç©ºç™½æ®µè½ï¼‰</p>`;
                }
              }
            }
            blankIssuesContent.innerHTML = html;
            blankIssues.style.display = "block";
          } else {
            blankIssues.style.display = "none";
          }

          previewLinks.innerHTML = "";
          
          // é¢„è§ˆæŒ‰é’®ï¼ˆä»…æŸ¥çœ‹ï¼Œä¸å¯ä¸‹è½½ï¼‰
          const previewBtn = document.createElement("button");
          previewBtn.textContent = "é¢„è§ˆæ–‡æ¡£ï¼ˆä»…æŸ¥çœ‹ï¼Œä¸å¯ä¸‹è½½ï¼‰";
          previewBtn.className = "preview-btn";
          previewBtn.onclick = () => {
            window.open(`/documents/${data.document_id}/preview`, '_blank', 'width=1200,height=800');
          };
          previewLinks.appendChild(previewBtn);

          // å¤„ç†å·²æ”¯ä»˜çŠ¶æ€
          if (data.paid) {
            // éšè—æ‰€æœ‰æ”¯ä»˜ç›¸å…³å…ƒç´ 
            paymentInfo.style.display = "none";
            payButton.style.display = "none";
            paidNotice.style.display = "block";
            
            // ä» localStorage è·å–ä¸‹è½½ token
            const downloadToken = localStorage.getItem(`download_token_${data.document_id}`);
            
            if (downloadToken) {
              // æ˜¾ç¤ºä¸‹è½½é“¾æ¥ï¼ˆå¸¦ token éªŒè¯ï¼‰
              const finalLink = document.createElement("a");
              finalLink.href = `/documents/${data.document_id}/download?token=${encodeURIComponent(downloadToken)}`;
              finalLink.textContent = "ä¸‹è½½æ­£å¼ç‰ˆï¼ˆå·²ä»˜è´¹ï¼‰";
              finalLink.target = "_blank";
              finalLink.className = "download-btn";
              finalLink.style.marginLeft = "10px";
              previewLinks.appendChild(finalLink);
            } else {
              // å¦‚æœæ²¡æœ‰ tokenï¼Œæç¤ºç”¨æˆ·é‡æ–°æ”¯ä»˜æˆ–åˆ·æ–°é¡µé¢
              const noTokenMsg = document.createElement("p");
              noTokenMsg.textContent = "âš ï¸ ä¸‹è½½ token æœªæ‰¾åˆ°ï¼Œè¯·åˆ·æ–°é¡µé¢æˆ–é‡æ–°æ”¯ä»˜";
              noTokenMsg.style.color = "#f44336";
              noTokenMsg.style.marginLeft = "10px";
              previewLinks.appendChild(noTokenMsg);
            }
          } else {
            // æœªæ”¯ä»˜ï¼Œç¡®ä¿æ”¯ä»˜ä¿¡æ¯æ˜¾ç¤º
            paidNotice.style.display = "none";
          }

          resultCard.style.display = "block";
          resultStatus.style.display = "none";
          
          // åŠ è½½æ”¯ä»˜ä¿¡æ¯
          console.log("å‡†å¤‡åŠ è½½æ”¯ä»˜ä¿¡æ¯ï¼ŒdocumentId:", data.document_id, "paid:", data.paid);
          try {
            await loadPaymentInfo(data.document_id, data.paid);
            console.log("æ”¯ä»˜ä¿¡æ¯åŠ è½½å®Œæˆï¼Œå‡½æ•°å·²è¿”å›");
          } catch (paymentError) {
            console.error("åŠ è½½æ”¯ä»˜ä¿¡æ¯æ—¶å‡ºé”™:", paymentError);
            // å³ä½¿å‡ºé”™ï¼Œä¹Ÿæ˜¾ç¤ºé»˜è®¤æ”¯ä»˜ä¿¡æ¯
            console.log("ä½¿ç”¨é»˜è®¤æ”¯ä»˜ä¿¡æ¯");
            showDefaultPaymentInfo(data.document_id);
          }
          
          // ç¡®ä¿æ”¯ä»˜ä¿¡æ¯åŒºåŸŸå¯è§ï¼ˆåŒé‡ä¿é™©ï¼‰
          setTimeout(() => {
            if (paymentInfo.style.display === "none" && !data.paid) {
              console.warn("æ”¯ä»˜ä¿¡æ¯åŒºåŸŸè¢«éšè—ï¼Œå¼ºåˆ¶æ˜¾ç¤º");
              showDefaultPaymentInfo(data.document_id);
            }
          }, 500);
        } catch (error) {
          console.error("åˆ·æ–°æ–‡æ¡£çŠ¶æ€æ—¶å‡ºé”™:", error);
          showMessage(resultStatus, error.message, true);
        }
      }

      // åŠ è½½æ”¯ä»˜ä¿¡æ¯
      async function loadPaymentInfo(documentId, isPaid) {
        if (!documentId) {
          console.error("loadPaymentInfo: documentId ä¸ºç©º");
          return;
        }

        if (isPaid) {
          // å·²æ”¯ä»˜ï¼Œæ˜¾ç¤ºæç¤º
          paymentInfo.style.display = "none";
          payButton.style.display = "none";
          paidNotice.style.display = "block";
          return;
        }

        try {
          console.log("æ­£åœ¨åŠ è½½æ”¯ä»˜ä¿¡æ¯ï¼ŒdocumentId:", documentId);
          const response = await fetch(`/payments/info/${documentId}`);
          console.log("æ”¯ä»˜ä¿¡æ¯ API å“åº”çŠ¶æ€:", response.status);
          
          if (!response.ok) {
            const errorText = await response.text();
            console.error("è·å–æ”¯ä»˜ä¿¡æ¯å¤±è´¥:", response.status, errorText);
            // å³ä½¿å¤±è´¥ï¼Œä¹Ÿæ˜¾ç¤ºé»˜è®¤æ”¯ä»˜ä¿¡æ¯
            showDefaultPaymentInfo(documentId);
            return;
          }
          
          const paymentData = await response.json();
          console.log("æ”¯ä»˜ä¿¡æ¯æ•°æ®:", paymentData);
          console.log("å¯ç”¨æ”¯ä»˜æ–¹å¼:", paymentData.payment_methods);
          
          // æ˜¾ç¤ºæ”¯ä»˜é‡‘é¢
          paymentAmount.textContent = `Â¥${paymentData.amount.toFixed(2)}`;
          
          // æ˜¾ç¤ºæ”¯ä»˜æ–¹å¼
          paymentMethods.innerHTML = "";
          let selectedMethod = paymentData.payment_methods[0] || "mock";
          
          // ç¡®ä¿æ”¯ä»˜æ–¹å¼åˆ—è¡¨ä¸ä¸ºç©º
          if (!paymentData.payment_methods || paymentData.payment_methods.length === 0) {
            console.warn("æ”¯ä»˜æ–¹å¼åˆ—è¡¨ä¸ºç©ºï¼Œä½¿ç”¨é»˜è®¤å€¼");
            paymentData.payment_methods = ["mock"];
          }
          
          console.log("å¼€å§‹æ¸²æŸ“æ”¯ä»˜æ–¹å¼ï¼Œæ•°é‡:", paymentData.payment_methods.length);
          paymentData.payment_methods.forEach(method => {
            console.log("æ¸²æŸ“æ”¯ä»˜æ–¹å¼:", method);
            const methodDiv = document.createElement("div");
            methodDiv.style.marginBottom = "10px";
            
            const label = document.createElement("label");
            label.style.display = "flex";
            label.style.alignItems = "center";
            label.style.cursor = "pointer";
            label.style.padding = "10px";
            label.style.border = "2px solid #ddd";
            label.style.borderRadius = "5px";
            label.style.backgroundColor = "#fff";
            label.style.transition = "all 0.3s";
            
            const radio = document.createElement("input");
            radio.type = "radio";
            radio.id = `paymentMethod_${method}`;
            radio.name = "paymentMethod";
            radio.value = method;
            radio.style.marginRight = "10px";
            
            if (method === selectedMethod) {
              radio.checked = true;
              label.style.borderColor = "#4CAF50";
              label.style.backgroundColor = "#f1f8f4";
            }
            
             const methodName = {
               "mock": "æ¨¡æ‹Ÿæ”¯ä»˜ï¼ˆæµ‹è¯•ï¼‰",
               "payjs": "PayJS æ”¯ä»˜ï¼ˆæ”¯ä»˜å®/å¾®ä¿¡ï¼‰",
               "alipay": "æ”¯ä»˜å®",
               "wechat": "å¾®ä¿¡æ”¯ä»˜",
               "stripe": "Stripeï¼ˆå›½é™…æ”¯ä»˜ï¼‰"
             }[method] || method;
            
            label.appendChild(radio);
            label.appendChild(document.createTextNode(methodName));
            
            // ç‚¹å‡»æ—¶æ›´æ–°é€‰ä¸­çŠ¶æ€
            label.addEventListener("click", (e) => {
              // æ›´æ–°æ‰€æœ‰å•é€‰æŒ‰é’®
              document.querySelectorAll('input[name="paymentMethod"]').forEach(r => {
                r.checked = false;
                r.closest('label').style.borderColor = "#ddd";
                r.closest('label').style.backgroundColor = "#fff";
              });
              
              radio.checked = true;
              selectedMethod = method;
              label.style.borderColor = "#4CAF50";
              label.style.backgroundColor = "#f1f8f4";
            });
            
            methodDiv.appendChild(label);
            paymentMethods.appendChild(methodDiv);
          });
          
          // æ˜¾ç¤ºæ”¯ä»˜ç•Œé¢
          console.log("å‡†å¤‡æ˜¾ç¤ºæ”¯ä»˜ç•Œé¢");
          paymentInfo.style.display = "block";
          payButton.style.display = "block";
          paidNotice.style.display = "none";
          console.log("æ”¯ä»˜ç•Œé¢å·²æ˜¾ç¤ºï¼ŒpayButtonå­˜åœ¨:", !!payButton);
          
          // æ›´æ–°æ”¯ä»˜æŒ‰é’®äº‹ä»¶
          console.log("è®¾ç½®æ”¯ä»˜æŒ‰é’®äº‹ä»¶ï¼ŒdocumentId:", documentId, "selectedMethod:", selectedMethod, "payButton:", payButton);
          payButton.onclick = function(e) {
            e.preventDefault();
            e.stopPropagation();
            console.log("æ”¯ä»˜æŒ‰é’®onclickäº‹ä»¶è§¦å‘");
            
            // ç¡®ä¿ documentId å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™ä»é¡µé¢å…ƒç´ è·å–
            let currentDocumentId = documentId;
            if (!currentDocumentId) {
              const docIdText = docIdSpan ? docIdSpan.textContent : null;
              if (docIdText && docIdText.trim()) {
                currentDocumentId = docIdText.trim();
                console.log("ä»é¡µé¢å…ƒç´ è·å– documentId:", currentDocumentId);
              } else {
                console.error("æ— æ³•è·å– documentIdï¼Œæ”¯ä»˜æŒ‰é’®ç‚¹å‡»å¤±è´¥");
                showMessage(resultStatus, "æ— æ³•è·å–æ–‡æ¡£IDï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•", true);
                return;
              }
            }
            
            const selected = document.querySelector('input[name="paymentMethod"]:checked');
            const methodValue = selected ? selected.value : selectedMethod;
            console.log("æ”¯ä»˜æŒ‰é’®ç‚¹å‡»ï¼Œé€‰ä¸­çš„æ”¯ä»˜æ–¹å¼:", methodValue, "selected:", selected, "selectedMethod:", selectedMethod);
            console.log("æ‰€æœ‰æ”¯ä»˜æ–¹å¼radio:", document.querySelectorAll('input[name="paymentMethod"]'));
            console.log("ä½¿ç”¨çš„ documentId:", currentDocumentId);
            handlePayment(currentDocumentId, methodValue);
          };
          console.log("æ”¯ä»˜æŒ‰é’®äº‹ä»¶è®¾ç½®å®Œæˆ");
        } catch (error) {
          console.error("åŠ è½½æ”¯ä»˜ä¿¡æ¯å¤±è´¥:", error);
          console.error("é”™è¯¯è¯¦æƒ…:", error.stack);
          // å³ä½¿å‡ºé”™ï¼Œä¹Ÿæ˜¾ç¤ºé»˜è®¤æ”¯ä»˜ä¿¡æ¯
          showDefaultPaymentInfo(documentId);
        }
      }

      // æ˜¾ç¤ºé»˜è®¤æ”¯ä»˜ä¿¡æ¯ï¼ˆå½“ API å¤±è´¥æ—¶ä½¿ç”¨ï¼‰
      function showDefaultPaymentInfo(documentId) {
        console.log("æ˜¾ç¤ºé»˜è®¤æ”¯ä»˜ä¿¡æ¯");
        // æ˜¾ç¤ºé»˜è®¤ä»·æ ¼
        paymentAmount.textContent = "Â¥9.90";
        
        // æ˜¾ç¤ºé»˜è®¤æ”¯ä»˜æ–¹å¼ï¼ˆæ¨¡æ‹Ÿæ”¯ä»˜ï¼‰
        paymentMethods.innerHTML = "";
        const methodDiv = document.createElement("div");
        methodDiv.style.marginBottom = "10px";
        
        const label = document.createElement("label");
        label.style.display = "flex";
        label.style.alignItems = "center";
        label.style.cursor = "pointer";
        label.style.padding = "10px";
        label.style.border = "2px solid #4CAF50";
        label.style.borderRadius = "5px";
        label.style.backgroundColor = "#f1f8f4";
        
        const radio = document.createElement("input");
        radio.type = "radio";
        radio.id = "paymentMethod_mock_default";
        radio.name = "paymentMethod";
        radio.value = "mock";
        radio.checked = true;
        radio.style.marginRight = "10px";
        
        label.appendChild(radio);
        label.appendChild(document.createTextNode("æ¨¡æ‹Ÿæ”¯ä»˜ï¼ˆæµ‹è¯•ï¼‰"));
        methodDiv.appendChild(label);
        paymentMethods.appendChild(methodDiv);
        
        // æ˜¾ç¤ºæ”¯ä»˜ç•Œé¢
        paymentInfo.style.display = "block";
        payButton.style.display = "block";
        paidNotice.style.display = "none";
        
        // æ›´æ–°æ”¯ä»˜æŒ‰é’®äº‹ä»¶
        console.log("è®¾ç½®é»˜è®¤æ”¯ä»˜æŒ‰é’®äº‹ä»¶ï¼ˆmockæ”¯ä»˜ï¼‰");
        payButton.onclick = function(e) {
          e.preventDefault();
          e.stopPropagation();
          console.log("é»˜è®¤æ”¯ä»˜æŒ‰é’®onclickäº‹ä»¶è§¦å‘ï¼ˆmockæ”¯ä»˜ï¼‰");
          
          // ç¡®ä¿ documentId å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™ä»é¡µé¢å…ƒç´ è·å–
          let currentDocumentId = documentId;
          if (!currentDocumentId) {
            const docIdText = docIdSpan ? docIdSpan.textContent : null;
            if (docIdText && docIdText.trim()) {
              currentDocumentId = docIdText.trim();
              console.log("ä»é¡µé¢å…ƒç´ è·å– documentId:", currentDocumentId);
            } else {
              console.error("æ— æ³•è·å– documentIdï¼Œæ”¯ä»˜æŒ‰é’®ç‚¹å‡»å¤±è´¥");
              showMessage(resultStatus, "æ— æ³•è·å–æ–‡æ¡£IDï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•", true);
              return;
            }
          }
          
          console.log("ä½¿ç”¨çš„ documentId:", currentDocumentId);
          handlePayment(currentDocumentId, "mock");
        };
      }

      // å¤„ç†æ”¯ä»˜
      async function handlePayment(documentId, paymentMethod) {
        // å¦‚æœ documentId ä¸ºç©ºï¼Œå°è¯•ä»é¡µé¢å…ƒç´ è·å–
        if (!documentId) {
          const docIdText = docIdSpan ? docIdSpan.textContent : null;
          if (docIdText && docIdText.trim()) {
            documentId = docIdText.trim();
            console.log("handlePayment: ä»é¡µé¢å…ƒç´ è·å– documentId:", documentId);
          } else {
            console.error("handlePayment: documentId ä¸ºç©ºï¼Œæ— æ³•å¤„ç†æ”¯ä»˜");
            showMessage(resultStatus, "æ— æ³•è·å–æ–‡æ¡£IDï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•", true);
            return;
          }
        }
        
        if (!paymentMethod) {
          showMessage(resultStatus, "è¯·é€‰æ‹©æ”¯ä»˜æ–¹å¼", true);
          return;
        }

        // ç»Ÿä¸€è½¬æ¢ä¸ºå°å†™ï¼Œç¡®ä¿å¤§å°å†™ä¸æ•æ„Ÿ
        if (paymentMethod && typeof paymentMethod === 'string') {
          paymentMethod = paymentMethod.toLowerCase().trim();
        }
        console.log("handlePayment: documentId:", documentId, "paymentMethod:", paymentMethod, "ç±»å‹:", typeof paymentMethod);

        try {
          showMessage(resultStatus, "å¤„ç†æ”¯ä»˜ä¸­...", false);
          
          if (paymentMethod === "mock") {
            // æ¨¡æ‹Ÿæ”¯ä»˜
            const response = await fetch("/payments/mock", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ 
                document_id: documentId,
                payment_method: paymentMethod
              }),
            });
            
            if (!response.ok) {
              const detail = await response.json();
              throw new Error(detail.detail || "æ”¯ä»˜å¤±è´¥");
            }
            
            const paymentResult = await response.json();
            
            // ä¿å­˜ä¸‹è½½ token åˆ° localStorageï¼Œç”¨äºåç»­ä¸‹è½½éªŒè¯
            if (paymentResult.download_token) {
              localStorage.setItem(`download_token_${documentId}`, paymentResult.download_token);
              console.log("å·²ä¿å­˜ä¸‹è½½ token:", paymentResult.download_token);
            }
            
            showMessage(resultStatus, "æ”¯ä»˜æˆåŠŸï¼Œæ­£å¼ç‰ˆå·²è§£é”ï¼", false);
            await refreshDocumentStatus();
          } else if (paymentMethod === "payjs") {
            // PayJS æ”¯ä»˜
            const response = await fetch("/payments/payjs/create", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ 
                document_id: documentId,
                payment_method: "payjs"
              }),
            });
            
            if (!response.ok) {
              const detail = await response.json();
              throw new Error(detail.detail || "åˆ›å»ºæ”¯ä»˜è®¢å•å¤±è´¥");
            }
            
            const paymentData = await response.json();
            
            // è·³è½¬åˆ° PayJS æ”¶é“¶å°
            if (paymentData.payment_url) {
              // æ‰“å¼€æ–°çª—å£è¿›è¡Œæ”¯ä»˜
              const payWindow = window.open(paymentData.payment_url, '_blank', 'width=800,height=600');
              
              // è½®è¯¢æ£€æŸ¥æ”¯ä»˜çŠ¶æ€
              const checkInterval = setInterval(async () => {
                try {
                  const statusResponse = await fetch(`/documents/${documentId}/status`);
                  const statusData = await statusResponse.json();
                  
                  if (statusData.paid) {
                    clearInterval(checkInterval);
                    payWindow?.close();
                    showMessage(resultStatus, "æ”¯ä»˜æˆåŠŸï¼Œæ­£å¼ç‰ˆå·²è§£é”ï¼", false);
                    await refreshDocumentStatus();
                  }
                } catch (error) {
                  console.error("æ£€æŸ¥æ”¯ä»˜çŠ¶æ€å¤±è´¥:", error);
                }
              }, 3000); // æ¯3ç§’æ£€æŸ¥ä¸€æ¬¡
              
              // 30åˆ†é’Ÿååœæ­¢æ£€æŸ¥
              setTimeout(() => {
                clearInterval(checkInterval);
              }, 30 * 60 * 1000);
              
              showMessage(resultStatus, "æ­£åœ¨è·³è½¬åˆ°æ”¯ä»˜é¡µé¢...", false);
            } else {
              throw new Error("æœªè·å–åˆ°æ”¯ä»˜é“¾æ¥");
            }
          } else if (paymentMethod === "wechat") {
            // å¾®ä¿¡æ”¯ä»˜ï¼ˆH5æ”¯ä»˜æˆ–æ‰«ç æ”¯ä»˜ï¼‰
            const response = await fetch("/payments/wechat/create", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ 
                document_id: documentId,
                payment_method: "wechat"
              }),
            });
            
            if (!response.ok) {
              const detail = await response.json();
              throw new Error(detail.detail || "åˆ›å»ºæ”¯ä»˜è®¢å•å¤±è´¥");
            }
            
            const paymentData = await response.json();
            
            if (paymentData.payment_url) {
              if (paymentData.payment_type === "native") {
                // Nativeæ”¯ä»˜ï¼ˆæ‰«ç æ”¯ä»˜ï¼‰- æ˜¾ç¤ºäºŒç»´ç 
                showMessage(resultStatus, "è¯·ä½¿ç”¨å¾®ä¿¡æ‰«ç æ”¯ä»˜", false);
                
                // åˆ›å»ºäºŒç»´ç æ˜¾ç¤ºåŒºåŸŸ
                const qrCodeDiv = document.createElement("div");
                qrCodeDiv.style.cssText = "text-align: center; padding: 20px; background: #fff; border-radius: 5px; margin: 20px 0;";
                qrCodeDiv.innerHTML = `
                  <p style="margin-bottom: 15px; font-weight: bold; color: #1976D2;">è¯·ä½¿ç”¨å¾®ä¿¡æ‰«ç æ”¯ä»˜</p>
                  <img src="https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${encodeURIComponent(paymentData.payment_url)}" 
                       alt="å¾®ä¿¡æ”¯ä»˜äºŒç»´ç " 
                       style="max-width: 300px; border: 2px solid #ddd; padding: 10px; background: #fff;">
                  <p style="margin-top: 15px; color: #666; font-size: 14px;">æ”¯ä»˜å®Œæˆåï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨æ›´æ–°è®¢å•çŠ¶æ€</p>
                `;
                
                // å°†äºŒç»´ç æ’å…¥åˆ°æ”¯ä»˜ä¿¡æ¯åŒºåŸŸ
                const paymentInfo = document.getElementById("paymentInfo");
                if (paymentInfo) {
                  paymentInfo.appendChild(qrCodeDiv);
                }
                
                // è½®è¯¢æ£€æŸ¥æ”¯ä»˜çŠ¶æ€
                const checkInterval = setInterval(async () => {
                  try {
                    const statusResponse = await fetch(`/documents/${documentId}/status`);
                    const statusData = await statusResponse.json();
                    
                    if (statusData.paid) {
                      clearInterval(checkInterval);
                      qrCodeDiv.remove();
                      showMessage(resultStatus, "æ”¯ä»˜æˆåŠŸï¼Œæ­£å¼ç‰ˆå·²è§£é”ï¼", false);
                      await refreshDocumentStatus();
                    }
                  } catch (error) {
                    console.error("æ£€æŸ¥æ”¯ä»˜çŠ¶æ€å¤±è´¥:", error);
                  }
                }, 3000); // æ¯3ç§’æ£€æŸ¥ä¸€æ¬¡
                
                // 30åˆ†é’Ÿååœæ­¢æ£€æŸ¥
                setTimeout(() => {
                  clearInterval(checkInterval);
                }, 30 * 60 * 1000);
              } else {
                // H5æ”¯ä»˜ - ç›´æ¥è·³è½¬
                window.location.href = paymentData.payment_url;
              }
            } else {
              throw new Error("æœªè·å–åˆ°æ”¯ä»˜é“¾æ¥");
            }
          } else if (paymentMethod === "alipay" || paymentMethod === "æ”¯ä»˜å®" || (paymentMethod && paymentMethod.includes && paymentMethod.includes("alipay"))) {
            // æ”¯ä»˜å®æ”¯ä»˜ï¼ˆæ‰‹æœºç½‘ç«™æ”¯ä»˜ï¼‰
            console.log("å¼€å§‹åˆ›å»ºæ”¯ä»˜å®æ”¯ä»˜è®¢å•...", "paymentMethod:", paymentMethod);
            const response = await fetch("/payments/alipay/create", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ 
                document_id: documentId,
                payment_method: "alipay"
              }),
            });
            
            if (!response.ok) {
              const detail = await response.json();
              throw new Error(detail.detail || "åˆ›å»ºæ”¯ä»˜è®¢å•å¤±è´¥");
            }
            
            const paymentData = await response.json();
            
            if (paymentData.payment_url) {
              // æ”¯ä»˜å®æ”¯ä»˜ - ç›´æ¥è·³è½¬åˆ°æ”¯ä»˜é¡µé¢
              showMessage(resultStatus, "æ­£åœ¨è·³è½¬åˆ°æ”¯ä»˜å®æ”¯ä»˜é¡µé¢...", false);
              window.location.href = paymentData.payment_url;
            } else {
              throw new Error("æœªè·å–åˆ°æ”¯ä»˜é“¾æ¥");
            }
          } else {
            // å…¶ä»–æ”¯ä»˜æ–¹å¼ï¼ˆå¾…å®ç°ï¼‰
            console.error("æœªåŒ¹é…çš„æ”¯ä»˜æ–¹å¼:", paymentMethod, "ç±»å‹:", typeof paymentMethod);
            console.error("æ‰€æœ‰æ”¯ä»˜æ–¹å¼æ£€æŸ¥:", {
              "mock": paymentMethod === "mock",
              "payjs": paymentMethod === "payjs",
              "wechat": paymentMethod === "wechat",
              "alipay": paymentMethod === "alipay",
              "æ”¯ä»˜å®": paymentMethod === "æ”¯ä»˜å®",
              "includes alipay": paymentMethod.includes && paymentMethod.includes("alipay")
            });
            showMessage(resultStatus, `${paymentMethod} æ”¯ä»˜åŠŸèƒ½å¼€å‘ä¸­...`, true);
          }
        } catch (error) {
          console.error("æ”¯ä»˜é”™è¯¯:", error);
          showMessage(resultStatus, error.message || "æ”¯ä»˜å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•", true);
        }
      }

    </script>
  </body>
</html>



