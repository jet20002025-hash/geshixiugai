<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <title>è®ºæ–‡æ ¼å¼è‡ªåŠ¨ä¿®å¤ - æœ¬åœ°é¢„è§ˆ</title>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        margin: 2rem auto;
        max-width: 760px;
        line-height: 1.6;
      }
      h1,
      h2 {
        color: #16324f;
      }
      section {
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 6px 20px rgba(15, 23, 42, 0.04);
      }
      label {
        display: block;
        font-weight: 600;
        margin-bottom: 0.5rem;
      }
      input[type="file"],
      select,
      button {
        width: 100%;
        padding: 0.6rem;
        margin-bottom: 1rem;
        border-radius: 8px;
        border: 1px solid #d1d5db;
        font-size: 1rem;
      }
      button {
        background: linear-gradient(135deg, #2563eb, #1e3a8a);
        color: white;
        cursor: pointer;
        transition: transform 0.15s ease, box-shadow 0.15s ease;
        border: none;
      }
      button:hover {
        transform: translateY(-1px);
        box-shadow: 0 12px 24px rgba(37, 99, 235, 0.2);
      }
      .card-title {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 1rem;
      }
      .status {
        padding: 0.75rem;
        border-radius: 8px;
        background: #ecfdf5;
        border: 1px solid #10b98133;
        color: #047857;
        font-size: 0.95rem;
      }
      .status.error {
        background: #fef2f2;
        border-color: #dc262633;
        color: #b91c1c;
      }
      .list {
        background: #f9fafb;
        border-radius: 8px;
        padding: 1rem;
        border: 1px solid #e5e7eb;
      }
      .list ul {
        margin: 0;
        padding-left: 1.2rem;
      }
      .divider {
        height: 1px;
        margin: 1.5rem 0;
        background: linear-gradient(90deg, rgba(229, 231, 235, 0), rgba(209, 213, 219, 0.9), rgba(229, 231, 235, 0));
        border: none;
      }
      .small {
        font-size: 0.9rem;
        color: #6b7280;
      }
      .links a {
        display: inline-block;
        margin-right: 1rem;
        color: #2563eb;
        text-decoration: none;
      }
    </style>
  </head>
  <body>
    <h1>è®ºæ–‡æ ¼å¼è‡ªåŠ¨ä¿®å¤ï¼ˆæœ¬åœ°é¢„è§ˆç‰ˆï¼‰</h1>
    <p class="small">æµç¨‹ï¼šä¸Šä¼ æ¨¡æ¿ â†’ ä¸Šä¼ å­¦ç”Ÿæ–‡æ¡£ â†’ é¢„è§ˆæ°´å°ç‰ˆ â†’ æ¨¡æ‹Ÿæ”¯ä»˜åä¸‹è½½æ­£å¼ç‰ˆã€‚</p>

    <section>
      <div class="card-title">
        <h2>1. ä¸Šä¼ æ¨¡æ¿</h2>
      </div>
      <form id="templateForm">
        <label for="templateFile">é€‰æ‹©æ¨¡æ¿ï¼ˆ.docxï¼‰</label>
        <input id="templateFile" type="file" accept=".docx" required />
        <button type="submit">ä¸Šä¼ æ¨¡æ¿</button>
      </form>
      <div id="templateStatus" class="status" style="display: none"></div>
    </section>

    <section>
      <div class="card-title">
        <h2>2. ä¸Šä¼ å­¦ç”Ÿæ–‡æ¡£</h2>
      </div>
      <form id="documentForm">
        <label for="templateSelect">é€‰æ‹©æ¨¡æ¿</label>
        <select id="templateSelect" required>
          <option value="">è¯·å…ˆä¸Šä¼ æ¨¡æ¿</option>
        </select>
        <label for="documentFile">é€‰æ‹©å­¦ç”Ÿæ–‡æ¡£ï¼ˆ.docxï¼‰</label>
        <input id="documentFile" type="file" accept=".docx" required />
        <button type="submit">ä¸Šä¼ å¹¶è‡ªåŠ¨ä¿®å¤</button>
      </form>
      <div id="documentStatus" class="status" style="display: none"></div>
    </section>

    <section>
      <div class="card-title">
        <h2>3. ä¸‹è½½ä¸æ”¯ä»˜</h2>
      </div>
      <div id="result" class="list" style="display: none">
        <p><strong>æ–‡æ¡£ IDï¼š</strong><span id="docId"></span></p>
        <p><strong>å¤„ç†çŠ¶æ€ï¼š</strong><span id="docStatus"></span></p>
        <p><strong>å·²ä»˜è´¹ï¼š</strong><span id="docPaid"></span></p>
        <div id="changesSummary" style="background: #e7f3ff; padding: 15px; border-radius: 5px; margin: 15px 0; display: none;">
          <h3 style="margin-top: 0; color: #1976D2;">ğŸ“ æ ¼å¼ä¿®æ”¹æ‘˜è¦</h3>
          <div id="changesContent"></div>
        </div>
        <div id="figureIssues" style="background: #fff3cd; border: 2px solid #ffc107; padding: 15px; border-radius: 5px; margin: 15px 0; display: none;">
          <h3 style="margin-top: 0; color: #856404;">âš ï¸ å›¾ç‰‡æ£€æµ‹ç»“æœ</h3>
          <div id="figureIssuesContent"></div>
        </div>
        <div id="referenceIssues" style="background: #ffe0e0; border: 2px solid #f44336; padding: 15px; border-radius: 5px; margin: 15px 0; display: none;">
          <h3 style="margin-top: 0; color: #c62828;">ğŸ“š å‚è€ƒæ–‡çŒ®å¼•ç”¨æ£€æµ‹ç»“æœ</h3>
          <div id="referenceIssuesContent"></div>
        </div>
        <div class="links" id="previewLinks"></div>
        <hr class="divider" />
        <button id="mockPay">æ¨¡æ‹Ÿæ”¯ä»˜åè§£é”æ­£å¼ç‰ˆ</button>
      </div>
      <div id="resultStatus" class="status" style="display: none"></div>
    </section>

    <script>
      const templateForm = document.getElementById("templateForm");
      const documentForm = document.getElementById("documentForm");
      const templateStatus = document.getElementById("templateStatus");
      const documentStatus = document.getElementById("documentStatus");
      const resultStatus = document.getElementById("resultStatus");
      const templateSelect = document.getElementById("templateSelect");
      const resultCard = document.getElementById("result");
      const docIdSpan = document.getElementById("docId");
      const docStatusSpan = document.getElementById("docStatus");
      const docPaidSpan = document.getElementById("docPaid");
      const previewLinks = document.getElementById("previewLinks");
      const mockPayBtn = document.getElementById("mockPay");
      const changesSummary = document.getElementById("changesSummary");
      const changesContent = document.getElementById("changesContent");
      const figureIssues = document.getElementById("figureIssues");
      const figureIssuesContent = document.getElementById("figureIssuesContent");

      let latestDocumentId = null;

      function showMessage(element, message, isError = false) {
        element.textContent = message;
        element.classList.toggle("error", isError);
        element.style.display = "block";
      }

      function addTemplateOption(templateId, label) {
        const option = document.createElement("option");
        option.value = templateId;
        option.textContent = `${label} (${templateId.slice(0, 8)})`;
        templateSelect.appendChild(option);
        templateSelect.value = templateId;
      }

      templateForm.addEventListener("submit", async (event) => {
        event.preventDefault();
        const file = document.getElementById("templateFile").files[0];
        if (!file) {
          showMessage(templateStatus, "è¯·é€‰æ‹©æ¨¡æ¿æ–‡ä»¶", true);
          return;
        }

        const formData = new FormData();
        formData.append("file", file);

        try {
          showMessage(templateStatus, "ä¸Šä¼ ä¸­...", false);
          const response = await fetch("/templates", {
            method: "POST",
            body: formData,
          });
          
          // æ£€æŸ¥å“åº”å†…å®¹ç±»å‹
          const contentType = response.headers.get("content-type");
          let errorMessage = "æ¨¡æ¿ä¸Šä¼ å¤±è´¥";
          
          if (!response.ok) {
            // å°è¯•è§£æ JSON é”™è¯¯
            if (contentType && contentType.includes("application/json")) {
              try {
                const detail = await response.json();
                errorMessage = detail.detail || detail.message || `ä¸Šä¼ å¤±è´¥ (${response.status})`;
              } catch (e) {
                // å¦‚æœä¸æ˜¯ JSONï¼Œè¯»å–æ–‡æœ¬
                const text = await response.text();
                errorMessage = text || `ä¸Šä¼ å¤±è´¥ (${response.status} ${response.statusText})`;
              }
            } else {
              // è¯»å–æ–‡æœ¬å“åº”
              const text = await response.text();
              errorMessage = text || `ä¸Šä¼ å¤±è´¥ (${response.status} ${response.statusText})`;
            }
            throw new Error(errorMessage);
          }
          
          // æˆåŠŸå“åº”ï¼Œè§£æ JSON
          if (contentType && contentType.includes("application/json")) {
            const data = await response.json();
            addTemplateOption(data.template_id, data.name);
            showMessage(templateStatus, `æ¨¡æ¿ä¸Šä¼ æˆåŠŸï¼š${data.name}ï¼ˆæ ·å¼æ•° ${data.style_count}ï¼‰`);
          } else {
            throw new Error("æœåŠ¡å™¨è¿”å›äº†æ„å¤–çš„å“åº”æ ¼å¼");
          }
        } catch (error) {
          console.error("ä¸Šä¼ é”™è¯¯:", error);
          showMessage(templateStatus, error.message || "æ¨¡æ¿ä¸Šä¼ å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•", true);
        }
      });

      documentForm.addEventListener("submit", async (event) => {
        event.preventDefault();
        const templateId = templateSelect.value;
        const file = document.getElementById("documentFile").files[0];

        if (!templateId) {
          showMessage(documentStatus, "è¯·å…ˆé€‰æ‹©æ¨¡æ¿", true);
          return;
        }
        if (!file) {
          showMessage(documentStatus, "è¯·é€‰æ‹©å­¦ç”Ÿæ–‡æ¡£", true);
          return;
        }

        const formData = new FormData();
        formData.append("file", file);

        try {
          showMessage(documentStatus, "å¤„ç†ä¸­ï¼Œè¯·ç¨å€™...", false);
          const response = await fetch(`/documents?template_id=${templateId}`, {
            method: "POST",
            body: formData,
          });
          
          // æ£€æŸ¥å“åº”å†…å®¹ç±»å‹
          const contentType = response.headers.get("content-type");
          let errorMessage = "æ–‡æ¡£å¤„ç†å¤±è´¥";
          
          if (!response.ok) {
            // å°è¯•è§£æ JSON é”™è¯¯
            if (contentType && contentType.includes("application/json")) {
              try {
                const detail = await response.json();
                errorMessage = detail.detail || detail.message || `å¤„ç†å¤±è´¥ (${response.status})`;
              } catch (e) {
                // å¦‚æœä¸æ˜¯ JSONï¼Œè¯»å–æ–‡æœ¬
                const text = await response.text();
                errorMessage = text || `å¤„ç†å¤±è´¥ (${response.status} ${response.statusText})`;
              }
            } else {
              // è¯»å–æ–‡æœ¬å“åº”
              const text = await response.text();
              errorMessage = text || `å¤„ç†å¤±è´¥ (${response.status} ${response.statusText})`;
            }
            throw new Error(errorMessage);
          }
          
          // æˆåŠŸå“åº”ï¼Œè§£æ JSON
          if (contentType && contentType.includes("application/json")) {
            const data = await response.json();
            latestDocumentId = data.document_id;
            showMessage(documentStatus, "æ–‡æ¡£å¤„ç†å®Œæˆ");
            await refreshDocumentStatus();
          } else {
            throw new Error("æœåŠ¡å™¨è¿”å›äº†æ„å¤–çš„å“åº”æ ¼å¼");
          }
        } catch (error) {
          console.error("æ–‡æ¡£å¤„ç†é”™è¯¯:", error);
          showMessage(documentStatus, error.message || "æ–‡æ¡£å¤„ç†å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•", true);
        }
      });

      async function refreshDocumentStatus() {
        if (!latestDocumentId) return;
        try {
          const response = await fetch(`/documents/${latestDocumentId}`);
          if (!response.ok) {
            const detail = await response.json();
            throw new Error(detail.detail || "è·å–æ–‡æ¡£ä¿¡æ¯å¤±è´¥");
          }
          const data = await response.json();
          docIdSpan.textContent = data.document_id;
          docStatusSpan.textContent = data.status;
          docPaidSpan.textContent = data.paid ? "æ˜¯" : "å¦";

          // æ˜¾ç¤ºä¿®æ”¹æ‘˜è¦
          if (data.summary && data.summary.changes_summary) {
            const fieldNames = {
              "font_name": "å­—ä½“",
              "font_size": "å­—å·",
              "bold": "åŠ ç²—",
              "alignment": "å¯¹é½æ–¹å¼",
              "line_spacing": "è¡Œè·",
              "space_before": "æ®µå‰é—´è·",
              "space_after": "æ®µåé—´è·",
              "first_line_indent": "é¦–è¡Œç¼©è¿›",
              "left_indent": "å·¦ç¼©è¿›",
              "right_indent": "å³ç¼©è¿›",
            };
            
            let html = "<ul style='list-style: none; padding-left: 0;'>";
            const sorted = Object.entries(data.summary.changes_summary)
              .sort((a, b) => b[1] - a[1]);
            for (const [field, count] of sorted) {
              const fieldName = fieldNames[field] || field;
              html += `<li style='padding: 5px 0;'><strong>${fieldName}</strong>: ä¿®æ”¹äº† <strong style='color: #1976D2;'>${count}</strong> å¤„</li>`;
            }
            html += `</ul><p style='margin-top: 10px; font-weight: bold; color: #1976D2;'>æ€»è®¡ä¿®æ”¹äº† <strong>${data.summary.paragraphs_adjusted || 0}</strong> ä¸ªæ®µè½</p>`;
            changesContent.innerHTML = html;
            changesSummary.style.display = "block";
          } else {
            changesSummary.style.display = "none";
          }

          // æ˜¾ç¤ºå›¾ç‰‡æ£€æµ‹ç»“æœ
          if (data.summary && data.summary.figure_issues && data.summary.figure_issues.length > 0) {
            const issues = data.summary.figure_issues;
            let html = `<p style="color: #856404; font-weight: bold;">å‘ç° <strong>${issues.length}</strong> å¤„å›¾ç‰‡ç¼ºå°‘å›¾é¢˜ï¼š</p><ul style="list-style: none; padding-left: 0;">`;
            for (const issue of issues.slice(0, 10)) {
              html += `<li style="padding: 8px 0; border-bottom: 1px solid #ffc107;"><strong>ç¬¬ ${issue.paragraph_index + 1} æ®µ</strong>: ${issue.message}<br><small style="color: #666;">${issue.suggestion}</small></li>`;
            }
            if (issues.length > 10) {
              html += `<li style="padding: 8px 0; color: #666;">... è¿˜æœ‰ ${issues.length - 10} å¤„é—®é¢˜æœªæ˜¾ç¤º</li>`;
            }
            html += '</ul>';
            figureIssuesContent.innerHTML = html;
            figureIssues.style.display = "block";
          } else {
            figureIssues.style.display = "none";
          }

          // æ˜¾ç¤ºå‚è€ƒæ–‡çŒ®å¼•ç”¨æ£€æµ‹ç»“æœ
          const referenceIssues = document.getElementById("referenceIssues");
          const referenceIssuesContent = document.getElementById("referenceIssuesContent");
          if (data.summary && data.summary.reference_issues && data.summary.reference_issues.length > 0) {
            const issues = data.summary.reference_issues;
            let html = "";
            for (const issue of issues) {
              if (issue.type === "no_reference_section") {
                html += `<p style="color: #c62828; font-weight: bold;">âš ï¸ ${issue.message}</p><p style="color: #666; margin-top: 5px;">${issue.suggestion}</p>`;
              } else if (issue.type === "no_reference_items") {
                html += `<p style="color: #c62828; font-weight: bold;">âš ï¸ ${issue.message}</p><p style="color: #666; margin-top: 5px;">${issue.suggestion}</p>`;
              } else if (issue.type === "missing_citations") {
                html += `<p style="color: #c62828; font-weight: bold;">âš ï¸ ${issue.message}</p>`;
                if (issue.reference_count) {
                  html += `<p style="color: #666; margin-top: 5px;">å‘ç° <strong>${issue.reference_count}</strong> æ¡å‚è€ƒæ–‡çŒ®ï¼Œä½†æ­£æ–‡ä¸­æœªæ‰¾åˆ°å¼•ç”¨æ ‡æ³¨ã€‚</p>`;
                }
                html += `<p style="color: #666; margin-top: 5px;"><strong>å»ºè®®ï¼š</strong>${issue.suggestion}</p>`;
                if (issue.missing_citation_paragraphs && issue.missing_citation_paragraphs.length > 0) {
                  html += `<p style="color: #666; margin-top: 10px; font-weight: bold;">å¯èƒ½ç¼ºå°‘å¼•ç”¨çš„æ®µè½ï¼š</p><ul style="list-style: none; padding-left: 0; margin-top: 5px;">`;
                  for (const para of issue.missing_citation_paragraphs) {
                    html += `<li style="padding: 5px 0; border-bottom: 1px solid #f44336;"><strong>ç¬¬ ${para.paragraph_index + 1} æ®µ</strong>: ${para.text_preview}</li>`;
                  }
                  html += '</ul>';
                }
              }
            }
            referenceIssuesContent.innerHTML = html;
            referenceIssues.style.display = "block";
          } else {
            referenceIssues.style.display = "none";
          }

          previewLinks.innerHTML = "";
          
          // é¢„è§ˆæŒ‰é’®ï¼ˆä»…æŸ¥çœ‹ï¼Œä¸å¯ä¸‹è½½ï¼‰
          const previewBtn = document.createElement("button");
          previewBtn.textContent = "é¢„è§ˆæ–‡æ¡£ï¼ˆä»…æŸ¥çœ‹ï¼Œä¸å¯ä¸‹è½½ï¼‰";
          previewBtn.className = "preview-btn";
          previewBtn.onclick = () => {
            window.open(`/documents/${data.document_id}/preview`, '_blank', 'width=1200,height=800');
          };
          previewLinks.appendChild(previewBtn);
          
          // æ·»åŠ é¢„è§ˆåŒºåŸŸ
          const previewContainer = document.createElement("div");
          previewContainer.id = "previewContainer";
          previewContainer.style.display = "none";
          previewContainer.style.marginTop = "20px";
          previewContainer.style.border = "1px solid #ddd";
          previewContainer.style.height = "800px";
          previewContainer.style.overflow = "auto";
          previewContainer.innerHTML = `<iframe src="/documents/${data.document_id}/preview" style="width:100%;height:100%;border:none;"></iframe>`;
          
          const inlinePreviewBtn = document.createElement("button");
          inlinePreviewBtn.textContent = "åœ¨é¡µé¢ä¸­é¢„è§ˆ";
          inlinePreviewBtn.style.marginLeft = "10px";
          inlinePreviewBtn.onclick = () => {
            previewContainer.style.display = previewContainer.style.display === "none" ? "block" : "none";
          };
          previewLinks.appendChild(inlinePreviewBtn);
          previewLinks.appendChild(previewContainer);

          if (data.paid) {
            const finalLink = document.createElement("a");
            finalLink.href = `/documents/${data.document_id}/download`;
            finalLink.textContent = "ä¸‹è½½æ­£å¼ç‰ˆï¼ˆå·²ä»˜è´¹ï¼‰";
            finalLink.target = "_blank";
            finalLink.className = "download-btn";
            finalLink.style.marginLeft = "10px";
            previewLinks.appendChild(finalLink);
          }

          resultCard.style.display = "block";
          resultStatus.style.display = "none";
        } catch (error) {
          showMessage(resultStatus, error.message, true);
        }
      }

      mockPayBtn.addEventListener("click", async () => {
        if (!latestDocumentId) return;
        try {
          const response = await fetch("/payments/mock", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ document_id: latestDocumentId }),
          });
          if (!response.ok) {
            const detail = await response.json();
            throw new Error(detail.detail || "æ”¯ä»˜å¤±è´¥");
          }
          showMessage(resultStatus, "æ¨¡æ‹Ÿæ”¯ä»˜æˆåŠŸï¼Œæ­£å¼ç‰ˆå·²è§£é”");
          await refreshDocumentStatus();
        } catch (error) {
          showMessage(resultStatus, error.message, true);
        }
      });
    </script>
  </body>
</html>



