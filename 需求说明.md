# 论文格式自动修复平台 MVP 需求说明

## 背景
毕业论文 Word 文档常见格式混乱：标题字号不统一、正文行距不一致、图表缺少图题、页眉页脚混乱等。目标是通过网站服务，学生上传论文后系统自动依据模板统一格式，降低人工排版成本。

## 整体目标
- 学生上传官方模板，系统自动解析并生成格式规则库。
- 学生上传个人论文，系统依据规则库自动修复格式。
- 修复完成后提供带水印预览版，付费后可下载正式版。
- 支持高峰期批量处理、低峰期低成本运行。

## 用户角色
- **学生用户**：上传模板、上传论文、查看预览、支付并下载正式版。
- **平台管理员**（后续扩展）：维护模板规则、查看任务状态、配置系统资源。

## 核心流程
1. **模板上传**
   - 上传 `.docx` 模板。
   - 解析段落/样式信息，生成结构化规则库（字体、字号、行距、缩进、对齐、图表/参考文献等）。
   - 返回 `templateId`，允许多套模板共存（按学院/专业划分）。

2. **文档上传与修复**
   - 学生选择模板 ID 上传待修论文（优先 `.docx`，如 `.doc` 先自动转换）。
   - 系统将段落分类、比对规则库并自动修复：统一标题样式、正文格式、列表缩进、图表题、页眉页脚等。
   - 记录修复动作（原格式→目标格式），生成修复报告。

3. **预览与付费**
   - 修复后生成正式版 `docx`，同时生成水印预览版（可转为 PDF/带水印 docx）。
   - 前端展示处理结果概览，提供水印版下载/在线预览。
   - 支付下单（Alipay/微信支付，可先用模拟回调），支付成功后允许下载正式版。
   - 下载链接设置有效期/次数限制。

4. **文件管理**
   - 目录组织：`{templateId}/{taskId}/` 存储模板、原稿、修复版、水印版、报告。
   - 设置生命周期策略，处理完成后定期清理或归档。

## 接口规划（FastAPI 示例）
- `POST /templates`：上传模板 → 返回 `templateId`
- `GET /templates/{id}`：查看模板解析结果（调试/展示用）
- `POST /documents`：上传论文，参数包含 `templateId`
- `GET /documents/{docId}`：查询处理状态、修复概览
- `GET /documents/{docId}/preview`：获取水印版
- `POST /payments`：创建支付订单
- `POST /payments/callback`：处理支付回调
- `GET /documents/{docId}/download`：支付后下载正式版
- （可选）`GET /documents/{docId}/report`：查看详细修复记录

## 规则库结构要点
- 分类别存储段落、列表、图表、表格、参考文献、页眉页脚、封面等格式。
- 每条规则包含字体、字号、行距、缩进、对齐、段前段后、样式名/匹配条件。
- 支持容差或多选项（例如字号允许范围，多种字体兼容）。
- 版本化管理，便于模板升级或不同学院模板切换。

## 水印策略
- 水印覆盖所有页面（背景或叠放），文字示例“仅供预览，禁止外用”。
- 保持透明度与倾斜角度防止截取。
- 生成 PDF 预览更安全；如保留 docx 预览需保证水印难以删除。

## 架构与技术选型
- **后端**：Python 3.10+、FastAPI、Uvicorn。
- **文档处理**：`python-docx`（段落/样式）、`docxcompose` 或自定义逻辑；必要时使用 LibreOffice/Textutil 转换 `.doc`。
- **水印/PDF**：`reportlab`、`pikepdf`、`pdfkit` 等。
- **前端**：React/Vue 简单页面（上传、状态显示、预览、支付）。
- **存储**：初期本地文件 + SQLite；可升级至 OSS + RDS。
- **支付**：优先对接支付宝/微信支付接口，支持订单管理。

## 运维与成本控制
- 平时保持低配实例（如 1 核 2G），旺季（1、3、5 月）前手动/半自动扩容至高配（2-4 核 8G+）。
- 弹性策略：使用弹性伸缩或 Serverless（函数计算）处理批量任务。
- 对象存储按量计费，设置生命周期规则自动清理旧文件。
- 监控处理队列、CPU、内存，设置告警；备份数据库与重要文件。

## 安全与隐私
- 文件上传限制类型/大小，必要时病毒扫描。
- 所有下载接口校验身份与订单状态。
- 明确隐私协议，提供“立即删除文件”选项。
- HTTPS 全站加密，支付回调需可靠验证。

## 后续扩展方向
- 多模板管理、模板可视化编辑。
- 用户登录与历史记录、批量处理。
- 语法/错别字检测、人工校对增值服务。
- 接入学校平台或小程序。

---

*版本：MVP 需求草案（2025-11-12）*

