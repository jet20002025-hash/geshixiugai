# 支付宝支付配置说明

## 一、配置信息说明

⚠️ **重要**：以下信息为示例，请替换为你的真实配置信息！

- **应用ID（AppID）**：`你的应用ID`（例如：2021001234567890）
- **应用私钥（Private Key）**：你的应用私钥（完整内容，包括BEGIN/END标记或纯base64字符串）
- **支付宝公钥（Public Key）**：支付宝公钥（完整内容）

## 二、在 Vercel 中配置环境变量

### 2.1 访问 Vercel 项目设置

1. 登录 Vercel Dashboard：https://vercel.com/dashboard
2. 选择你的项目：`geshixiugai`（或你的项目名）
3. 进入 **Settings** → **Environment Variables**

### 2.2 添加环境变量

添加以下环境变量：

#### 必需配置

```
ALIPAY_APP_ID=你的应用ID
ALIPAY_PRIVATE_KEY=你的应用私钥（完整内容）
ALIPAY_PUBLIC_KEY=支付宝公钥（完整内容）
```

⚠️ **注意**：
- `ALIPAY_PRIVATE_KEY` 可以是带 BEGIN/END 标记的完整私钥，也可以是纯 base64 字符串（系统会自动格式化）
- `ALIPAY_PUBLIC_KEY` 必须是完整的支付宝公钥

#### 可选配置

```
ALIPAY_GATEWAY=https://openapi.alipay.com/gateway.do
ALIPAY_SIGN_TYPE=RSA2
```

**说明**：
- `ALIPAY_GATEWAY`：默认是正式环境，如需测试可使用沙箱环境 `https://openapi.alipaydev.com/gateway.do`
- `ALIPAY_SIGN_TYPE`：默认是 RSA2，一般不需要修改

#### 其他配置

```
PAYMENT_PRICE=0.99
BASE_URL=https://geshixiugai.org
```

### 2.3 配置步骤

1. 在 Vercel Dashboard 中，点击 **Add New**
2. 输入变量名：`ALIPAY_APP_ID`
3. 输入变量值：`你的应用ID`（例如：2021001234567890）
4. 选择环境：**Production, Preview, Development**（全选）
5. 点击 **Save**
6. 重复上述步骤，添加 `ALIPAY_PRIVATE_KEY` 和 `ALIPAY_PUBLIC_KEY`

**重要提示**：
- 私钥和公钥内容较长，复制时请确保完整复制，不要遗漏任何字符
- 如果私钥是纯 base64 字符串（没有 BEGIN/END 标记），直接粘贴即可，系统会自动格式化
- 如果私钥已经包含 BEGIN/END 标记，请完整复制包括标记在内的所有内容

### 2.4 重新部署

配置完成后，需要重新部署项目：

1. 在 Vercel Dashboard 中，进入 **Deployments**
2. 点击最新的部署记录右侧的 **...** 菜单
3. 选择 **Redeploy**
4. 等待部署完成（约 1-2 分钟）

---

## 三、支付方式说明

### 3.1 手机网站支付（H5支付）

**适用场景**：
- 手机浏览器访问
- PC浏览器访问（会跳转到手机版支付页面）

**特点**：
- ✅ 用户使用支付宝APP或网页支付
- ✅ 支付完成后自动跳转回网站
- ✅ 适合所有设备

**用户体验**：
1. 用户点击"立即支付"
2. 跳转到支付宝支付页面
3. 用户完成支付
4. 自动跳转回网站，显示支付成功

---

## 四、测试支付

### 4.1 测试步骤

1. 访问网站：https://geshixiugai.org
2. 上传模板和文档
3. 在支付页面选择"支付宝支付"
4. 点击"立即支付"
5. 跳转到支付宝支付页面
6. 使用支付宝测试账号完成支付（或使用真实支付）

### 4.2 支付回调

支付成功后，支付宝会调用以下回调地址：
```
https://geshixiugai.org/payments/alipay/notify
```

系统会自动：
1. 验证支付签名
2. 检查支付状态
3. 标记文档为已支付
4. 返回 "success" 给支付宝

---

## 五、常见问题

### 5.1 支付订单创建失败

**可能原因**：
- 环境变量未正确配置
- 私钥格式不正确
- AppID 与私钥不匹配

**解决方法**：
1. 检查 Vercel 环境变量是否正确配置
2. 确认私钥和公钥完整复制
3. 确认 AppID 正确

### 5.2 支付回调验证失败

**可能原因**：
- 支付宝公钥不正确
- 回调地址配置错误

**解决方法**：
1. 检查支付宝开放平台中的应用网关配置
2. 确认回调地址为：`https://geshixiugai.org/payments/alipay/notify`
3. 确认支付宝公钥正确配置

### 5.3 支付成功后未解锁文档

**可能原因**：
- 回调处理失败
- 文档ID不匹配

**解决方法**：
1. 检查 Vercel 日志，查看回调处理情况
2. 确认文档ID正确
3. 手动检查文档状态

---

## 六、安全提示

⚠️ **重要**：
- 不要将私钥和公钥提交到 GitHub
- 只通过 Vercel 环境变量配置敏感信息
- 定期检查环境变量是否正确配置
- 如果私钥泄露，立即在支付宝开放平台重新生成密钥对

