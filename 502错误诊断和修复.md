# 502 Bad Gateway 错误诊断和修复指南

## 问题原因
502错误通常表示Nginx无法连接到后端服务（Gunicorn），可能的原因：
1. 后端服务没有运行
2. 后端服务崩溃
3. 代码错误导致服务无法启动
4. 端口被占用或配置错误

## 快速诊断步骤

### 1. 检查服务状态
```bash
sudo systemctl status geshixiugai.service
```

### 2. 查看错误日志
```bash
sudo tail -n 50 /var/log/geshixiugai/error.log
```

### 3. 检查代码是否有语法错误
```bash
cd /var/www/geshixiugai
python3 -c "from backend.app.main import app; print('✅ 代码导入成功')"
```

### 4. 检查Gunicorn进程
```bash
ps aux | grep gunicorn | grep -v grep
```

### 5. 检查端口监听
```bash
sudo netstat -tlnp | grep 8000
# 或
sudo ss -tlnp | grep 8000
```

## 快速修复

### 方法1：重启服务
```bash
sudo systemctl restart geshixiugai
sleep 5
sudo systemctl status geshixiugai.service
```

### 方法2：如果服务无法启动，检查代码
```bash
cd /var/www/geshixiugai
python3 -m py_compile backend/app/api/documents.py
python3 -m py_compile backend/app/services/document_service.py
```

### 方法3：查看详细错误信息
```bash
sudo journalctl -u geshixiugai.service -n 50 --no-pager
```

### 方法4：手动启动Gunicorn测试
```bash
cd /var/www/geshixiugai
source venv/bin/activate
gunicorn -c gunicorn_config.py backend.app.main:app
```

## 常见问题

### 问题1：代码导入错误
**症状**：日志显示 `ModuleNotFoundError` 或 `ImportError`
**解决**：检查代码语法，确保所有导入正确

### 问题2：端口被占用
**症状**：`Address already in use`
**解决**：
```bash
sudo lsof -i :8000
sudo kill -9 <PID>
sudo systemctl restart geshixiugai
```

### 问题3：权限问题
**症状**：`Permission denied`
**解决**：
```bash
sudo chown -R www-data:www-data /var/www/geshixiugai
sudo chmod -R 755 /var/www/geshixiugai
```

## 如果以上方法都不行

1. 检查Nginx配置：
```bash
sudo nginx -t
sudo systemctl status nginx
```

2. 检查防火墙：
```bash
sudo ufw status
```

3. 查看完整日志：
```bash
sudo tail -f /var/log/geshixiugai/error.log
```

